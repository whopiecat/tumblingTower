{"ast":null,"code":"import { EngineStore } from './engineStore';\nimport { Effect } from '../Materials/effect';\nimport { _DevTools } from '../Misc/devTools';\nimport { Observable } from '../Misc/observable';\nimport { DepthCullingState } from '../States/depthCullingState';\nimport { StencilState } from '../States/stencilState';\nimport { AlphaState } from '../States/alphaCullingState';\nimport { InternalTexture, InternalTextureSource } from '../Materials/Textures/internalTexture';\nimport { Logger } from '../Misc/logger';\nimport { DomManagement } from '../Misc/domManagement';\nimport { WebGLShaderProcessor } from './WebGL/webGLShaderProcessors';\nimport { WebGL2ShaderProcessor } from './WebGL/webGL2ShaderProcessors';\nimport { WebGLDataBuffer } from '../Meshes/WebGL/webGLDataBuffer';\nimport { WebGLPipelineContext } from './WebGL/webGLPipelineContext';\nimport { CanvasGenerator } from '../Misc/canvasGenerator';\nimport { PerformanceConfigurator } from './performanceConfigurator';\n/**\r\n * Keeps track of all the buffer info used in engine.\r\n */\n\nvar BufferPointer =\n/** @class */\nfunction () {\n  function BufferPointer() {}\n\n  return BufferPointer;\n}();\n/**\r\n * The base engine class (root of all engines)\r\n */\n\n\nvar ThinEngine =\n/** @class */\nfunction () {\n  /**\r\n   * Creates a new engine\r\n   * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which alreay used the WebGL context\r\n   * @param antialias defines enable antialiasing (default: false)\r\n   * @param options defines further options to be sent to the getContext() function\r\n   * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\r\n   */\n  function ThinEngine(canvasOrContext, antialias, options, adaptToDeviceRatio) {\n    var _this = this;\n\n    if (adaptToDeviceRatio === void 0) {\n      adaptToDeviceRatio = false;\n    }\n    /**\r\n     * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\r\n     */\n\n\n    this.forcePOTTextures = false;\n    /**\r\n     * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\r\n     */\n\n    this.isFullscreen = false;\n    /**\r\n     * Gets or sets a boolean indicating if back faces must be culled (true by default)\r\n     */\n\n    this.cullBackFaces = true;\n    /**\r\n     * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foregroun\r\n     */\n\n    this.renderEvenInBackground = true;\n    /**\r\n     * Gets or sets a boolean indicating that cache can be kept between frames\r\n     */\n\n    this.preventCacheWipeBetweenFrames = false;\n    /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\n\n    this.validateShaderPrograms = false;\n    /**\r\n     * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\r\n     * This can provide greater z depth for distant objects.\r\n     */\n\n    this.useReverseDepthBuffer = false; // Uniform buffers list\n\n    /**\r\n     * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\r\n     */\n\n    this.disableUniformBuffers = false;\n    /** @hidden */\n\n    this._uniformBuffers = new Array();\n    /** @hidden */\n\n    this._webGLVersion = 1.0;\n    this._windowIsBackground = false;\n    this._highPrecisionShadersAllowed = true;\n    /** @hidden */\n\n    this._badOS = false;\n    /** @hidden */\n\n    this._badDesktopOS = false;\n    this._renderingQueueLaunched = false;\n    this._activeRenderLoops = new Array(); // Lost context\n\n    /**\r\n     * Observable signaled when a context lost event is raised\r\n     */\n\n    this.onContextLostObservable = new Observable();\n    /**\r\n     * Observable signaled when a context restored event is raised\r\n     */\n\n    this.onContextRestoredObservable = new Observable();\n    this._contextWasLost = false;\n    /** @hidden */\n\n    this._doNotHandleContextLost = false;\n    /**\r\n     * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\r\n     */\n\n    this.disableVertexArrayObjects = false; // States\n\n    /** @hidden */\n\n    this._colorWrite = true;\n    /** @hidden */\n\n    this._colorWriteChanged = true;\n    /** @hidden */\n\n    this._depthCullingState = new DepthCullingState();\n    /** @hidden */\n\n    this._stencilState = new StencilState();\n    /** @hidden */\n\n    this._alphaState = new AlphaState();\n    /** @hidden */\n\n    this._alphaMode = 1;\n    /** @hidden */\n\n    this._alphaEquation = 0; // Cache\n\n    /** @hidden */\n\n    this._internalTexturesCache = new Array();\n    /** @hidden */\n\n    this._activeChannel = 0;\n    this._currentTextureChannel = -1;\n    /** @hidden */\n\n    this._boundTexturesCache = {};\n    this._compiledEffects = {};\n    this._vertexAttribArraysEnabled = [];\n    this._uintIndicesCurrentlySet = false;\n    this._currentBoundBuffer = new Array();\n    /** @hidden */\n\n    this._currentFramebuffer = null;\n    /** @hidden */\n\n    this._dummyFramebuffer = null;\n    this._currentBufferPointers = new Array();\n    this._currentInstanceLocations = new Array();\n    this._currentInstanceBuffers = new Array();\n    this._vaoRecordInProgress = false;\n    this._mustWipeVertexAttributes = false;\n    this._nextFreeTextureSlots = new Array();\n    this._maxSimultaneousTextures = 0;\n    this._activeRequests = new Array();\n    /** @hidden */\n\n    this._transformTextureUrl = null;\n    /**\r\n     * Gets information about the current host\r\n     */\n\n    this.hostInformation = {\n      isMobile: false\n    };\n    /**\r\n     * Defines whether the engine has been created with the premultipliedAlpha option on or not.\r\n     */\n\n    this.premultipliedAlpha = true;\n    /**\r\n     * Observable event triggered before each texture is initialized\r\n     */\n\n    this.onBeforeTextureInitObservable = new Observable();\n    this._viewportCached = {\n      x: 0,\n      y: 0,\n      z: 0,\n      w: 0\n    };\n    this._unpackFlipYCached = null;\n    /**\r\n     * In case you are sharing the context with other applications, it might\r\n     * be interested to not cache the unpack flip y state to ensure a consistent\r\n     * value would be set.\r\n     */\n\n    this.enableUnpackFlipYCached = true;\n\n    this._getDepthStencilBuffer = function (width, height, samples, internalFormat, msInternalFormat, attachment) {\n      var gl = _this._gl;\n      var depthStencilBuffer = gl.createRenderbuffer();\n      gl.bindRenderbuffer(gl.RENDERBUFFER, depthStencilBuffer);\n\n      if (samples > 1 && gl.renderbufferStorageMultisample) {\n        gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\n      } else {\n        gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\n      }\n\n      gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, depthStencilBuffer);\n      gl.bindRenderbuffer(gl.RENDERBUFFER, null);\n      return depthStencilBuffer;\n    };\n\n    this._boundUniforms = {};\n    var canvas = null;\n\n    if (!canvasOrContext) {\n      return;\n    }\n\n    options = options || {};\n    PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\n\n    if (canvasOrContext.getContext) {\n      canvas = canvasOrContext;\n      this._renderingCanvas = canvas;\n\n      if (antialias != null) {\n        options.antialias = antialias;\n      }\n\n      if (options.deterministicLockstep === undefined) {\n        options.deterministicLockstep = false;\n      }\n\n      if (options.lockstepMaxSteps === undefined) {\n        options.lockstepMaxSteps = 4;\n      }\n\n      if (options.timeStep === undefined) {\n        options.timeStep = 1 / 60;\n      }\n\n      if (options.preserveDrawingBuffer === undefined) {\n        options.preserveDrawingBuffer = false;\n      }\n\n      if (options.audioEngine === undefined) {\n        options.audioEngine = true;\n      }\n\n      if (options.stencil === undefined) {\n        options.stencil = true;\n      }\n\n      if (options.premultipliedAlpha === false) {\n        this.premultipliedAlpha = false;\n      }\n\n      if (options.xrCompatible === undefined) {\n        options.xrCompatible = true;\n      }\n\n      this._doNotHandleContextLost = options.doNotHandleContextLost ? true : false; // Exceptions\n\n      if (navigator && navigator.userAgent) {\n        var ua = navigator.userAgent;\n        this.hostInformation.isMobile = ua.indexOf(\"Mobile\") !== -1;\n\n        for (var _i = 0, _a = ThinEngine.ExceptionList; _i < _a.length; _i++) {\n          var exception = _a[_i];\n          var key = exception.key;\n          var targets = exception.targets;\n          var check = new RegExp(key);\n\n          if (check.test(ua)) {\n            if (exception.capture && exception.captureConstraint) {\n              var capture = exception.capture;\n              var constraint = exception.captureConstraint;\n              var regex = new RegExp(capture);\n              var matches = regex.exec(ua);\n\n              if (matches && matches.length > 0) {\n                var capturedValue = parseInt(matches[matches.length - 1]);\n\n                if (capturedValue >= constraint) {\n                  continue;\n                }\n              }\n            }\n\n            for (var _b = 0, targets_1 = targets; _b < targets_1.length; _b++) {\n              var target = targets_1[_b];\n\n              switch (target) {\n                case \"uniformBuffer\":\n                  this.disableUniformBuffers = true;\n                  break;\n\n                case \"vao\":\n                  this.disableVertexArrayObjects = true;\n                  break;\n              }\n            }\n          }\n        }\n      } // Context lost\n\n\n      if (!this._doNotHandleContextLost) {\n        this._onContextLost = function (evt) {\n          evt.preventDefault();\n          _this._contextWasLost = true;\n          Logger.Warn(\"WebGL context lost.\");\n\n          _this.onContextLostObservable.notifyObservers(_this);\n        };\n\n        this._onContextRestored = function () {\n          // Adding a timeout to avoid race condition at browser level\n          setTimeout(function () {\n            // Rebuild gl context\n            _this._initGLContext(); // Rebuild effects\n\n\n            _this._rebuildEffects(); // Rebuild textures\n\n\n            _this._rebuildInternalTextures(); // Rebuild buffers\n\n\n            _this._rebuildBuffers(); // Cache\n\n\n            _this.wipeCaches(true);\n\n            Logger.Warn(\"WebGL context successfully restored.\");\n\n            _this.onContextRestoredObservable.notifyObservers(_this);\n\n            _this._contextWasLost = false;\n          }, 0);\n        };\n\n        canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\n        canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\n        options.powerPreference = \"high-performance\";\n      } // GL\n\n\n      if (!options.disableWebGL2Support) {\n        try {\n          this._gl = canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options);\n\n          if (this._gl) {\n            this._webGLVersion = 2.0; // Prevent weird browsers to lie (yeah that happens!)\n\n            if (!this._gl.deleteQuery) {\n              this._webGLVersion = 1.0;\n            }\n          }\n        } catch (e) {// Do nothing\n        }\n      }\n\n      if (!this._gl) {\n        if (!canvas) {\n          throw new Error(\"The provided canvas is null or undefined.\");\n        }\n\n        try {\n          this._gl = canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options);\n        } catch (e) {\n          throw new Error(\"WebGL not supported\");\n        }\n      }\n\n      if (!this._gl) {\n        throw new Error(\"WebGL not supported\");\n      }\n    } else {\n      this._gl = canvasOrContext;\n      this._renderingCanvas = this._gl.canvas;\n\n      if (this._gl.renderbufferStorageMultisample) {\n        this._webGLVersion = 2.0;\n      }\n\n      var attributes = this._gl.getContextAttributes();\n\n      if (attributes) {\n        options.stencil = attributes.stencil;\n      }\n    } // Ensures a consistent color space unpacking of textures cross browser.\n\n\n    this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n\n    if (options.useHighPrecisionFloats !== undefined) {\n      this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\n    } // Viewport\n\n\n    var devicePixelRatio = DomManagement.IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\n    var limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\n    this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\n    this.resize();\n    this._isStencilEnable = options.stencil ? true : false;\n\n    this._initGLContext(); // Prepare buffer pointers\n\n\n    for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\n      this._currentBufferPointers[i] = new BufferPointer();\n    } // Shader processor\n\n\n    if (this.webGLVersion > 1) {\n      this._shaderProcessor = new WebGL2ShaderProcessor();\n    } else {\n      this._shaderProcessor = new WebGLShaderProcessor();\n    } // Detect if we are running on a faulty buggy OS.\n\n\n    this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent); // Starting with iOS 14, we can trust the browser\n    // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\n    // if (matches && matches.length === 2) {\n    //     if (parseInt(matches[1]) >= 14) {\n    //         this._badOS = false;\n    //     }\n    // }\n    // Detect if we are running on a faulty buggy desktop OS.\n\n    this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n    this._creationOptions = options;\n    console.log(\"Babylon.js v\" + ThinEngine.Version + \" - \" + this.description);\n  }\n\n  Object.defineProperty(ThinEngine, \"NpmPackage\", {\n    /**\r\n     * Returns the current npm package of the sdk\r\n     */\n    // Not mixed with Version for tooling purpose.\n    get: function () {\n      return \"babylonjs@4.2.0\";\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine, \"Version\", {\n    /**\r\n     * Returns the current version of the framework\r\n     */\n    get: function () {\n      return \"4.2.0\";\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"description\", {\n    /**\r\n     * Returns a string describing the current engine\r\n     */\n    get: function () {\n      var description = \"WebGL\" + this.webGLVersion;\n\n      if (this._caps.parallelShaderCompile) {\n        description += \" - Parallel shader compilation\";\n      }\n\n      return description;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine, \"ShadersRepository\", {\n    /**\r\n     * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\r\n     */\n    get: function () {\n      return Effect.ShadersRepository;\n    },\n    set: function (value) {\n      Effect.ShadersRepository = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"supportsUniformBuffers\", {\n    /**\r\n     * Gets a boolean indicating that the engine supports uniform buffers\r\n     * @see https://doc.babylonjs.com/features/webgl2#uniform-buffer-objets\r\n     */\n    get: function () {\n      return this.webGLVersion > 1 && !this.disableUniformBuffers;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"_shouldUseHighPrecisionShader\", {\n    /** @hidden */\n    get: function () {\n      return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"needPOTTextures\", {\n    /**\r\n     * Gets a boolean indicating that only power of 2 textures are supported\r\n     * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\r\n     */\n    get: function () {\n      return this._webGLVersion < 2 || this.forcePOTTextures;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"doNotHandleContextLost\", {\n    /**\r\n     * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\r\n     * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#handling-webgl-context-lost\r\n     */\n    get: function () {\n      return this._doNotHandleContextLost;\n    },\n    set: function (value) {\n      this._doNotHandleContextLost = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"_supportsHardwareTextureRescaling\", {\n    get: function () {\n      return false;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"framebufferDimensionsObject\", {\n    /**\r\n     * sets the object from which width and height will be taken from when getting render width and height\r\n     * Will fallback to the gl object\r\n     * @param dimensions the framebuffer width and height that will be used.\r\n     */\n    set: function (dimensions) {\n      this._framebufferDimensionsObject = dimensions;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"currentViewport\", {\n    /**\r\n     * Gets the current viewport\r\n     */\n    get: function () {\n      return this._cachedViewport;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture\", {\n    /**\r\n     * Gets the default empty texture\r\n     */\n    get: function () {\n      if (!this._emptyTexture) {\n        this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture3D\", {\n    /**\r\n     * Gets the default empty 3D texture\r\n     */\n    get: function () {\n      if (!this._emptyTexture3D) {\n        this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture3D;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture2DArray\", {\n    /**\r\n     * Gets the default empty 2D array texture\r\n     */\n    get: function () {\n      if (!this._emptyTexture2DArray) {\n        this._emptyTexture2DArray = this.createRawTexture2DArray(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture2DArray;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyCubeTexture\", {\n    /**\r\n     * Gets the default empty cube texture\r\n     */\n    get: function () {\n      if (!this._emptyCubeTexture) {\n        var faceData = new Uint8Array(4);\n        var cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\n        this._emptyCubeTexture = this.createRawCubeTexture(cubeData, 1, 5, 0, false, false, 1);\n      }\n\n      return this._emptyCubeTexture;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  ThinEngine.prototype._rebuildInternalTextures = function () {\n    var currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\n\n\n    for (var _i = 0, currentState_1 = currentState; _i < currentState_1.length; _i++) {\n      var internalTexture = currentState_1[_i];\n\n      internalTexture._rebuild();\n    }\n  };\n\n  ThinEngine.prototype._rebuildEffects = function () {\n    for (var key in this._compiledEffects) {\n      var effect = this._compiledEffects[key];\n\n      effect._prepareEffect();\n    }\n\n    Effect.ResetCache();\n  };\n  /**\r\n   * Gets a boolean indicating if all created effects are ready\r\n   * @returns true if all effects are ready\r\n   */\n\n\n  ThinEngine.prototype.areAllEffectsReady = function () {\n    for (var key in this._compiledEffects) {\n      var effect = this._compiledEffects[key];\n\n      if (!effect.isReady()) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n\n  ThinEngine.prototype._rebuildBuffers = function () {\n    // Uniforms\n    for (var _i = 0, _a = this._uniformBuffers; _i < _a.length; _i++) {\n      var uniformBuffer = _a[_i];\n\n      uniformBuffer._rebuild();\n    }\n  };\n\n  ThinEngine.prototype._initGLContext = function () {\n    // Caps\n    this._caps = {\n      maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\n      maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\n      maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\n      maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\n      maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\n      maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\n      maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\n      maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\n      maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\n      maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\n      maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\n      parallelShaderCompile: this._gl.getExtension('KHR_parallel_shader_compile'),\n      standardDerivatives: this._webGLVersion > 1 || this._gl.getExtension('OES_standard_derivatives') !== null,\n      maxAnisotropy: 1,\n      astc: this._gl.getExtension('WEBGL_compressed_texture_astc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_astc'),\n      bptc: this._gl.getExtension('EXT_texture_compression_bptc') || this._gl.getExtension('WEBKIT_EXT_texture_compression_bptc'),\n      s3tc: this._gl.getExtension('WEBGL_compressed_texture_s3tc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_s3tc'),\n      pvrtc: this._gl.getExtension('WEBGL_compressed_texture_pvrtc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_pvrtc'),\n      etc1: this._gl.getExtension('WEBGL_compressed_texture_etc1') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc1'),\n      etc2: this._gl.getExtension('WEBGL_compressed_texture_etc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc') || this._gl.getExtension('WEBGL_compressed_texture_es3_0'),\n      textureAnisotropicFilterExtension: this._gl.getExtension('EXT_texture_filter_anisotropic') || this._gl.getExtension('WEBKIT_EXT_texture_filter_anisotropic') || this._gl.getExtension('MOZ_EXT_texture_filter_anisotropic'),\n      uintIndices: this._webGLVersion > 1 || this._gl.getExtension('OES_element_index_uint') !== null,\n      fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension('EXT_frag_depth') !== null,\n      highPrecisionShaderSupported: false,\n      timerQuery: this._gl.getExtension('EXT_disjoint_timer_query_webgl2') || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\n      canUseTimestampForTimerQuery: false,\n      drawBuffersExtension: false,\n      maxMSAASamples: 1,\n      colorBufferFloat: this._webGLVersion > 1 && this._gl.getExtension('EXT_color_buffer_float'),\n      textureFloat: this._webGLVersion > 1 || this._gl.getExtension('OES_texture_float') ? true : false,\n      textureHalfFloat: this._webGLVersion > 1 || this._gl.getExtension('OES_texture_half_float') ? true : false,\n      textureHalfFloatRender: false,\n      textureFloatLinearFiltering: false,\n      textureFloatRender: false,\n      textureHalfFloatLinearFiltering: false,\n      vertexArrayObject: false,\n      instancedArrays: false,\n      textureLOD: this._webGLVersion > 1 || this._gl.getExtension('EXT_shader_texture_lod') ? true : false,\n      blendMinMax: false,\n      multiview: this._gl.getExtension('OVR_multiview2'),\n      oculusMultiview: this._gl.getExtension('OCULUS_multiview'),\n      depthTextureExtension: false\n    }; // Infos\n\n    this._glVersion = this._gl.getParameter(this._gl.VERSION);\n\n    var rendererInfo = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\n\n    if (rendererInfo != null) {\n      this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\n      this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\n    }\n\n    if (!this._glVendor) {\n      this._glVendor = \"Unknown vendor\";\n    }\n\n    if (!this._glRenderer) {\n      this._glRenderer = \"Unknown renderer\";\n    } // Constants\n\n\n    if (this._gl.HALF_FLOAT_OES !== 0x8D61) {\n      this._gl.HALF_FLOAT_OES = 0x8D61; // Half floating-point type (16-bit).\n    }\n\n    if (this._gl.RGBA16F !== 0x881A) {\n      this._gl.RGBA16F = 0x881A; // RGBA 16-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.RGBA32F !== 0x8814) {\n      this._gl.RGBA32F = 0x8814; // RGBA 32-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.DEPTH24_STENCIL8 !== 35056) {\n      this._gl.DEPTH24_STENCIL8 = 35056;\n    } // Extensions\n\n\n    if (this._caps.timerQuery) {\n      if (this._webGLVersion === 1) {\n        this._gl.getQuery = this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery);\n      }\n\n      this._caps.canUseTimestampForTimerQuery = this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT) > 0;\n    }\n\n    this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT) : 0;\n    this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension('OES_texture_float_linear') ? true : false;\n    this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\n    this._caps.textureHalfFloatLinearFiltering = this._webGLVersion > 1 || this._caps.textureHalfFloat && this._gl.getExtension('OES_texture_half_float_linear') ? true : false; // Checks if some of the format renders first to allow the use of webgl inspector.\n\n    if (this._webGLVersion > 1) {\n      if (this._gl.HALF_FLOAT_OES !== 0x140B) {\n        this._gl.HALF_FLOAT_OES = 0x140B;\n      }\n    }\n\n    this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer(); // Draw buffers\n\n    if (this._webGLVersion > 1) {\n      this._caps.drawBuffersExtension = true;\n      this._caps.maxMSAASamples = this._gl.getParameter(this._gl.MAX_SAMPLES);\n    } else {\n      var drawBuffersExtension = this._gl.getExtension('WEBGL_draw_buffers');\n\n      if (drawBuffersExtension !== null) {\n        this._caps.drawBuffersExtension = true;\n        this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\n        this._gl.DRAW_FRAMEBUFFER = this._gl.FRAMEBUFFER;\n\n        for (var i = 0; i < 16; i++) {\n          this._gl[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = drawBuffersExtension[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\n        }\n      }\n    } // Depth Texture\n\n\n    if (this._webGLVersion > 1) {\n      this._caps.depthTextureExtension = true;\n    } else {\n      var depthTextureExtension = this._gl.getExtension('WEBGL_depth_texture');\n\n      if (depthTextureExtension != null) {\n        this._caps.depthTextureExtension = true;\n        this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\n      }\n    } // Vertex array object\n\n\n    if (this.disableVertexArrayObjects) {\n      this._caps.vertexArrayObject = false;\n    } else if (this._webGLVersion > 1) {\n      this._caps.vertexArrayObject = true;\n    } else {\n      var vertexArrayObjectExtension = this._gl.getExtension('OES_vertex_array_object');\n\n      if (vertexArrayObjectExtension != null) {\n        this._caps.vertexArrayObject = true;\n        this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\n      }\n    } // Instances count\n\n\n    if (this._webGLVersion > 1) {\n      this._caps.instancedArrays = true;\n    } else {\n      var instanceExtension = this._gl.getExtension('ANGLE_instanced_arrays');\n\n      if (instanceExtension != null) {\n        this._caps.instancedArrays = true;\n        this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\n        this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\n        this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\n      } else {\n        this._caps.instancedArrays = false;\n      }\n    }\n\n    if (this._gl.getShaderPrecisionFormat) {\n      var vertex_highp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\n\n      var fragment_highp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\n\n      if (vertex_highp && fragment_highp) {\n        this._caps.highPrecisionShaderSupported = vertex_highp.precision !== 0 && fragment_highp.precision !== 0;\n      }\n    }\n\n    if (this._webGLVersion > 1) {\n      this._caps.blendMinMax = true;\n    } else {\n      var blendMinMaxExtension = this._gl.getExtension('EXT_blend_minmax');\n\n      if (blendMinMaxExtension != null) {\n        this._caps.blendMinMax = true;\n        this._gl.MAX = blendMinMaxExtension.MAX_EXT;\n        this._gl.MIN = blendMinMaxExtension.MIN_EXT;\n      }\n    } // Depth buffer\n\n\n    this._depthCullingState.depthTest = true;\n    this._depthCullingState.depthFunc = this._gl.LEQUAL;\n    this._depthCullingState.depthMask = true; // Texture maps\n\n    this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\n\n    for (var slot = 0; slot < this._maxSimultaneousTextures; slot++) {\n      this._nextFreeTextureSlots.push(slot);\n    }\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"webGLVersion\", {\n    /**\r\n     * Gets version of the current webGL context\r\n     */\n    get: function () {\n      return this._webGLVersion;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\r\n   * Gets a string identifying the name of the class\r\n   * @returns \"Engine\" string\r\n   */\n\n  ThinEngine.prototype.getClassName = function () {\n    return \"ThinEngine\";\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"isStencilEnable\", {\n    /**\r\n     * Returns true if the stencil buffer has been enabled through the creation option of the context.\r\n     */\n    get: function () {\n      return this._isStencilEnable;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /** @hidden */\n\n  ThinEngine.prototype._prepareWorkingCanvas = function () {\n    if (this._workingCanvas) {\n      return;\n    }\n\n    this._workingCanvas = CanvasGenerator.CreateCanvas(1, 1);\n\n    var context = this._workingCanvas.getContext(\"2d\");\n\n    if (context) {\n      this._workingContext = context;\n    }\n  };\n  /**\r\n   * Reset the texture cache to empty state\r\n   */\n\n\n  ThinEngine.prototype.resetTextureCache = function () {\n    for (var key in this._boundTexturesCache) {\n      if (!this._boundTexturesCache.hasOwnProperty(key)) {\n        continue;\n      }\n\n      this._boundTexturesCache[key] = null;\n    }\n\n    this._currentTextureChannel = -1;\n  };\n  /**\r\n   * Gets an object containing information about the current webGL context\r\n   * @returns an object containing the vender, the renderer and the version of the current webGL context\r\n   */\n\n\n  ThinEngine.prototype.getGlInfo = function () {\n    return {\n      vendor: this._glVendor,\n      renderer: this._glRenderer,\n      version: this._glVersion\n    };\n  };\n  /**\r\n   * Defines the hardware scaling level.\r\n   * By default the hardware scaling level is computed from the window device ratio.\r\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n   * @param level defines the level to use\r\n   */\n\n\n  ThinEngine.prototype.setHardwareScalingLevel = function (level) {\n    this._hardwareScalingLevel = level;\n    this.resize();\n  };\n  /**\r\n   * Gets the current hardware scaling level.\r\n   * By default the hardware scaling level is computed from the window device ratio.\r\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n   * @returns a number indicating the current hardware scaling level\r\n   */\n\n\n  ThinEngine.prototype.getHardwareScalingLevel = function () {\n    return this._hardwareScalingLevel;\n  };\n  /**\r\n   * Gets the list of loaded textures\r\n   * @returns an array containing all loaded textures\r\n   */\n\n\n  ThinEngine.prototype.getLoadedTexturesCache = function () {\n    return this._internalTexturesCache;\n  };\n  /**\r\n   * Gets the object containing all engine capabilities\r\n   * @returns the EngineCapabilities object\r\n   */\n\n\n  ThinEngine.prototype.getCaps = function () {\n    return this._caps;\n  };\n  /**\r\n   * stop executing a render loop function and remove it from the execution array\r\n   * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\r\n   */\n\n\n  ThinEngine.prototype.stopRenderLoop = function (renderFunction) {\n    if (!renderFunction) {\n      this._activeRenderLoops = [];\n      return;\n    }\n\n    var index = this._activeRenderLoops.indexOf(renderFunction);\n\n    if (index >= 0) {\n      this._activeRenderLoops.splice(index, 1);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._renderLoop = function () {\n    if (!this._contextWasLost) {\n      var shouldRender = true;\n\n      if (!this.renderEvenInBackground && this._windowIsBackground) {\n        shouldRender = false;\n      }\n\n      if (shouldRender) {\n        // Start new frame\n        this.beginFrame();\n\n        for (var index = 0; index < this._activeRenderLoops.length; index++) {\n          var renderFunction = this._activeRenderLoops[index];\n          renderFunction();\n        } // Present\n\n\n        this.endFrame();\n      }\n    }\n\n    if (this._activeRenderLoops.length > 0) {\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    } else {\n      this._renderingQueueLaunched = false;\n    }\n  };\n  /**\r\n   * Gets the HTML canvas attached with the current webGL context\r\n   * @returns a HTML canvas\r\n   */\n\n\n  ThinEngine.prototype.getRenderingCanvas = function () {\n    return this._renderingCanvas;\n  };\n  /**\r\n   * Gets host window\r\n   * @returns the host window object\r\n   */\n\n\n  ThinEngine.prototype.getHostWindow = function () {\n    if (!DomManagement.IsWindowObjectExist()) {\n      return null;\n    }\n\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\n      return this._renderingCanvas.ownerDocument.defaultView;\n    }\n\n    return window;\n  };\n  /**\r\n   * Gets the current render width\r\n   * @param useScreen defines if screen size must be used (or the current render target if any)\r\n   * @returns a number defining the current render width\r\n   */\n\n\n  ThinEngine.prototype.getRenderWidth = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.width;\n    }\n\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\n  };\n  /**\r\n   * Gets the current render height\r\n   * @param useScreen defines if screen size must be used (or the current render target if any)\r\n   * @returns a number defining the current render height\r\n   */\n\n\n  ThinEngine.prototype.getRenderHeight = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.height;\n    }\n\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\n  };\n  /**\r\n   * Can be used to override the current requestAnimationFrame requester.\r\n   * @hidden\r\n   */\n\n\n  ThinEngine.prototype._queueNewFrame = function (bindedRenderFunction, requester) {\n    return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\n  };\n  /**\r\n   * Register and execute a render loop. The engine can have more than one render function\r\n   * @param renderFunction defines the function to continuously execute\r\n   */\n\n\n  ThinEngine.prototype.runRenderLoop = function (renderFunction) {\n    if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\n      return;\n    }\n\n    this._activeRenderLoops.push(renderFunction);\n\n    if (!this._renderingQueueLaunched) {\n      this._renderingQueueLaunched = true;\n      this._boundRenderFunction = this._renderLoop.bind(this);\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    }\n  };\n  /**\r\n   * Clear the current render buffer or the current render target (if any is set up)\r\n   * @param color defines the color to use\r\n   * @param backBuffer defines if the back buffer must be cleared\r\n   * @param depth defines if the depth buffer must be cleared\r\n   * @param stencil defines if the stencil buffer must be cleared\r\n   */\n\n\n  ThinEngine.prototype.clear = function (color, backBuffer, depth, stencil) {\n    if (stencil === void 0) {\n      stencil = false;\n    }\n\n    this.applyStates();\n    var mode = 0;\n\n    if (backBuffer && color) {\n      this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\n\n      mode |= this._gl.COLOR_BUFFER_BIT;\n    }\n\n    if (depth) {\n      if (this.useReverseDepthBuffer) {\n        this._depthCullingState.depthFunc = this._gl.GREATER;\n\n        this._gl.clearDepth(0.0);\n      } else {\n        this._gl.clearDepth(1.0);\n      }\n\n      mode |= this._gl.DEPTH_BUFFER_BIT;\n    }\n\n    if (stencil) {\n      this._gl.clearStencil(0);\n\n      mode |= this._gl.STENCIL_BUFFER_BIT;\n    }\n\n    this._gl.clear(mode);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._viewport = function (x, y, width, height) {\n    if (x !== this._viewportCached.x || y !== this._viewportCached.y || width !== this._viewportCached.z || height !== this._viewportCached.w) {\n      this._viewportCached.x = x;\n      this._viewportCached.y = y;\n      this._viewportCached.z = width;\n      this._viewportCached.w = height;\n\n      this._gl.viewport(x, y, width, height);\n    }\n  };\n  /**\r\n   * Set the WebGL's viewport\r\n   * @param viewport defines the viewport element to be used\r\n   * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\r\n   * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\r\n   */\n\n\n  ThinEngine.prototype.setViewport = function (viewport, requiredWidth, requiredHeight) {\n    var width = requiredWidth || this.getRenderWidth();\n    var height = requiredHeight || this.getRenderHeight();\n    var x = viewport.x || 0;\n    var y = viewport.y || 0;\n    this._cachedViewport = viewport;\n\n    this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\n  };\n  /**\r\n   * Begin a new frame\r\n   */\n\n\n  ThinEngine.prototype.beginFrame = function () {};\n  /**\r\n   * Enf the current frame\r\n   */\n\n\n  ThinEngine.prototype.endFrame = function () {\n    // Force a flush in case we are using a bad OS.\n    if (this._badOS) {\n      this.flushFramebuffer();\n    }\n  };\n  /**\r\n   * Resize the view according to the canvas' size\r\n   */\n\n\n  ThinEngine.prototype.resize = function () {\n    var width;\n    var height;\n\n    if (DomManagement.IsWindowObjectExist()) {\n      width = this._renderingCanvas ? this._renderingCanvas.clientWidth || this._renderingCanvas.width : window.innerWidth;\n      height = this._renderingCanvas ? this._renderingCanvas.clientHeight || this._renderingCanvas.height : window.innerHeight;\n    } else {\n      width = this._renderingCanvas ? this._renderingCanvas.width : 100;\n      height = this._renderingCanvas ? this._renderingCanvas.height : 100;\n    }\n\n    this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel);\n  };\n  /**\r\n   * Force a specific size of the canvas\r\n   * @param width defines the new canvas' width\r\n   * @param height defines the new canvas' height\r\n   * @returns true if the size was changed\r\n   */\n\n\n  ThinEngine.prototype.setSize = function (width, height) {\n    if (!this._renderingCanvas) {\n      return false;\n    }\n\n    width = width | 0;\n    height = height | 0;\n\n    if (this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\n      return false;\n    }\n\n    this._renderingCanvas.width = width;\n    this._renderingCanvas.height = height;\n    return true;\n  };\n  /**\r\n   * Binds the frame buffer to the specified texture.\r\n   * @param texture The texture to render to or null for the default canvas\r\n   * @param faceIndex The face of the texture to render to in case of cube texture\r\n   * @param requiredWidth The width of the target to render to\r\n   * @param requiredHeight The height of the target to render to\r\n   * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\r\n   * @param lodLevel defines the lod level to bind to the frame buffer\r\n   * @param layer defines the 2d array index to bind to frame buffer to\r\n   */\n\n\n  ThinEngine.prototype.bindFramebuffer = function (texture, faceIndex, requiredWidth, requiredHeight, forceFullscreenViewport, lodLevel, layer) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lodLevel === void 0) {\n      lodLevel = 0;\n    }\n\n    if (layer === void 0) {\n      layer = 0;\n    }\n\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    }\n\n    this._currentRenderTarget = texture;\n\n    this._bindUnboundFramebuffer(texture._MSAAFramebuffer ? texture._MSAAFramebuffer : texture._framebuffer);\n\n    var gl = this._gl;\n\n    if (texture.is2DArray) {\n      gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture._webGLTexture, lodLevel, layer);\n    } else if (texture.isCube) {\n      gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, texture._webGLTexture, lodLevel);\n    }\n\n    var depthStencilTexture = texture._depthStencilTexture;\n\n    if (depthStencilTexture) {\n      var attachment = depthStencilTexture._generateStencilBuffer ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\n\n      if (texture.is2DArray) {\n        gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, depthStencilTexture._webGLTexture, lodLevel, layer);\n      } else if (texture.isCube) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, depthStencilTexture._webGLTexture, lodLevel);\n      } else {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, depthStencilTexture._webGLTexture, lodLevel);\n      }\n    }\n\n    if (this._cachedViewport && !forceFullscreenViewport) {\n      this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\n    } else {\n      if (!requiredWidth) {\n        requiredWidth = texture.width;\n\n        if (lodLevel) {\n          requiredWidth = requiredWidth / Math.pow(2, lodLevel);\n        }\n      }\n\n      if (!requiredHeight) {\n        requiredHeight = texture.height;\n\n        if (lodLevel) {\n          requiredHeight = requiredHeight / Math.pow(2, lodLevel);\n        }\n      }\n\n      this._viewport(0, 0, requiredWidth, requiredHeight);\n    }\n\n    this.wipeCaches();\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindUnboundFramebuffer = function (framebuffer) {\n    if (this._currentFramebuffer !== framebuffer) {\n      this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\n\n      this._currentFramebuffer = framebuffer;\n    }\n  };\n  /**\r\n   * Unbind the current render target texture from the webGL context\r\n   * @param texture defines the render target texture to unbind\r\n   * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\r\n   * @param onBeforeUnbind defines a function which will be called before the effective unbind\r\n   */\n\n\n  ThinEngine.prototype.unBindFramebuffer = function (texture, disableGenerateMipMaps, onBeforeUnbind) {\n    if (disableGenerateMipMaps === void 0) {\n      disableGenerateMipMaps = false;\n    }\n\n    this._currentRenderTarget = null; // If MSAA, we need to bitblt back to main texture\n\n    var gl = this._gl;\n\n    if (texture._MSAAFramebuffer) {\n      if (texture._textureArray) {\n        // This texture is part of a MRT texture, we need to treat all attachments\n        this.unBindMultiColorAttachmentFramebuffer(texture._textureArray, disableGenerateMipMaps, onBeforeUnbind);\n        return;\n      }\n\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, texture._MSAAFramebuffer);\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, texture._framebuffer);\n      gl.blitFramebuffer(0, 0, texture.width, texture.height, 0, 0, texture.width, texture.height, gl.COLOR_BUFFER_BIT, gl.NEAREST);\n    }\n\n    if (texture.generateMipMaps && !disableGenerateMipMaps && !texture.isCube) {\n      this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n      gl.generateMipmap(gl.TEXTURE_2D);\n\n      this._bindTextureDirectly(gl.TEXTURE_2D, null);\n    }\n\n    if (onBeforeUnbind) {\n      if (texture._MSAAFramebuffer) {\n        // Bind the correct framebuffer\n        this._bindUnboundFramebuffer(texture._framebuffer);\n      }\n\n      onBeforeUnbind();\n    }\n\n    this._bindUnboundFramebuffer(null);\n  };\n  /**\r\n   * Force a webGL flush (ie. a flush of all waiting webGL commands)\r\n   */\n\n\n  ThinEngine.prototype.flushFramebuffer = function () {\n    this._gl.flush();\n  };\n  /**\r\n   * Unbind the current render target and bind the default framebuffer\r\n   */\n\n\n  ThinEngine.prototype.restoreDefaultFramebuffer = function () {\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    } else {\n      this._bindUnboundFramebuffer(null);\n    }\n\n    if (this._cachedViewport) {\n      this.setViewport(this._cachedViewport);\n    }\n\n    this.wipeCaches();\n  }; // VBOs\n\n  /** @hidden */\n\n\n  ThinEngine.prototype._resetVertexBufferBinding = function () {\n    this.bindArrayBuffer(null);\n    this._cachedVertexBuffers = null;\n  };\n  /**\r\n   * Creates a vertex buffer\r\n   * @param data the data for the vertex buffer\r\n   * @returns the new WebGL static buffer\r\n   */\n\n\n  ThinEngine.prototype.createVertexBuffer = function (data) {\n    return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\n  };\n\n  ThinEngine.prototype._createVertexBuffer = function (data, usage) {\n    var vbo = this._gl.createBuffer();\n\n    if (!vbo) {\n      throw new Error(\"Unable to create vertex buffer\");\n    }\n\n    var dataBuffer = new WebGLDataBuffer(vbo);\n    this.bindArrayBuffer(dataBuffer);\n\n    if (data instanceof Array) {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), this._gl.STATIC_DRAW);\n    } else {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, data, this._gl.STATIC_DRAW);\n    }\n\n    this._resetVertexBufferBinding();\n\n    dataBuffer.references = 1;\n    return dataBuffer;\n  };\n  /**\r\n   * Creates a dynamic vertex buffer\r\n   * @param data the data for the dynamic vertex buffer\r\n   * @returns the new WebGL dynamic buffer\r\n   */\n\n\n  ThinEngine.prototype.createDynamicVertexBuffer = function (data) {\n    return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\n  };\n\n  ThinEngine.prototype._resetIndexBufferBinding = function () {\n    this.bindIndexBuffer(null);\n    this._cachedIndexBuffer = null;\n  };\n  /**\r\n   * Creates a new index buffer\r\n   * @param indices defines the content of the index buffer\r\n   * @param updatable defines if the index buffer must be updatable\r\n   * @returns a new webGL buffer\r\n   */\n\n\n  ThinEngine.prototype.createIndexBuffer = function (indices, updatable) {\n    var vbo = this._gl.createBuffer();\n\n    var dataBuffer = new WebGLDataBuffer(vbo);\n\n    if (!vbo) {\n      throw new Error(\"Unable to create index buffer\");\n    }\n\n    this.bindIndexBuffer(dataBuffer);\n\n    var data = this._normalizeIndexData(indices);\n\n    this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\n\n    this._resetIndexBufferBinding();\n\n    dataBuffer.references = 1;\n    dataBuffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n    return dataBuffer;\n  };\n\n  ThinEngine.prototype._normalizeIndexData = function (indices) {\n    if (indices instanceof Uint16Array) {\n      return indices;\n    } // Check 32 bit support\n\n\n    if (this._caps.uintIndices) {\n      if (indices instanceof Uint32Array) {\n        return indices;\n      } else {\n        // number[] or Int32Array, check if 32 bit is necessary\n        for (var index = 0; index < indices.length; index++) {\n          if (indices[index] >= 65535) {\n            return new Uint32Array(indices);\n          }\n        }\n\n        return new Uint16Array(indices);\n      }\n    } // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\n\n\n    return new Uint16Array(indices);\n  };\n  /**\r\n   * Bind a webGL buffer to the webGL context\r\n   * @param buffer defines the buffer to bind\r\n   */\n\n\n  ThinEngine.prototype.bindArrayBuffer = function (buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this.bindBuffer(buffer, this._gl.ARRAY_BUFFER);\n  };\n  /**\r\n   * Bind a specific block at a given index in a specific shader program\r\n   * @param pipelineContext defines the pipeline context to use\r\n   * @param blockName defines the block name\r\n   * @param index defines the index where to bind the block\r\n   */\n\n\n  ThinEngine.prototype.bindUniformBlock = function (pipelineContext, blockName, index) {\n    var program = pipelineContext.program;\n\n    var uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\n\n    this._gl.uniformBlockBinding(program, uniformLocation, index);\n  };\n\n  ThinEngine.prototype.bindIndexBuffer = function (buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this.bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\n  };\n\n  ThinEngine.prototype.bindBuffer = function (buffer, target) {\n    if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\n      this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\n\n      this._currentBoundBuffer[target] = buffer;\n    }\n  };\n  /**\r\n   * update the bound buffer with the given data\r\n   * @param data defines the data to update\r\n   */\n\n\n  ThinEngine.prototype.updateArrayBuffer = function (data) {\n    this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n  };\n\n  ThinEngine.prototype._vertexAttribPointer = function (buffer, indx, size, type, normalized, stride, offset) {\n    var pointer = this._currentBufferPointers[indx];\n\n    if (!pointer) {\n      return;\n    }\n\n    var changed = false;\n\n    if (!pointer.active) {\n      changed = true;\n      pointer.active = true;\n      pointer.index = indx;\n      pointer.size = size;\n      pointer.type = type;\n      pointer.normalized = normalized;\n      pointer.stride = stride;\n      pointer.offset = offset;\n      pointer.buffer = buffer;\n    } else {\n      if (pointer.buffer !== buffer) {\n        pointer.buffer = buffer;\n        changed = true;\n      }\n\n      if (pointer.size !== size) {\n        pointer.size = size;\n        changed = true;\n      }\n\n      if (pointer.type !== type) {\n        pointer.type = type;\n        changed = true;\n      }\n\n      if (pointer.normalized !== normalized) {\n        pointer.normalized = normalized;\n        changed = true;\n      }\n\n      if (pointer.stride !== stride) {\n        pointer.stride = stride;\n        changed = true;\n      }\n\n      if (pointer.offset !== offset) {\n        pointer.offset = offset;\n        changed = true;\n      }\n    }\n\n    if (changed || this._vaoRecordInProgress) {\n      this.bindArrayBuffer(buffer);\n\n      this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindIndexBufferWithCache = function (indexBuffer) {\n    if (indexBuffer == null) {\n      return;\n    }\n\n    if (this._cachedIndexBuffer !== indexBuffer) {\n      this._cachedIndexBuffer = indexBuffer;\n      this.bindIndexBuffer(indexBuffer);\n      this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\n    }\n  };\n\n  ThinEngine.prototype._bindVertexBuffersAttributes = function (vertexBuffers, effect) {\n    var attributes = effect.getAttributesNames();\n\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this.unbindAllAttributes();\n\n    for (var index = 0; index < attributes.length; index++) {\n      var order = effect.getAttributeLocation(index);\n\n      if (order >= 0) {\n        var vertexBuffer = vertexBuffers[attributes[index]];\n\n        if (!vertexBuffer) {\n          continue;\n        }\n\n        this._gl.enableVertexAttribArray(order);\n\n        if (!this._vaoRecordInProgress) {\n          this._vertexAttribArraysEnabled[order] = true;\n        }\n\n        var buffer = vertexBuffer.getBuffer();\n\n        if (buffer) {\n          this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\n\n          if (vertexBuffer.getIsInstanced()) {\n            this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\n\n            if (!this._vaoRecordInProgress) {\n              this._currentInstanceLocations.push(order);\n\n              this._currentInstanceBuffers.push(buffer);\n            }\n          }\n        }\n      }\n    }\n  };\n  /**\r\n   * Records a vertex array object\r\n   * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n   * @param vertexBuffers defines the list of vertex buffers to store\r\n   * @param indexBuffer defines the index buffer to store\r\n   * @param effect defines the effect to store\r\n   * @returns the new vertex array object\r\n   */\n\n\n  ThinEngine.prototype.recordVertexArrayObject = function (vertexBuffers, indexBuffer, effect) {\n    var vao = this._gl.createVertexArray();\n\n    this._vaoRecordInProgress = true;\n\n    this._gl.bindVertexArray(vao);\n\n    this._mustWipeVertexAttributes = true;\n\n    this._bindVertexBuffersAttributes(vertexBuffers, effect);\n\n    this.bindIndexBuffer(indexBuffer);\n    this._vaoRecordInProgress = false;\n\n    this._gl.bindVertexArray(null);\n\n    return vao;\n  };\n  /**\r\n   * Bind a specific vertex array object\r\n   * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n   * @param vertexArrayObject defines the vertex array object to bind\r\n   * @param indexBuffer defines the index buffer to bind\r\n   */\n\n\n  ThinEngine.prototype.bindVertexArrayObject = function (vertexArrayObject, indexBuffer) {\n    if (this._cachedVertexArrayObject !== vertexArrayObject) {\n      this._cachedVertexArrayObject = vertexArrayObject;\n\n      this._gl.bindVertexArray(vertexArrayObject);\n\n      this._cachedVertexBuffers = null;\n      this._cachedIndexBuffer = null;\n      this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\n      this._mustWipeVertexAttributes = true;\n    }\n  };\n  /**\r\n   * Bind webGl buffers directly to the webGL context\r\n   * @param vertexBuffer defines the vertex buffer to bind\r\n   * @param indexBuffer defines the index buffer to bind\r\n   * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\r\n   * @param vertexStrideSize defines the vertex stride of the vertex buffer\r\n   * @param effect defines the effect associated with the vertex buffer\r\n   */\n\n\n  ThinEngine.prototype.bindBuffersDirectly = function (vertexBuffer, indexBuffer, vertexDeclaration, vertexStrideSize, effect) {\n    if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffer;\n      this._cachedEffectForVertexBuffers = effect;\n      var attributesCount = effect.getAttributesCount();\n\n      this._unbindVertexArrayObject();\n\n      this.unbindAllAttributes();\n      var offset = 0;\n\n      for (var index = 0; index < attributesCount; index++) {\n        if (index < vertexDeclaration.length) {\n          var order = effect.getAttributeLocation(index);\n\n          if (order >= 0) {\n            this._gl.enableVertexAttribArray(order);\n\n            this._vertexAttribArraysEnabled[order] = true;\n\n            this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\n          }\n\n          offset += vertexDeclaration[index] * 4;\n        }\n      }\n    }\n\n    this._bindIndexBufferWithCache(indexBuffer);\n  };\n\n  ThinEngine.prototype._unbindVertexArrayObject = function () {\n    if (!this._cachedVertexArrayObject) {\n      return;\n    }\n\n    this._cachedVertexArrayObject = null;\n\n    this._gl.bindVertexArray(null);\n  };\n  /**\r\n   * Bind a list of vertex buffers to the webGL context\r\n   * @param vertexBuffers defines the list of vertex buffers to bind\r\n   * @param indexBuffer defines the index buffer to bind\r\n   * @param effect defines the effect associated with the vertex buffers\r\n   */\n\n\n  ThinEngine.prototype.bindBuffers = function (vertexBuffers, indexBuffer, effect) {\n    if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffers;\n      this._cachedEffectForVertexBuffers = effect;\n\n      this._bindVertexBuffersAttributes(vertexBuffers, effect);\n    }\n\n    this._bindIndexBufferWithCache(indexBuffer);\n  };\n  /**\r\n   * Unbind all instance attributes\r\n   */\n\n\n  ThinEngine.prototype.unbindInstanceAttributes = function () {\n    var boundBuffer;\n\n    for (var i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\n      var instancesBuffer = this._currentInstanceBuffers[i];\n\n      if (boundBuffer != instancesBuffer && instancesBuffer.references) {\n        boundBuffer = instancesBuffer;\n        this.bindArrayBuffer(instancesBuffer);\n      }\n\n      var offsetLocation = this._currentInstanceLocations[i];\n\n      this._gl.vertexAttribDivisor(offsetLocation, 0);\n    }\n\n    this._currentInstanceBuffers.length = 0;\n    this._currentInstanceLocations.length = 0;\n  };\n  /**\r\n   * Release and free the memory of a vertex array object\r\n   * @param vao defines the vertex array object to delete\r\n   */\n\n\n  ThinEngine.prototype.releaseVertexArrayObject = function (vao) {\n    this._gl.deleteVertexArray(vao);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseBuffer = function (buffer) {\n    buffer.references--;\n\n    if (buffer.references === 0) {\n      this._deleteBuffer(buffer);\n\n      return true;\n    }\n\n    return false;\n  };\n\n  ThinEngine.prototype._deleteBuffer = function (buffer) {\n    this._gl.deleteBuffer(buffer.underlyingResource);\n  };\n  /**\r\n   * Update the content of a webGL buffer used with instanciation and bind it to the webGL context\r\n   * @param instancesBuffer defines the webGL buffer to update and bind\r\n   * @param data defines the data to store in the buffer\r\n   * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n   */\n\n\n  ThinEngine.prototype.updateAndBindInstancesBuffer = function (instancesBuffer, data, offsetLocations) {\n    this.bindArrayBuffer(instancesBuffer);\n\n    if (data) {\n      this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n    }\n\n    if (offsetLocations[0].index !== undefined) {\n      this.bindInstancesBuffer(instancesBuffer, offsetLocations, true);\n    } else {\n      for (var index = 0; index < 4; index++) {\n        var offsetLocation = offsetLocations[index];\n\n        if (!this._vertexAttribArraysEnabled[offsetLocation]) {\n          this._gl.enableVertexAttribArray(offsetLocation);\n\n          this._vertexAttribArraysEnabled[offsetLocation] = true;\n        }\n\n        this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\n\n        this._gl.vertexAttribDivisor(offsetLocation, 1);\n\n        this._currentInstanceLocations.push(offsetLocation);\n\n        this._currentInstanceBuffers.push(instancesBuffer);\n      }\n    }\n  };\n  /**\r\n   * Bind the content of a webGL buffer used with instantiation\r\n   * @param instancesBuffer defines the webGL buffer to bind\r\n   * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n   * @param computeStride defines Whether to compute the strides from the info or use the default 0\r\n   */\n\n\n  ThinEngine.prototype.bindInstancesBuffer = function (instancesBuffer, attributesInfo, computeStride) {\n    if (computeStride === void 0) {\n      computeStride = true;\n    }\n\n    this.bindArrayBuffer(instancesBuffer);\n    var stride = 0;\n\n    if (computeStride) {\n      for (var i = 0; i < attributesInfo.length; i++) {\n        var ai = attributesInfo[i];\n        stride += ai.attributeSize * 4;\n      }\n    }\n\n    for (var i = 0; i < attributesInfo.length; i++) {\n      var ai = attributesInfo[i];\n\n      if (ai.index === undefined) {\n        ai.index = this._currentEffect.getAttributeLocationByName(ai.attributeName);\n      }\n\n      if (ai.index < 0) {\n        continue;\n      }\n\n      if (!this._vertexAttribArraysEnabled[ai.index]) {\n        this._gl.enableVertexAttribArray(ai.index);\n\n        this._vertexAttribArraysEnabled[ai.index] = true;\n      }\n\n      this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\n\n      this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\n\n      this._currentInstanceLocations.push(ai.index);\n\n      this._currentInstanceBuffers.push(instancesBuffer);\n    }\n  };\n  /**\r\n   * Disable the instance attribute corresponding to the name in parameter\r\n   * @param name defines the name of the attribute to disable\r\n   */\n\n\n  ThinEngine.prototype.disableInstanceAttributeByName = function (name) {\n    if (!this._currentEffect) {\n      return;\n    }\n\n    var attributeLocation = this._currentEffect.getAttributeLocationByName(name);\n\n    this.disableInstanceAttribute(attributeLocation);\n  };\n  /**\r\n   * Disable the instance attribute corresponding to the location in parameter\r\n   * @param attributeLocation defines the attribute location of the attribute to disable\r\n   */\n\n\n  ThinEngine.prototype.disableInstanceAttribute = function (attributeLocation) {\n    var shouldClean = false;\n    var index;\n\n    while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\n      this._currentInstanceLocations.splice(index, 1);\n\n      this._currentInstanceBuffers.splice(index, 1);\n\n      shouldClean = true;\n      index = this._currentInstanceLocations.indexOf(attributeLocation);\n    }\n\n    if (shouldClean) {\n      this._gl.vertexAttribDivisor(attributeLocation, 0);\n\n      this.disableAttributeByIndex(attributeLocation);\n    }\n  };\n  /**\r\n   * Disable the attribute corresponding to the location in parameter\r\n   * @param attributeLocation defines the attribute location of the attribute to disable\r\n   */\n\n\n  ThinEngine.prototype.disableAttributeByIndex = function (attributeLocation) {\n    this._gl.disableVertexAttribArray(attributeLocation);\n\n    this._vertexAttribArraysEnabled[attributeLocation] = false;\n    this._currentBufferPointers[attributeLocation].active = false;\n  };\n  /**\r\n   * Send a draw order\r\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n   * @param indexStart defines the starting index\r\n   * @param indexCount defines the number of index to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.draw = function (useTriangles, indexStart, indexCount, instancesCount) {\n    this.drawElementsType(useTriangles ? 0 : 1, indexStart, indexCount, instancesCount);\n  };\n  /**\r\n   * Draw a list of points\r\n   * @param verticesStart defines the index of first vertex to draw\r\n   * @param verticesCount defines the count of vertices to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawPointClouds = function (verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(2, verticesStart, verticesCount, instancesCount);\n  };\n  /**\r\n   * Draw a list of unindexed primitives\r\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n   * @param verticesStart defines the index of first vertex to draw\r\n   * @param verticesCount defines the count of vertices to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawUnIndexed = function (useTriangles, verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(useTriangles ? 0 : 1, verticesStart, verticesCount, instancesCount);\n  };\n  /**\r\n   * Draw a list of indexed primitives\r\n   * @param fillMode defines the primitive to use\r\n   * @param indexStart defines the starting index\r\n   * @param indexCount defines the number of index to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawElementsType = function (fillMode, indexStart, indexCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n\n    this._reportDrawCall(); // Render\n\n\n    var drawMode = this._drawMode(fillMode);\n\n    var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\n    var mult = this._uintIndicesCurrentlySet ? 4 : 2;\n\n    if (instancesCount) {\n      this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\n    } else {\n      this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\n    }\n  };\n  /**\r\n   * Draw a list of unindexed primitives\r\n   * @param fillMode defines the primitive to use\r\n   * @param verticesStart defines the index of first vertex to draw\r\n   * @param verticesCount defines the count of vertices to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawArraysType = function (fillMode, verticesStart, verticesCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n\n    this._reportDrawCall();\n\n    var drawMode = this._drawMode(fillMode);\n\n    if (instancesCount) {\n      this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\n    } else {\n      this._gl.drawArrays(drawMode, verticesStart, verticesCount);\n    }\n  };\n\n  ThinEngine.prototype._drawMode = function (fillMode) {\n    switch (fillMode) {\n      // Triangle views\n      case 0:\n        return this._gl.TRIANGLES;\n\n      case 2:\n        return this._gl.POINTS;\n\n      case 1:\n        return this._gl.LINES;\n      // Draw modes\n\n      case 3:\n        return this._gl.POINTS;\n\n      case 4:\n        return this._gl.LINES;\n\n      case 5:\n        return this._gl.LINE_LOOP;\n\n      case 6:\n        return this._gl.LINE_STRIP;\n\n      case 7:\n        return this._gl.TRIANGLE_STRIP;\n\n      case 8:\n        return this._gl.TRIANGLE_FAN;\n\n      default:\n        return this._gl.TRIANGLES;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._reportDrawCall = function () {// Will be implemented by children\n  }; // Shaders\n\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseEffect = function (effect) {\n    if (this._compiledEffects[effect._key]) {\n      delete this._compiledEffects[effect._key];\n\n      this._deletePipelineContext(effect.getPipelineContext());\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._deletePipelineContext = function (pipelineContext) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (webGLPipelineContext && webGLPipelineContext.program) {\n      webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\n\n      this._gl.deleteProgram(webGLPipelineContext.program);\n    }\n  };\n  /**\r\n   * Create a new effect (used to store vertex/fragment shaders)\r\n   * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\r\n   * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\r\n   * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\r\n   * @param samplers defines an array of string used to represent textures\r\n   * @param defines defines the string containing the defines to use to compile the shaders\r\n   * @param fallbacks defines the list of potential fallbacks to use if shader conmpilation fails\r\n   * @param onCompiled defines a function to call when the effect creation is successful\r\n   * @param onError defines a function to call when the effect creation has failed\r\n   * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\r\n   * @returns the new Effect\r\n   */\n\n\n  ThinEngine.prototype.createEffect = function (baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, defines, fallbacks, onCompiled, onError, indexParameters) {\n    var vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\n    var fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\n    var name = vertex + \"+\" + fragment + \"@\" + (defines ? defines : attributesNamesOrOptions.defines);\n\n    if (this._compiledEffects[name]) {\n      var compiledEffect = this._compiledEffects[name];\n\n      if (onCompiled && compiledEffect.isReady()) {\n        onCompiled(compiledEffect);\n      }\n\n      return compiledEffect;\n    }\n\n    var effect = new Effect(baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, this, defines, fallbacks, onCompiled, onError, indexParameters);\n    effect._key = name;\n    this._compiledEffects[name] = effect;\n    return effect;\n  };\n\n  ThinEngine._ConcatenateShader = function (source, defines, shaderVersion) {\n    if (shaderVersion === void 0) {\n      shaderVersion = \"\";\n    }\n\n    return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\n  };\n\n  ThinEngine.prototype._compileShader = function (source, type, defines, shaderVersion) {\n    return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\n  };\n\n  ThinEngine.prototype._compileRawShader = function (source, type) {\n    var gl = this._gl;\n    var shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\n\n    if (!shader) {\n      throw new Error(\"Something went wrong while compile the shader.\");\n    }\n\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    return shader;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getShaderSource = function (shader) {\n    return this._gl.getShaderSource(shader);\n  };\n  /**\r\n   * Directly creates a webGL program\r\n   * @param pipelineContext  defines the pipeline context to attach to\r\n   * @param vertexCode defines the vertex shader code to use\r\n   * @param fragmentCode defines the fragment shader code to use\r\n   * @param context defines the webGL context to use (if not set, the current one will be used)\r\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n   * @returns the new webGL program\r\n   */\n\n\n  ThinEngine.prototype.createRawShaderProgram = function (pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    context = context || this._gl;\n\n    var vertexShader = this._compileRawShader(vertexCode, \"vertex\");\n\n    var fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\n\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  };\n  /**\r\n   * Creates a webGL program\r\n   * @param pipelineContext  defines the pipeline context to attach to\r\n   * @param vertexCode  defines the vertex shader code to use\r\n   * @param fragmentCode defines the fragment shader code to use\r\n   * @param defines defines the string containing the defines to use to compile the shaders\r\n   * @param context defines the webGL context to use (if not set, the current one will be used)\r\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n   * @returns the new webGL program\r\n   */\n\n\n  ThinEngine.prototype.createShaderProgram = function (pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    context = context || this._gl;\n    var shaderVersion = this._webGLVersion > 1 ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\n\n    var vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\n\n    var fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\n\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  };\n  /**\r\n   * Creates a new pipeline context\r\n   * @returns the new pipeline\r\n   */\n\n\n  ThinEngine.prototype.createPipelineContext = function () {\n    var pipelineContext = new WebGLPipelineContext();\n    pipelineContext.engine = this;\n\n    if (this._caps.parallelShaderCompile) {\n      pipelineContext.isParallelCompiled = true;\n    }\n\n    return pipelineContext;\n  };\n\n  ThinEngine.prototype._createShaderProgram = function (pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    var shaderProgram = context.createProgram();\n    pipelineContext.program = shaderProgram;\n\n    if (!shaderProgram) {\n      throw new Error(\"Unable to create program\");\n    }\n\n    context.attachShader(shaderProgram, vertexShader);\n    context.attachShader(shaderProgram, fragmentShader);\n    context.linkProgram(shaderProgram);\n    pipelineContext.context = context;\n    pipelineContext.vertexShader = vertexShader;\n    pipelineContext.fragmentShader = fragmentShader;\n\n    if (!pipelineContext.isParallelCompiled) {\n      this._finalizePipelineContext(pipelineContext);\n    }\n\n    return shaderProgram;\n  };\n\n  ThinEngine.prototype._finalizePipelineContext = function (pipelineContext) {\n    var context = pipelineContext.context;\n    var vertexShader = pipelineContext.vertexShader;\n    var fragmentShader = pipelineContext.fragmentShader;\n    var program = pipelineContext.program;\n    var linked = context.getProgramParameter(program, context.LINK_STATUS);\n\n    if (!linked) {\n      // Get more info\n      // Vertex\n      if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\n        var log = this._gl.getShaderInfoLog(vertexShader);\n\n        if (log) {\n          pipelineContext.vertexCompilationError = log;\n          throw new Error(\"VERTEX SHADER \" + log);\n        }\n      } // Fragment\n\n\n      if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\n        var log = this._gl.getShaderInfoLog(fragmentShader);\n\n        if (log) {\n          pipelineContext.fragmentCompilationError = log;\n          throw new Error(\"FRAGMENT SHADER \" + log);\n        }\n      }\n\n      var error = context.getProgramInfoLog(program);\n\n      if (error) {\n        pipelineContext.programLinkError = error;\n        throw new Error(error);\n      }\n    }\n\n    if (this.validateShaderPrograms) {\n      context.validateProgram(program);\n      var validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\n\n      if (!validated) {\n        var error = context.getProgramInfoLog(program);\n\n        if (error) {\n          pipelineContext.programValidationError = error;\n          throw new Error(error);\n        }\n      }\n    }\n\n    context.deleteShader(vertexShader);\n    context.deleteShader(fragmentShader);\n    pipelineContext.vertexShader = undefined;\n    pipelineContext.fragmentShader = undefined;\n\n    if (pipelineContext.onCompiled) {\n      pipelineContext.onCompiled();\n      pipelineContext.onCompiled = undefined;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._preparePipelineContext = function (pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rebuildRebind, defines, transformFeedbackVaryings) {\n    var webGLRenderingState = pipelineContext;\n\n    if (createAsRaw) {\n      webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\n    } else {\n      webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\n    }\n\n    webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._isRenderingStateCompiled = function (pipelineContext) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (this._gl.getProgramParameter(webGLPipelineContext.program, this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)) {\n      this._finalizePipelineContext(webGLPipelineContext);\n\n      return true;\n    }\n\n    return false;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._executeWhenRenderingStateIsCompiled = function (pipelineContext, action) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (!webGLPipelineContext.isParallelCompiled) {\n      action();\n      return;\n    }\n\n    var oldHandler = webGLPipelineContext.onCompiled;\n\n    if (oldHandler) {\n      webGLPipelineContext.onCompiled = function () {\n        oldHandler();\n        action();\n      };\n    } else {\n      webGLPipelineContext.onCompiled = action;\n    }\n  };\n  /**\r\n   * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\r\n   * @param pipelineContext defines the pipeline context to use\r\n   * @param uniformsNames defines the list of uniform names\r\n   * @returns an array of webGL uniform locations\r\n   */\n\n\n  ThinEngine.prototype.getUniforms = function (pipelineContext, uniformsNames) {\n    var results = new Array();\n    var webGLPipelineContext = pipelineContext;\n\n    for (var index = 0; index < uniformsNames.length; index++) {\n      results.push(this._gl.getUniformLocation(webGLPipelineContext.program, uniformsNames[index]));\n    }\n\n    return results;\n  };\n  /**\r\n   * Gets the lsit of active attributes for a given webGL program\r\n   * @param pipelineContext defines the pipeline context to use\r\n   * @param attributesNames defines the list of attribute names to get\r\n   * @returns an array of indices indicating the offset of each attribute\r\n   */\n\n\n  ThinEngine.prototype.getAttributes = function (pipelineContext, attributesNames) {\n    var results = [];\n    var webGLPipelineContext = pipelineContext;\n\n    for (var index = 0; index < attributesNames.length; index++) {\n      try {\n        results.push(this._gl.getAttribLocation(webGLPipelineContext.program, attributesNames[index]));\n      } catch (e) {\n        results.push(-1);\n      }\n    }\n\n    return results;\n  };\n  /**\r\n   * Activates an effect, mkaing it the current one (ie. the one used for rendering)\r\n   * @param effect defines the effect to activate\r\n   */\n\n\n  ThinEngine.prototype.enableEffect = function (effect) {\n    if (!effect || effect === this._currentEffect) {\n      return;\n    } // Use program\n\n\n    this.bindSamplers(effect);\n    this._currentEffect = effect;\n\n    if (effect.onBind) {\n      effect.onBind(effect);\n    }\n\n    if (effect._onBindObservable) {\n      effect._onBindObservable.notifyObservers(effect);\n    }\n  };\n  /**\r\n   * Set the value of an uniform to a number (int)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param value defines the int number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setInt = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1i(uniform, value);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32 (stored as vec2)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray2 = function (uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform2iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32 (stored as vec3)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray3 = function (uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform3iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32 (stored as vec4)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray4 = function (uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform4iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number (stored as vec2)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray2 = function (uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform2fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number (stored as vec3)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray3 = function (uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform3fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number (stored as vec4)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray4 = function (uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform4fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of float32 (stored as matrices)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param matrices defines the array of float32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setMatrices = function (uniform, matrices) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix4fv(uniform, false, matrices);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a matrix (3x3)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param matrix defines the Float32Array representing the 3x3 matrix to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setMatrix3x3 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix3fv(uniform, false, matrix);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a matrix (2x2)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param matrix defines the Float32Array representing the 2x2 matrix to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setMatrix2x2 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix2fv(uniform, false, matrix);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a number (float)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param value defines the float number to store\r\n   * @returns true if the value was transfered\r\n   */\n\n\n  ThinEngine.prototype.setFloat = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1f(uniform, value);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a vec2\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param x defines the 1st component of the value\r\n   * @param y defines the 2nd component of the value\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setFloat2 = function (uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform2f(uniform, x, y);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a vec3\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param x defines the 1st component of the value\r\n   * @param y defines the 2nd component of the value\r\n   * @param z defines the 3rd component of the value\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setFloat3 = function (uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform3f(uniform, x, y, z);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a vec4\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param x defines the 1st component of the value\r\n   * @param y defines the 2nd component of the value\r\n   * @param z defines the 3rd component of the value\r\n   * @param w defines the 4th component of the value\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setFloat4 = function (uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform4f(uniform, x, y, z, w);\n\n    return true;\n  }; // States\n\n  /**\r\n   * Apply all cached states (depth, culling, stencil and alpha)\r\n   */\n\n\n  ThinEngine.prototype.applyStates = function () {\n    this._depthCullingState.apply(this._gl);\n\n    this._stencilState.apply(this._gl);\n\n    this._alphaState.apply(this._gl);\n\n    if (this._colorWriteChanged) {\n      this._colorWriteChanged = false;\n      var enable = this._colorWrite;\n\n      this._gl.colorMask(enable, enable, enable, enable);\n    }\n  };\n  /**\r\n   * Enable or disable color writing\r\n   * @param enable defines the state to set\r\n   */\n\n\n  ThinEngine.prototype.setColorWrite = function (enable) {\n    if (enable !== this._colorWrite) {\n      this._colorWriteChanged = true;\n      this._colorWrite = enable;\n    }\n  };\n  /**\r\n   * Gets a boolean indicating if color writing is enabled\r\n   * @returns the current color writing state\r\n   */\n\n\n  ThinEngine.prototype.getColorWrite = function () {\n    return this._colorWrite;\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"depthCullingState\", {\n    /**\r\n     * Gets the depth culling state manager\r\n     */\n    get: function () {\n      return this._depthCullingState;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"alphaState\", {\n    /**\r\n     * Gets the alpha state manager\r\n     */\n    get: function () {\n      return this._alphaState;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"stencilState\", {\n    /**\r\n     * Gets the stencil state manager\r\n     */\n    get: function () {\n      return this._stencilState;\n    },\n    enumerable: false,\n    configurable: true\n  }); // Textures\n\n  /**\r\n   * Clears the list of texture accessible through engine.\r\n   * This can help preventing texture load conflict due to name collision.\r\n   */\n\n  ThinEngine.prototype.clearInternalTexturesCache = function () {\n    this._internalTexturesCache = [];\n  };\n  /**\r\n   * Force the entire cache to be cleared\r\n   * You should not have to use this function unless your engine needs to share the webGL context with another engine\r\n   * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\r\n   */\n\n\n  ThinEngine.prototype.wipeCaches = function (bruteForce) {\n    if (this.preventCacheWipeBetweenFrames && !bruteForce) {\n      return;\n    }\n\n    this._currentEffect = null;\n    this._viewportCached.x = 0;\n    this._viewportCached.y = 0;\n    this._viewportCached.z = 0;\n    this._viewportCached.w = 0; // Done before in case we clean the attributes\n\n    this._unbindVertexArrayObject();\n\n    if (bruteForce) {\n      this._currentProgram = null;\n      this.resetTextureCache();\n\n      this._stencilState.reset();\n\n      this._depthCullingState.reset();\n\n      this._depthCullingState.depthFunc = this._gl.LEQUAL;\n\n      this._alphaState.reset();\n\n      this._alphaMode = 1;\n      this._alphaEquation = 0;\n      this._colorWrite = true;\n      this._colorWriteChanged = true;\n      this._unpackFlipYCached = null;\n\n      this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n\n      this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\n\n      this._mustWipeVertexAttributes = true;\n      this.unbindAllAttributes();\n    }\n\n    this._resetVertexBufferBinding();\n\n    this._cachedIndexBuffer = null;\n    this._cachedEffectForVertexBuffers = null;\n    this.bindIndexBuffer(null);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getSamplingParameters = function (samplingMode, generateMipMaps) {\n    var gl = this._gl;\n    var magFilter = gl.NEAREST;\n    var minFilter = gl.NEAREST;\n\n    switch (samplingMode) {\n      case 11:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 3:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 8:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 4:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 5:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 6:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 7:\n        magFilter = gl.NEAREST;\n        minFilter = gl.LINEAR;\n        break;\n\n      case 1:\n        magFilter = gl.NEAREST;\n        minFilter = gl.NEAREST;\n        break;\n\n      case 9:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 10:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 2:\n        magFilter = gl.LINEAR;\n        minFilter = gl.LINEAR;\n        break;\n\n      case 12:\n        magFilter = gl.LINEAR;\n        minFilter = gl.NEAREST;\n        break;\n    }\n\n    return {\n      min: minFilter,\n      mag: magFilter\n    };\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._createTexture = function () {\n    var texture = this._gl.createTexture();\n\n    if (!texture) {\n      throw new Error(\"Unable to create texture\");\n    }\n\n    return texture;\n  };\n  /**\r\n   * Usually called from Texture.ts.\r\n   * Passed information to create a WebGLTexture\r\n   * @param url defines a value which contains one of the following:\r\n   * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n   * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n   * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n   * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n   * @param scene needed for loading to the correct scene\r\n   * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n   * @param onLoad optional callback to be called upon successful completion\r\n   * @param onError optional callback to be called upon failure\r\n   * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n   * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n   * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n   * @param forcedExtension defines the extension to use to pick the right loader\r\n   * @param mimeType defines an optional mime type\r\n   * @param loaderOptions options to be passed to the loader\r\n   * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n   */\n\n\n  ThinEngine.prototype.createTexture = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, buffer, fallback, format, forcedExtension, mimeType, loaderOptions) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (buffer === void 0) {\n      buffer = null;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    if (format === void 0) {\n      format = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    url = url || \"\";\n    var fromData = url.substr(0, 5) === \"data:\";\n    var fromBlob = url.substr(0, 5) === \"blob:\";\n    var isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\n    var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\n    var originalUrl = url;\n\n    if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\n      url = this._transformTextureUrl(url);\n    }\n\n    if (originalUrl !== url) {\n      texture._originalUrl = originalUrl;\n    } // establish the file extension, if possible\n\n\n    var lastDot = url.lastIndexOf('.');\n    var extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\n    var loader = null; // Remove query string\n\n    var queryStringIndex = extension.indexOf(\"?\");\n\n    if (queryStringIndex > -1) {\n      extension = extension.split(\"?\")[0];\n    }\n\n    for (var _i = 0, _a = ThinEngine._TextureLoaders; _i < _a.length; _i++) {\n      var availableLoader = _a[_i];\n\n      if (availableLoader.canLoad(extension, mimeType)) {\n        loader = availableLoader;\n        break;\n      }\n    }\n\n    if (scene) {\n      scene._addPendingData(texture);\n    }\n\n    texture.url = url;\n    texture.generateMipMaps = !noMipmap;\n    texture.samplingMode = samplingMode;\n    texture.invertY = invertY;\n\n    if (!this._doNotHandleContextLost) {\n      // Keep a link to the buffer only if we plan to handle context lost\n      texture._buffer = buffer;\n    }\n\n    var onLoadObserver = null;\n\n    if (onLoad && !fallback) {\n      onLoadObserver = texture.onLoadedObservable.add(onLoad);\n    }\n\n    if (!fallback) {\n      this._internalTexturesCache.push(texture);\n    }\n\n    var onInternalError = function (message, exception) {\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      if (url === originalUrl) {\n        if (onLoadObserver) {\n          texture.onLoadedObservable.remove(onLoadObserver);\n        }\n\n        if (EngineStore.UseFallbackTexture) {\n          _this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\n        }\n\n        if (onError) {\n          onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\n        }\n      } else {\n        // fall back to the original url if the transformed url fails to load\n        Logger.Warn(\"Failed to load \" + url + \", falling back to \" + originalUrl);\n\n        _this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\n      }\n    }; // processing for non-image formats\n\n\n    if (loader) {\n      var callback_1 = function (data) {\n        loader.loadData(data, texture, function (width, height, loadMipmap, isCompressed, done, loadFailed) {\n          if (loadFailed) {\n            onInternalError(\"TextureLoader failed to load data\");\n          } else {\n            _this._prepareWebGLTexture(texture, scene, width, height, texture.invertY, !loadMipmap, isCompressed, function () {\n              done();\n              return false;\n            }, samplingMode);\n          }\n        }, loaderOptions);\n      };\n\n      if (!buffer) {\n        this._loadFile(url, function (data) {\n          return callback_1(new Uint8Array(data));\n        }, undefined, scene ? scene.offlineProvider : undefined, true, function (request, exception) {\n          onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\n        });\n      } else {\n        if (buffer instanceof ArrayBuffer) {\n          callback_1(new Uint8Array(buffer));\n        } else if (ArrayBuffer.isView(buffer)) {\n          callback_1(buffer);\n        } else {\n          if (onError) {\n            onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\n          }\n        }\n      }\n    } else {\n      var onload_1 = function (img) {\n        if (fromBlob && !_this._doNotHandleContextLost) {\n          // We need to store the image if we need to rebuild the texture\n          // in case of a webgl context lost\n          texture._buffer = img;\n        }\n\n        _this._prepareWebGLTexture(texture, scene, img.width, img.height, texture.invertY, noMipmap, false, function (potWidth, potHeight, continuationCallback) {\n          var gl = _this._gl;\n          var isPot = img.width === potWidth && img.height === potHeight;\n          var internalFormat = format ? _this._getInternalFormat(format) : extension === \".jpg\" ? gl.RGB : gl.RGBA;\n\n          if (isPot) {\n            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\n            return false;\n          }\n\n          var maxTextureSize = _this._caps.maxTextureSize;\n\n          if (img.width > maxTextureSize || img.height > maxTextureSize || !_this._supportsHardwareTextureRescaling) {\n            _this._prepareWorkingCanvas();\n\n            if (!_this._workingCanvas || !_this._workingContext) {\n              return false;\n            }\n\n            _this._workingCanvas.width = potWidth;\n            _this._workingCanvas.height = potHeight;\n\n            _this._workingContext.drawImage(img, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\n\n            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, _this._workingCanvas);\n            texture.width = potWidth;\n            texture.height = potHeight;\n            return false;\n          } else {\n            // Using shaders when possible to rescale because canvas.drawImage is lossy\n            var source_1 = new InternalTexture(_this, InternalTextureSource.Temp);\n\n            _this._bindTextureDirectly(gl.TEXTURE_2D, source_1, true);\n\n            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\n\n            _this._rescaleTexture(source_1, texture, scene, internalFormat, function () {\n              _this._releaseTexture(source_1);\n\n              _this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n              continuationCallback();\n            });\n          }\n\n          return true;\n        }, samplingMode);\n      };\n\n      if (!fromData || isBase64) {\n        if (buffer && (buffer.decoding || buffer.close)) {\n          onload_1(buffer);\n        } else {\n          ThinEngine._FileToolsLoadImage(url, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType);\n        }\n      } else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\n        ThinEngine._FileToolsLoadImage(buffer, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType);\n      } else if (buffer) {\n        onload_1(buffer);\n      }\n    }\n\n    return texture;\n  };\n  /**\r\n   * Loads an image as an HTMLImageElement.\r\n   * @param input url string, ArrayBuffer, or Blob to load\r\n   * @param onLoad callback called when the image successfully loads\r\n   * @param onError callback called when the image fails to load\r\n   * @param offlineProvider offline provider for caching\r\n   * @param mimeType optional mime type\r\n   * @returns the HTMLImageElement of the loaded image\r\n   * @hidden\r\n   */\n\n\n  ThinEngine._FileToolsLoadImage = function (input, onLoad, onError, offlineProvider, mimeType) {\n    throw _DevTools.WarnImport(\"FileTools\");\n  };\n  /**\r\n   * @hidden\r\n   */\n\n\n  ThinEngine.prototype._rescaleTexture = function (source, destination, scene, internalFormat, onComplete) {};\n  /**\r\n   * Creates a raw texture\r\n   * @param data defines the data to store in the texture\r\n   * @param width defines the width of the texture\r\n   * @param height defines the height of the texture\r\n   * @param format defines the format of the data\r\n   * @param generateMipMaps defines if the engine should generate the mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\r\n   * @param compression defines the compression used (null by default)\r\n   * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\r\n   * @returns the raw texture inside an InternalTexture\r\n   */\n\n\n  ThinEngine.prototype.createRawTexture = function (data, width, height, format, generateMipMaps, invertY, samplingMode, compression, type) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (type === void 0) {\n      type = 0;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /**\r\n   * Creates a new raw cube texture\r\n   * @param data defines the array of data to use to create each face\r\n   * @param size defines the size of the textures\r\n   * @param format defines the format of the data\r\n   * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\r\n   * @param generateMipMaps  defines if the engine should generate the mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n   * @param compression defines the compression used (null by default)\r\n   * @returns the cube texture as an InternalTexture\r\n   */\n\n\n  ThinEngine.prototype.createRawCubeTexture = function (data, size, format, type, generateMipMaps, invertY, samplingMode, compression) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /**\r\n   * Creates a new raw 3D texture\r\n   * @param data defines the data used to create the texture\r\n   * @param width defines the width of the texture\r\n   * @param height defines the height of the texture\r\n   * @param depth defines the depth of the texture\r\n   * @param format defines the format of the texture\r\n   * @param generateMipMaps defines if the engine must generate mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n   * @param compression defines the compressed used (can be null)\r\n   * @param textureType defines the compressed used (can be null)\r\n   * @returns a new raw 3D texture (stored in an InternalTexture)\r\n   */\n\n\n  ThinEngine.prototype.createRawTexture3D = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (textureType === void 0) {\n      textureType = 0;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /**\r\n   * Creates a new raw 2D array texture\r\n   * @param data defines the data used to create the texture\r\n   * @param width defines the width of the texture\r\n   * @param height defines the height of the texture\r\n   * @param depth defines the number of layers of the texture\r\n   * @param format defines the format of the texture\r\n   * @param generateMipMaps defines if the engine must generate mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n   * @param compression defines the compressed used (can be null)\r\n   * @param textureType defines the compressed used (can be null)\r\n   * @returns a new raw 2D array texture (stored in an InternalTexture)\r\n   */\n\n\n  ThinEngine.prototype.createRawTexture2DArray = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (textureType === void 0) {\n      textureType = 0;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._unpackFlipY = function (value) {\n    if (this._unpackFlipYCached !== value) {\n      this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\n\n      if (this.enableUnpackFlipYCached) {\n        this._unpackFlipYCached = value;\n      }\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getUnpackAlignement = function () {\n    return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\n  };\n\n  ThinEngine.prototype._getTextureTarget = function (texture) {\n    if (texture.isCube) {\n      return this._gl.TEXTURE_CUBE_MAP;\n    } else if (texture.is3D) {\n      return this._gl.TEXTURE_3D;\n    } else if (texture.is2DArray || texture.isMultiview) {\n      return this._gl.TEXTURE_2D_ARRAY;\n    }\n\n    return this._gl.TEXTURE_2D;\n  };\n  /**\r\n   * Update the sampling mode of a given texture\r\n   * @param samplingMode defines the required sampling mode\r\n   * @param texture defines the texture to update\r\n   * @param generateMipMaps defines whether to generate mipmaps for the texture\r\n   */\n\n\n  ThinEngine.prototype.updateTextureSamplingMode = function (samplingMode, texture, generateMipMaps) {\n    if (generateMipMaps === void 0) {\n      generateMipMaps = false;\n    }\n\n    var target = this._getTextureTarget(texture);\n\n    var filters = this._getSamplingParameters(samplingMode, texture.generateMipMaps || generateMipMaps);\n\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\n\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\n\n    if (generateMipMaps) {\n      texture.generateMipMaps = true;\n\n      this._gl.generateMipmap(target);\n    }\n\n    this._bindTextureDirectly(target, null);\n\n    texture.samplingMode = samplingMode;\n  };\n  /**\r\n   * Update the sampling mode of a given texture\r\n   * @param texture defines the texture to update\r\n   * @param wrapU defines the texture wrap mode of the u coordinates\r\n   * @param wrapV defines the texture wrap mode of the v coordinates\r\n   * @param wrapR defines the texture wrap mode of the r coordinates\r\n   */\n\n\n  ThinEngine.prototype.updateTextureWrappingMode = function (texture, wrapU, wrapV, wrapR) {\n    if (wrapV === void 0) {\n      wrapV = null;\n    }\n\n    if (wrapR === void 0) {\n      wrapR = null;\n    }\n\n    var target = this._getTextureTarget(texture);\n\n    if (wrapU !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\n\n      texture._cachedWrapU = wrapU;\n    }\n\n    if (wrapV !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\n\n      texture._cachedWrapV = wrapV;\n    }\n\n    if ((texture.is2DArray || texture.is3D) && wrapR !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\n\n      texture._cachedWrapR = wrapR;\n    }\n\n    this._bindTextureDirectly(target, null);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._setupDepthStencilTexture = function (internalTexture, size, generateStencil, bilinearFiltering, comparisonFunction) {\n    var width = size.width || size;\n    var height = size.height || size;\n    var layers = size.layers || 0;\n    internalTexture.baseWidth = width;\n    internalTexture.baseHeight = height;\n    internalTexture.width = width;\n    internalTexture.height = height;\n    internalTexture.is2DArray = layers > 0;\n    internalTexture.depth = layers;\n    internalTexture.isReady = true;\n    internalTexture.samples = 1;\n    internalTexture.generateMipMaps = false;\n    internalTexture._generateDepthBuffer = true;\n    internalTexture._generateStencilBuffer = generateStencil;\n    internalTexture.samplingMode = bilinearFiltering ? 2 : 1;\n    internalTexture.type = 0;\n    internalTexture._comparisonFunction = comparisonFunction;\n    var gl = this._gl;\n\n    var target = this._getTextureTarget(internalTexture);\n\n    var samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\n\n    gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\n    gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\n    if (comparisonFunction === 0) {\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, 515);\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\n    } else {\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._uploadCompressedDataToTextureDirectly = function (texture, internalFormat, width, height, data, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, data);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._uploadDataToTextureDirectly = function (texture, imageData, faceIndex, lod, babylonInternalFormat, useTextureWidthAndHeight) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    if (useTextureWidthAndHeight === void 0) {\n      useTextureWidthAndHeight = false;\n    }\n\n    var gl = this._gl;\n\n    var textureType = this._getWebGLTextureType(texture.type);\n\n    var format = this._getInternalFormat(texture.format);\n\n    var internalFormat = babylonInternalFormat === undefined ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format) : this._getInternalFormat(babylonInternalFormat);\n\n    this._unpackFlipY(texture.invertY);\n\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    var lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\n    var lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\n    var width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\n    var height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\n    gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\n  };\n  /**\r\n   * Update a portion of an internal texture\r\n   * @param texture defines the texture to update\r\n   * @param imageData defines the data to store into the texture\r\n   * @param xOffset defines the x coordinates of the update rectangle\r\n   * @param yOffset defines the y coordinates of the update rectangle\r\n   * @param width defines the width of the update rectangle\r\n   * @param height defines the height of the update rectangle\r\n   * @param faceIndex defines the face index if texture is a cube (0 by default)\r\n   * @param lod defines the lod level to update (0 by default)\r\n   */\n\n\n  ThinEngine.prototype.updateTextureData = function (texture, imageData, xOffset, yOffset, width, height, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n\n    var textureType = this._getWebGLTextureType(texture.type);\n\n    var format = this._getInternalFormat(texture.format);\n\n    this._unpackFlipY(texture.invertY);\n\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._uploadArrayBufferViewToTexture = function (texture, imageData, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n    var bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\n\n    this._bindTextureDirectly(bindTarget, texture, true);\n\n    this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\n\n    this._bindTextureDirectly(bindTarget, null, true);\n  };\n\n  ThinEngine.prototype._prepareWebGLTextureContinuation = function (texture, scene, noMipmap, isCompressed, samplingMode) {\n    var gl = this._gl;\n\n    if (!gl) {\n      return;\n    }\n\n    var filters = this._getSamplingParameters(samplingMode, !noMipmap);\n\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\n\n    if (!noMipmap && !isCompressed) {\n      gl.generateMipmap(gl.TEXTURE_2D);\n    }\n\n    this._bindTextureDirectly(gl.TEXTURE_2D, null); // this.resetTextureCache();\n\n\n    if (scene) {\n      scene._removePendingData(texture);\n    }\n\n    texture.onLoadedObservable.notifyObservers(texture);\n    texture.onLoadedObservable.clear();\n  };\n\n  ThinEngine.prototype._prepareWebGLTexture = function (texture, scene, width, height, invertY, noMipmap, isCompressed, processFunction, samplingMode) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    var maxTextureSize = this.getCaps().maxTextureSize;\n    var potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(width, maxTextureSize) : width);\n    var potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(height, maxTextureSize) : height);\n    var gl = this._gl;\n\n    if (!gl) {\n      return;\n    }\n\n    if (!texture._webGLTexture) {\n      //  this.resetTextureCache();\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      return;\n    }\n\n    this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n    this._unpackFlipY(invertY === undefined ? true : invertY ? true : false);\n\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.width = potWidth;\n    texture.height = potHeight;\n    texture.isReady = true;\n\n    if (processFunction(potWidth, potHeight, function () {\n      _this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n    })) {\n      // Returning as texture needs extra async steps\n      return;\n    }\n\n    this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._setupFramebufferDepthAttachments = function (generateStencilBuffer, generateDepthBuffer, width, height, samples) {\n    if (samples === void 0) {\n      samples = 1;\n    }\n\n    var gl = this._gl; // Create the depth/stencil buffer\n\n    if (generateStencilBuffer && generateDepthBuffer) {\n      return this._getDepthStencilBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\n    }\n\n    if (generateDepthBuffer) {\n      var depthFormat = gl.DEPTH_COMPONENT16;\n\n      if (this._webGLVersion > 1) {\n        depthFormat = gl.DEPTH_COMPONENT32F;\n      }\n\n      return this._getDepthStencilBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\n    }\n\n    if (generateStencilBuffer) {\n      return this._getDepthStencilBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\n    }\n\n    return null;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseFramebufferObjects = function (texture) {\n    var gl = this._gl;\n\n    if (texture._framebuffer) {\n      gl.deleteFramebuffer(texture._framebuffer);\n      texture._framebuffer = null;\n    }\n\n    if (texture._depthStencilBuffer) {\n      gl.deleteRenderbuffer(texture._depthStencilBuffer);\n      texture._depthStencilBuffer = null;\n    }\n\n    if (texture._MSAAFramebuffer) {\n      gl.deleteFramebuffer(texture._MSAAFramebuffer);\n      texture._MSAAFramebuffer = null;\n    }\n\n    if (texture._MSAARenderBuffer) {\n      gl.deleteRenderbuffer(texture._MSAARenderBuffer);\n      texture._MSAARenderBuffer = null;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseTexture = function (texture) {\n    this._releaseFramebufferObjects(texture);\n\n    this._deleteTexture(texture._webGLTexture); // Unbind channels\n\n\n    this.unbindAllTextures();\n\n    var index = this._internalTexturesCache.indexOf(texture);\n\n    if (index !== -1) {\n      this._internalTexturesCache.splice(index, 1);\n    } // Integrated fixed lod samplers.\n\n\n    if (texture._lodTextureHigh) {\n      texture._lodTextureHigh.dispose();\n    }\n\n    if (texture._lodTextureMid) {\n      texture._lodTextureMid.dispose();\n    }\n\n    if (texture._lodTextureLow) {\n      texture._lodTextureLow.dispose();\n    } // Integrated irradiance map.\n\n\n    if (texture._irradianceTexture) {\n      texture._irradianceTexture.dispose();\n    }\n  };\n\n  ThinEngine.prototype._deleteTexture = function (texture) {\n    this._gl.deleteTexture(texture);\n  };\n\n  ThinEngine.prototype._setProgram = function (program) {\n    if (this._currentProgram !== program) {\n      this._gl.useProgram(program);\n\n      this._currentProgram = program;\n    }\n  };\n  /**\r\n   * Binds an effect to the webGL context\r\n   * @param effect defines the effect to bind\r\n   */\n\n\n  ThinEngine.prototype.bindSamplers = function (effect) {\n    var webGLPipelineContext = effect.getPipelineContext();\n\n    this._setProgram(webGLPipelineContext.program);\n\n    var samplers = effect.getSamplers();\n\n    for (var index = 0; index < samplers.length; index++) {\n      var uniform = effect.getUniform(samplers[index]);\n\n      if (uniform) {\n        this._boundUniforms[index] = uniform;\n      }\n    }\n\n    this._currentEffect = null;\n  };\n\n  ThinEngine.prototype._activateCurrentTexture = function () {\n    if (this._currentTextureChannel !== this._activeChannel) {\n      this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\n\n      this._currentTextureChannel = this._activeChannel;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindTextureDirectly = function (target, texture, forTextureDataUpdate, force) {\n    if (forTextureDataUpdate === void 0) {\n      forTextureDataUpdate = false;\n    }\n\n    if (force === void 0) {\n      force = false;\n    }\n\n    var wasPreviouslyBound = false;\n    var isTextureForRendering = texture && texture._associatedChannel > -1;\n\n    if (forTextureDataUpdate && isTextureForRendering) {\n      this._activeChannel = texture._associatedChannel;\n    }\n\n    var currentTextureBound = this._boundTexturesCache[this._activeChannel];\n\n    if (currentTextureBound !== texture || force) {\n      this._activateCurrentTexture();\n\n      if (texture && texture.isMultiview) {\n        this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\n      } else {\n        this._gl.bindTexture(target, texture ? texture._webGLTexture : null);\n      }\n\n      this._boundTexturesCache[this._activeChannel] = texture;\n\n      if (texture) {\n        texture._associatedChannel = this._activeChannel;\n      }\n    } else if (forTextureDataUpdate) {\n      wasPreviouslyBound = true;\n\n      this._activateCurrentTexture();\n    }\n\n    if (isTextureForRendering && !forTextureDataUpdate) {\n      this._bindSamplerUniformToChannel(texture._associatedChannel, this._activeChannel);\n    }\n\n    return wasPreviouslyBound;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindTexture = function (channel, texture) {\n    if (channel === undefined) {\n      return;\n    }\n\n    if (texture) {\n      texture._associatedChannel = channel;\n    }\n\n    this._activeChannel = channel;\n    var target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\n\n    this._bindTextureDirectly(target, texture);\n  };\n  /**\r\n   * Unbind all textures from the webGL context\r\n   */\n\n\n  ThinEngine.prototype.unbindAllTextures = function () {\n    for (var channel = 0; channel < this._maxSimultaneousTextures; channel++) {\n      this._activeChannel = channel;\n\n      this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n\n      this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n\n      if (this.webGLVersion > 1) {\n        this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n\n        this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n      }\n    }\n  };\n  /**\r\n   * Sets a texture to the according uniform.\r\n   * @param channel The texture channel\r\n   * @param uniform The uniform to set\r\n   * @param texture The texture to apply\r\n   */\n\n\n  ThinEngine.prototype.setTexture = function (channel, uniform, texture) {\n    if (channel === undefined) {\n      return;\n    }\n\n    if (uniform) {\n      this._boundUniforms[channel] = uniform;\n    }\n\n    this._setTexture(channel, texture);\n  };\n\n  ThinEngine.prototype._bindSamplerUniformToChannel = function (sourceSlot, destination) {\n    var uniform = this._boundUniforms[sourceSlot];\n\n    if (!uniform || uniform._currentState === destination) {\n      return;\n    }\n\n    this._gl.uniform1i(uniform, destination);\n\n    uniform._currentState = destination;\n  };\n\n  ThinEngine.prototype._getTextureWrapMode = function (mode) {\n    switch (mode) {\n      case 1:\n        return this._gl.REPEAT;\n\n      case 0:\n        return this._gl.CLAMP_TO_EDGE;\n\n      case 2:\n        return this._gl.MIRRORED_REPEAT;\n    }\n\n    return this._gl.REPEAT;\n  };\n\n  ThinEngine.prototype._setTexture = function (channel, texture, isPartOfTextureArray, depthStencilTexture) {\n    if (isPartOfTextureArray === void 0) {\n      isPartOfTextureArray = false;\n    }\n\n    if (depthStencilTexture === void 0) {\n      depthStencilTexture = false;\n    } // Not ready?\n\n\n    if (!texture) {\n      if (this._boundTexturesCache[channel] != null) {\n        this._activeChannel = channel;\n\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n\n        this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n\n        if (this.webGLVersion > 1) {\n          this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n\n          this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n        }\n      }\n\n      return false;\n    } // Video\n\n\n    if (texture.video) {\n      this._activeChannel = channel;\n      texture.update();\n    } else if (texture.delayLoadState === 4) {\n      // Delay loading\n      texture.delayLoad();\n      return false;\n    }\n\n    var internalTexture;\n\n    if (depthStencilTexture) {\n      internalTexture = texture.depthStencilTexture;\n    } else if (texture.isReady()) {\n      internalTexture = texture.getInternalTexture();\n    } else if (texture.isCube) {\n      internalTexture = this.emptyCubeTexture;\n    } else if (texture.is3D) {\n      internalTexture = this.emptyTexture3D;\n    } else if (texture.is2DArray) {\n      internalTexture = this.emptyTexture2DArray;\n    } else {\n      internalTexture = this.emptyTexture;\n    }\n\n    if (!isPartOfTextureArray && internalTexture) {\n      internalTexture._associatedChannel = channel;\n    }\n\n    var needToBind = true;\n\n    if (this._boundTexturesCache[channel] === internalTexture) {\n      if (!isPartOfTextureArray) {\n        this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\n      }\n\n      needToBind = false;\n    }\n\n    this._activeChannel = channel;\n\n    var target = this._getTextureTarget(internalTexture);\n\n    if (needToBind) {\n      this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\n    }\n\n    if (internalTexture && !internalTexture.isMultiview) {\n      // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\n      if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\n        internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\n        var textureWrapMode = texture.coordinatesMode !== 3 && texture.coordinatesMode !== 5 ? 1 : 0;\n        texture.wrapU = textureWrapMode;\n        texture.wrapV = textureWrapMode;\n      }\n\n      if (internalTexture._cachedWrapU !== texture.wrapU) {\n        internalTexture._cachedWrapU = texture.wrapU;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\n      }\n\n      if (internalTexture._cachedWrapV !== texture.wrapV) {\n        internalTexture._cachedWrapV = texture.wrapV;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\n      }\n\n      if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\n        internalTexture._cachedWrapR = texture.wrapR;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\n      }\n\n      this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\n    }\n\n    return true;\n  };\n  /**\r\n   * Sets an array of texture to the webGL context\r\n   * @param channel defines the channel where the texture array must be set\r\n   * @param uniform defines the associated uniform location\r\n   * @param textures defines the array of textures to bind\r\n   */\n\n\n  ThinEngine.prototype.setTextureArray = function (channel, uniform, textures) {\n    if (channel === undefined || !uniform) {\n      return;\n    }\n\n    if (!this._textureUnits || this._textureUnits.length !== textures.length) {\n      this._textureUnits = new Int32Array(textures.length);\n    }\n\n    for (var i = 0; i < textures.length; i++) {\n      var texture = textures[i].getInternalTexture();\n\n      if (texture) {\n        this._textureUnits[i] = channel + i;\n        texture._associatedChannel = channel + i;\n      } else {\n        this._textureUnits[i] = -1;\n      }\n    }\n\n    this._gl.uniform1iv(uniform, this._textureUnits);\n\n    for (var index = 0; index < textures.length; index++) {\n      this._setTexture(this._textureUnits[index], textures[index], true);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._setAnisotropicLevel = function (target, internalTexture, anisotropicFilteringLevel) {\n    var anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\n\n    if (internalTexture.samplingMode !== 11 && internalTexture.samplingMode !== 3 && internalTexture.samplingMode !== 2) {\n      anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\n    }\n\n    if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\n      this._setTextureParameterFloat(target, anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT, Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy), internalTexture);\n\n      internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\n    }\n  };\n\n  ThinEngine.prototype._setTextureParameterFloat = function (target, parameter, value, texture) {\n    this._bindTextureDirectly(target, texture, true, true);\n\n    this._gl.texParameterf(target, parameter, value);\n  };\n\n  ThinEngine.prototype._setTextureParameterInteger = function (target, parameter, value, texture) {\n    if (texture) {\n      this._bindTextureDirectly(target, texture, true, true);\n    }\n\n    this._gl.texParameteri(target, parameter, value);\n  };\n  /**\r\n   * Unbind all vertex attributes from the webGL context\r\n   */\n\n\n  ThinEngine.prototype.unbindAllAttributes = function () {\n    if (this._mustWipeVertexAttributes) {\n      this._mustWipeVertexAttributes = false;\n\n      for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\n        this.disableAttributeByIndex(i);\n      }\n\n      return;\n    }\n\n    for (var i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\n      if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\n        continue;\n      }\n\n      this.disableAttributeByIndex(i);\n    }\n  };\n  /**\r\n   * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\r\n   */\n\n\n  ThinEngine.prototype.releaseEffects = function () {\n    for (var name in this._compiledEffects) {\n      var webGLPipelineContext = this._compiledEffects[name].getPipelineContext();\n\n      this._deletePipelineContext(webGLPipelineContext);\n    }\n\n    this._compiledEffects = {};\n  };\n  /**\r\n   * Dispose and release all associated resources\r\n   */\n\n\n  ThinEngine.prototype.dispose = function () {\n    this.stopRenderLoop(); // Clear observables\n\n    if (this.onBeforeTextureInitObservable) {\n      this.onBeforeTextureInitObservable.clear();\n    } // Empty texture\n\n\n    if (this._emptyTexture) {\n      this._releaseTexture(this._emptyTexture);\n\n      this._emptyTexture = null;\n    }\n\n    if (this._emptyCubeTexture) {\n      this._releaseTexture(this._emptyCubeTexture);\n\n      this._emptyCubeTexture = null;\n    }\n\n    if (this._dummyFramebuffer) {\n      this._gl.deleteFramebuffer(this._dummyFramebuffer);\n    } // Release effects\n\n\n    this.releaseEffects(); // Unbind\n\n    this.unbindAllAttributes();\n    this._boundUniforms = []; // Events\n\n    if (DomManagement.IsWindowObjectExist()) {\n      if (this._renderingCanvas) {\n        if (!this._doNotHandleContextLost) {\n          this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\n\n          this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\n        }\n      }\n    }\n\n    this._workingCanvas = null;\n    this._workingContext = null;\n    this._currentBufferPointers = [];\n    this._renderingCanvas = null;\n    this._currentProgram = null;\n    this._boundRenderFunction = null;\n    Effect.ResetCache(); // Abort active requests\n\n    for (var _i = 0, _a = this._activeRequests; _i < _a.length; _i++) {\n      var request = _a[_i];\n      request.abort();\n    }\n  };\n  /**\r\n   * Attach a new callback raised when context lost event is fired\r\n   * @param callback defines the callback to call\r\n   */\n\n\n  ThinEngine.prototype.attachContextLostEvent = function (callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextlost\", callback, false);\n    }\n  };\n  /**\r\n   * Attach a new callback raised when context restored event is fired\r\n   * @param callback defines the callback to call\r\n   */\n\n\n  ThinEngine.prototype.attachContextRestoredEvent = function (callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextrestored\", callback, false);\n    }\n  };\n  /**\r\n   * Get the current error code of the webGL context\r\n   * @returns the error code\r\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\r\n   */\n\n\n  ThinEngine.prototype.getError = function () {\n    return this._gl.getError();\n  };\n\n  ThinEngine.prototype._canRenderToFloatFramebuffer = function () {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n\n    return this._canRenderToFramebuffer(1);\n  };\n\n  ThinEngine.prototype._canRenderToHalfFloatFramebuffer = function () {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n\n    return this._canRenderToFramebuffer(2);\n  }; // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\n\n\n  ThinEngine.prototype._canRenderToFramebuffer = function (type) {\n    var gl = this._gl; //clear existing errors\n\n    while (gl.getError() !== gl.NO_ERROR) {}\n\n    var successful = true;\n    var texture = gl.createTexture();\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n    var fb = gl.createFramebuffer();\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n    var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n    successful = successful && status === gl.FRAMEBUFFER_COMPLETE;\n    successful = successful && gl.getError() === gl.NO_ERROR; //try render by clearing frame buffer's color buffer\n\n    if (successful) {\n      gl.clear(gl.COLOR_BUFFER_BIT);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    } //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\n\n\n    if (successful) {\n      //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n      var readFormat = gl.RGBA;\n      var readType = gl.UNSIGNED_BYTE;\n      var buffer = new Uint8Array(4);\n      gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    } //clean up\n\n\n    gl.deleteTexture(texture);\n    gl.deleteFramebuffer(fb);\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null); //clear accumulated errors\n\n    while (!successful && gl.getError() !== gl.NO_ERROR) {}\n\n    return successful;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getWebGLTextureType = function (type) {\n    if (this._webGLVersion === 1) {\n      switch (type) {\n        case 1:\n          return this._gl.FLOAT;\n\n        case 2:\n          return this._gl.HALF_FLOAT_OES;\n\n        case 0:\n          return this._gl.UNSIGNED_BYTE;\n\n        case 8:\n          return this._gl.UNSIGNED_SHORT_4_4_4_4;\n\n        case 9:\n          return this._gl.UNSIGNED_SHORT_5_5_5_1;\n\n        case 10:\n          return this._gl.UNSIGNED_SHORT_5_6_5;\n      }\n\n      return this._gl.UNSIGNED_BYTE;\n    }\n\n    switch (type) {\n      case 3:\n        return this._gl.BYTE;\n\n      case 0:\n        return this._gl.UNSIGNED_BYTE;\n\n      case 4:\n        return this._gl.SHORT;\n\n      case 5:\n        return this._gl.UNSIGNED_SHORT;\n\n      case 6:\n        return this._gl.INT;\n\n      case 7:\n        // Refers to UNSIGNED_INT\n        return this._gl.UNSIGNED_INT;\n\n      case 1:\n        return this._gl.FLOAT;\n\n      case 2:\n        return this._gl.HALF_FLOAT;\n\n      case 8:\n        return this._gl.UNSIGNED_SHORT_4_4_4_4;\n\n      case 9:\n        return this._gl.UNSIGNED_SHORT_5_5_5_1;\n\n      case 10:\n        return this._gl.UNSIGNED_SHORT_5_6_5;\n\n      case 11:\n        return this._gl.UNSIGNED_INT_2_10_10_10_REV;\n\n      case 12:\n        return this._gl.UNSIGNED_INT_24_8;\n\n      case 13:\n        return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\n\n      case 14:\n        return this._gl.UNSIGNED_INT_5_9_9_9_REV;\n\n      case 15:\n        return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\n    }\n\n    return this._gl.UNSIGNED_BYTE;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getInternalFormat = function (format) {\n    var internalFormat = this._gl.RGBA;\n\n    switch (format) {\n      case 0:\n        internalFormat = this._gl.ALPHA;\n        break;\n\n      case 1:\n        internalFormat = this._gl.LUMINANCE;\n        break;\n\n      case 2:\n        internalFormat = this._gl.LUMINANCE_ALPHA;\n        break;\n\n      case 6:\n        internalFormat = this._gl.RED;\n        break;\n\n      case 7:\n        internalFormat = this._gl.RG;\n        break;\n\n      case 4:\n        internalFormat = this._gl.RGB;\n        break;\n\n      case 5:\n        internalFormat = this._gl.RGBA;\n        break;\n    }\n\n    if (this._webGLVersion > 1) {\n      switch (format) {\n        case 8:\n          internalFormat = this._gl.RED_INTEGER;\n          break;\n\n        case 9:\n          internalFormat = this._gl.RG_INTEGER;\n          break;\n\n        case 10:\n          internalFormat = this._gl.RGB_INTEGER;\n          break;\n\n        case 11:\n          internalFormat = this._gl.RGBA_INTEGER;\n          break;\n      }\n    }\n\n    return internalFormat;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getRGBABufferInternalSizedFormat = function (type, format) {\n    if (this._webGLVersion === 1) {\n      if (format !== undefined) {\n        switch (format) {\n          case 0:\n            return this._gl.ALPHA;\n\n          case 1:\n            return this._gl.LUMINANCE;\n\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n\n          case 4:\n            return this._gl.RGB;\n        }\n      }\n\n      return this._gl.RGBA;\n    }\n\n    switch (type) {\n      case 3:\n        switch (format) {\n          case 6:\n            return this._gl.R8_SNORM;\n\n          case 7:\n            return this._gl.RG8_SNORM;\n\n          case 4:\n            return this._gl.RGB8_SNORM;\n\n          case 8:\n            return this._gl.R8I;\n\n          case 9:\n            return this._gl.RG8I;\n\n          case 10:\n            return this._gl.RGB8I;\n\n          case 11:\n            return this._gl.RGBA8I;\n\n          default:\n            return this._gl.RGBA8_SNORM;\n        }\n\n      case 0:\n        switch (format) {\n          case 6:\n            return this._gl.R8;\n\n          case 7:\n            return this._gl.RG8;\n\n          case 4:\n            return this._gl.RGB8;\n          // By default. Other possibilities are RGB565, SRGB8.\n\n          case 5:\n            return this._gl.RGBA8;\n          // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\n\n          case 8:\n            return this._gl.R8UI;\n\n          case 9:\n            return this._gl.RG8UI;\n\n          case 10:\n            return this._gl.RGB8UI;\n\n          case 11:\n            return this._gl.RGBA8UI;\n\n          case 0:\n            return this._gl.ALPHA;\n\n          case 1:\n            return this._gl.LUMINANCE;\n\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n\n          default:\n            return this._gl.RGBA8;\n        }\n\n      case 4:\n        switch (format) {\n          case 8:\n            return this._gl.R16I;\n\n          case 9:\n            return this._gl.RG16I;\n\n          case 10:\n            return this._gl.RGB16I;\n\n          case 11:\n            return this._gl.RGBA16I;\n\n          default:\n            return this._gl.RGBA16I;\n        }\n\n      case 5:\n        switch (format) {\n          case 8:\n            return this._gl.R16UI;\n\n          case 9:\n            return this._gl.RG16UI;\n\n          case 10:\n            return this._gl.RGB16UI;\n\n          case 11:\n            return this._gl.RGBA16UI;\n\n          default:\n            return this._gl.RGBA16UI;\n        }\n\n      case 6:\n        switch (format) {\n          case 8:\n            return this._gl.R32I;\n\n          case 9:\n            return this._gl.RG32I;\n\n          case 10:\n            return this._gl.RGB32I;\n\n          case 11:\n            return this._gl.RGBA32I;\n\n          default:\n            return this._gl.RGBA32I;\n        }\n\n      case 7:\n        // Refers to UNSIGNED_INT\n        switch (format) {\n          case 8:\n            return this._gl.R32UI;\n\n          case 9:\n            return this._gl.RG32UI;\n\n          case 10:\n            return this._gl.RGB32UI;\n\n          case 11:\n            return this._gl.RGBA32UI;\n\n          default:\n            return this._gl.RGBA32UI;\n        }\n\n      case 1:\n        switch (format) {\n          case 6:\n            return this._gl.R32F;\n          // By default. Other possibility is R16F.\n\n          case 7:\n            return this._gl.RG32F;\n          // By default. Other possibility is RG16F.\n\n          case 4:\n            return this._gl.RGB32F;\n          // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\n\n          case 5:\n            return this._gl.RGBA32F;\n          // By default. Other possibility is RGBA16F.\n\n          default:\n            return this._gl.RGBA32F;\n        }\n\n      case 2:\n        switch (format) {\n          case 6:\n            return this._gl.R16F;\n\n          case 7:\n            return this._gl.RG16F;\n\n          case 4:\n            return this._gl.RGB16F;\n          // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\n\n          case 5:\n            return this._gl.RGBA16F;\n\n          default:\n            return this._gl.RGBA16F;\n        }\n\n      case 10:\n        return this._gl.RGB565;\n\n      case 13:\n        return this._gl.R11F_G11F_B10F;\n\n      case 14:\n        return this._gl.RGB9_E5;\n\n      case 8:\n        return this._gl.RGBA4;\n\n      case 9:\n        return this._gl.RGB5_A1;\n\n      case 11:\n        switch (format) {\n          case 5:\n            return this._gl.RGB10_A2;\n          // By default. Other possibility is RGB5_A1.\n\n          case 11:\n            return this._gl.RGB10_A2UI;\n\n          default:\n            return this._gl.RGB10_A2;\n        }\n\n    }\n\n    return this._gl.RGBA8;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getRGBAMultiSampleBufferFormat = function (type) {\n    if (type === 1) {\n      return this._gl.RGBA32F;\n    } else if (type === 2) {\n      return this._gl.RGBA16F;\n    }\n\n    return this._gl.RGBA8;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._loadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    var _this = this;\n\n    var request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\n\n    this._activeRequests.push(request);\n\n    request.onCompleteObservable.add(function (request) {\n      _this._activeRequests.splice(_this._activeRequests.indexOf(request), 1);\n    });\n    return request;\n  };\n  /**\r\n   * Loads a file from a url\r\n   * @param url url to load\r\n   * @param onSuccess callback called when the file successfully loads\r\n   * @param onProgress callback called while file is loading (if the server supports this mode)\r\n   * @param offlineProvider defines the offline provider for caching\r\n   * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\r\n   * @param onError callback called when the file fails to load\r\n   * @returns a file request object\r\n   * @hidden\r\n   */\n\n\n  ThinEngine._FileToolsLoadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    throw _DevTools.WarnImport(\"FileTools\");\n  };\n  /**\r\n   * Reads pixels from the current frame buffer. Please note that this function can be slow\r\n   * @param x defines the x coordinate of the rectangle where pixels must be read\r\n   * @param y defines the y coordinate of the rectangle where pixels must be read\r\n   * @param width defines the width of the rectangle where pixels must be read\r\n   * @param height defines the height of the rectangle where pixels must be read\r\n   * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\r\n   * @returns a Uint8Array containing RGBA colors\r\n   */\n\n\n  ThinEngine.prototype.readPixels = function (x, y, width, height, hasAlpha) {\n    if (hasAlpha === void 0) {\n      hasAlpha = true;\n    }\n\n    var numChannels = hasAlpha ? 4 : 3;\n    var format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\n    var data = new Uint8Array(height * width * numChannels);\n\n    this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\n\n    return data;\n  };\n\n  Object.defineProperty(ThinEngine, \"IsSupported\", {\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n     */\n    get: function () {\n      return this.isSupported(); // Backward compat\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\r\n   * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n   * @returns true if the engine can be created\r\n   * @ignorenaming\r\n   */\n\n  ThinEngine.isSupported = function () {\n    if (this._HasMajorPerformanceCaveat !== null) {\n      return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\n    }\n\n    if (this._IsSupported === null) {\n      try {\n        var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\n        var gl = tempcanvas.getContext(\"webgl\") || tempcanvas.getContext(\"experimental-webgl\");\n        this._IsSupported = gl != null && !!window.WebGLRenderingContext;\n      } catch (e) {\n        this._IsSupported = false;\n      }\n    }\n\n    return this._IsSupported;\n  };\n\n  Object.defineProperty(ThinEngine, \"HasMajorPerformanceCaveat\", {\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\r\n     */\n    get: function () {\n      if (this._HasMajorPerformanceCaveat === null) {\n        try {\n          var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\n          var gl = tempcanvas.getContext(\"webgl\", {\n            failIfMajorPerformanceCaveat: true\n          }) || tempcanvas.getContext(\"experimental-webgl\", {\n            failIfMajorPerformanceCaveat: true\n          });\n          this._HasMajorPerformanceCaveat = !gl;\n        } catch (e) {\n          this._HasMajorPerformanceCaveat = false;\n        }\n      }\n\n      return this._HasMajorPerformanceCaveat;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\r\n   * Find the next highest power of two.\r\n   * @param x Number to start search from.\r\n   * @return Next highest power of two.\r\n   */\n\n  ThinEngine.CeilingPOT = function (x) {\n    x--;\n    x |= x >> 1;\n    x |= x >> 2;\n    x |= x >> 4;\n    x |= x >> 8;\n    x |= x >> 16;\n    x++;\n    return x;\n  };\n  /**\r\n   * Find the next lowest power of two.\r\n   * @param x Number to start search from.\r\n   * @return Next lowest power of two.\r\n   */\n\n\n  ThinEngine.FloorPOT = function (x) {\n    x = x | x >> 1;\n    x = x | x >> 2;\n    x = x | x >> 4;\n    x = x | x >> 8;\n    x = x | x >> 16;\n    return x - (x >> 1);\n  };\n  /**\r\n   * Find the nearest power of two.\r\n   * @param x Number to start search from.\r\n   * @return Next nearest power of two.\r\n   */\n\n\n  ThinEngine.NearestPOT = function (x) {\n    var c = ThinEngine.CeilingPOT(x);\n    var f = ThinEngine.FloorPOT(x);\n    return c - x > x - f ? f : c;\n  };\n  /**\r\n   * Get the closest exponent of two\r\n   * @param value defines the value to approximate\r\n   * @param max defines the maximum value to return\r\n   * @param mode defines how to define the closest value\r\n   * @returns closest exponent of two of the given value\r\n   */\n\n\n  ThinEngine.GetExponentOfTwo = function (value, max, mode) {\n    if (mode === void 0) {\n      mode = 2;\n    }\n\n    var pot;\n\n    switch (mode) {\n      case 1:\n        pot = ThinEngine.FloorPOT(value);\n        break;\n\n      case 2:\n        pot = ThinEngine.NearestPOT(value);\n        break;\n\n      case 3:\n      default:\n        pot = ThinEngine.CeilingPOT(value);\n        break;\n    }\n\n    return Math.min(pot, max);\n  };\n  /**\r\n   * Queue a new function into the requested animation frame pool (ie. this function will be executed byt the browser for the next frame)\r\n   * @param func - the function to be called\r\n   * @param requester - the object that will request the next frame. Falls back to window.\r\n   * @returns frame number\r\n   */\n\n\n  ThinEngine.QueueNewFrame = function (func, requester) {\n    if (!DomManagement.IsWindowObjectExist()) {\n      if (typeof requestAnimationFrame !== \"undefined\") {\n        return requestAnimationFrame(func);\n      }\n\n      return setTimeout(func, 16);\n    }\n\n    if (!requester) {\n      requester = window;\n    }\n\n    if (requester.requestPostAnimationFrame) {\n      return requester.requestPostAnimationFrame(func);\n    } else if (requester.requestAnimationFrame) {\n      return requester.requestAnimationFrame(func);\n    } else if (requester.msRequestAnimationFrame) {\n      return requester.msRequestAnimationFrame(func);\n    } else if (requester.webkitRequestAnimationFrame) {\n      return requester.webkitRequestAnimationFrame(func);\n    } else if (requester.mozRequestAnimationFrame) {\n      return requester.mozRequestAnimationFrame(func);\n    } else if (requester.oRequestAnimationFrame) {\n      return requester.oRequestAnimationFrame(func);\n    } else {\n      return window.setTimeout(func, 16);\n    }\n  };\n  /**\r\n   * Gets host document\r\n   * @returns the host document object\r\n   */\n\n\n  ThinEngine.prototype.getHostDocument = function () {\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\n      return this._renderingCanvas.ownerDocument;\n    }\n\n    return document;\n  };\n  /** Use this array to turn off some WebGL2 features on known buggy browsers version */\n\n\n  ThinEngine.ExceptionList = [{\n    key: \"Chrome\\/63\\.0\",\n    capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\",\n    captureConstraint: 108,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Firefox\\/58\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Firefox\\/59\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Chrome\\/72.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Chrome\\/73.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Chrome\\/74.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Mac OS.+Chrome\\/71\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Mac OS.+Chrome\\/72\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }];\n  /** @hidden */\n\n  ThinEngine._TextureLoaders = []; // Updatable statics so stick with vars here\n\n  /**\r\n   * Gets or sets the epsilon value used by collision engine\r\n   */\n\n  ThinEngine.CollisionsEpsilon = 0.001; // Statics\n\n  ThinEngine._IsSupported = null;\n  ThinEngine._HasMajorPerformanceCaveat = null;\n  return ThinEngine;\n}();\n\nexport { ThinEngine };","map":{"version":3,"sources":["../../../sourceES6/core/Engines/thinEngine.ts"],"names":[],"mappings":"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","sourcesContent":["import { EngineStore } from './engineStore';\r\nimport { IInternalTextureLoader } from '../Materials/Textures/internalTextureLoader';\r\nimport { Effect, IEffectCreationOptions } from '../Materials/effect';\r\nimport { _DevTools } from '../Misc/devTools';\r\nimport { IShaderProcessor } from './Processors/iShaderProcessor';\r\nimport { UniformBuffer } from '../Materials/uniformBuffer';\r\nimport { Nullable, DataArray, IndicesArray } from '../types';\r\nimport { EngineCapabilities } from './engineCapabilities';\r\nimport { Observable } from '../Misc/observable';\r\nimport { DepthCullingState } from '../States/depthCullingState';\r\nimport { StencilState } from '../States/stencilState';\r\nimport { AlphaState } from '../States/alphaCullingState';\r\n\r\nimport { InternalTexture, InternalTextureSource } from '../Materials/Textures/internalTexture';\r\nimport { IViewportLike, IColor4Like } from '../Maths/math.like';\r\nimport { DataBuffer } from '../Meshes/dataBuffer';\r\nimport { IFileRequest } from '../Misc/fileRequest';\r\nimport { Logger } from '../Misc/logger';\r\nimport { DomManagement } from '../Misc/domManagement';\r\nimport { WebGLShaderProcessor } from './WebGL/webGLShaderProcessors';\r\nimport { WebGL2ShaderProcessor } from './WebGL/webGL2ShaderProcessors';\r\nimport { WebGLDataBuffer } from '../Meshes/WebGL/webGLDataBuffer';\r\nimport { IPipelineContext } from './IPipelineContext';\r\nimport { WebGLPipelineContext } from './WebGL/webGLPipelineContext';\r\nimport { VertexBuffer } from '../Meshes/buffer';\r\nimport { InstancingAttributeInfo } from './instancingAttributeInfo';\r\nimport { ThinTexture } from '../Materials/Textures/thinTexture';\r\nimport { IOfflineProvider } from '../Offline/IOfflineProvider';\r\nimport { IEffectFallbacks } from '../Materials/iEffectFallbacks';\r\nimport { IWebRequest } from '../Misc/interfaces/iWebRequest';\r\nimport { CanvasGenerator } from '../Misc/canvasGenerator';\r\nimport { PerformanceConfigurator } from './performanceConfigurator';\r\n\r\ndeclare type WebRequest = import(\"../Misc/webRequest\").WebRequest;\r\ndeclare type LoadFileError = import(\"../Misc/fileTools\").LoadFileError;\r\ndeclare type Observer<T> = import(\"../Misc/observable\").Observer<T>;\r\ndeclare type VideoTexture = import(\"../Materials/Textures/videoTexture\").VideoTexture;\r\ndeclare type RenderTargetTexture = import(\"../Materials/Textures/renderTargetTexture\").RenderTargetTexture;\r\ndeclare type Texture = import(\"../Materials/Textures/texture\").Texture;\r\n\r\n/**\r\n * Defines the interface used by objects working like Scene\r\n * @hidden\r\n */\r\nexport interface ISceneLike {\r\n    _addPendingData(data: any): void;\r\n    _removePendingData(data: any): void;\r\n    offlineProvider: IOfflineProvider;\r\n}\r\n\r\n/**\r\n * Keeps track of all the buffer info used in engine.\r\n */\r\nclass BufferPointer {\r\n    public active: boolean;\r\n    public index: number;\r\n    public size: number;\r\n    public type: number;\r\n    public normalized: boolean;\r\n    public stride: number;\r\n    public offset: number;\r\n    public buffer: WebGLBuffer;\r\n}\r\n\r\n/**\r\n * Information about the current host\r\n */\r\nexport interface HostInformation {\r\n    /**\r\n     * Defines if the current host is a mobile\r\n     */\r\n    isMobile: boolean;\r\n}\r\n\r\n/** Interface defining initialization parameters for Engine class */\r\nexport interface EngineOptions extends WebGLContextAttributes {\r\n    /**\r\n     * Defines if the engine should no exceed a specified device ratio\r\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio\r\n     */\r\n    limitDeviceRatio?: number;\r\n    /**\r\n     * Defines if webvr should be enabled automatically\r\n     * @see https://doc.babylonjs.com/how_to/webvr_camera\r\n     */\r\n    autoEnableWebVR?: boolean;\r\n    /**\r\n     * Defines if webgl2 should be turned off even if supported\r\n     * @see https://doc.babylonjs.com/features/webgl2\r\n     */\r\n    disableWebGL2Support?: boolean;\r\n    /**\r\n     * Defines if webaudio should be initialized as well\r\n     * @see https://doc.babylonjs.com/how_to/playing_sounds_and_music\r\n     */\r\n    audioEngine?: boolean;\r\n    /**\r\n     * Defines if animations should run using a deterministic lock step\r\n     * @see https://doc.babylonjs.com/babylon101/animations#deterministic-lockstep\r\n     */\r\n    deterministicLockstep?: boolean;\r\n    /** Defines the maximum steps to use with deterministic lock step mode */\r\n    lockstepMaxSteps?: number;\r\n    /** Defines the seconds between each deterministic lock step */\r\n    timeStep?: number;\r\n    /**\r\n     * Defines that engine should ignore context lost events\r\n     * If this event happens when this parameter is true, you will have to reload the page to restore rendering\r\n     */\r\n\r\n    doNotHandleContextLost?: boolean;\r\n    /**\r\n     * Defines that engine should ignore modifying touch action attribute and style\r\n     * If not handle, you might need to set it up on your side for expected touch devices behavior.\r\n     */\r\n    doNotHandleTouchAction?: boolean;\r\n    /**\r\n     * Defines that engine should compile shaders with high precision floats (if supported). True by default\r\n     */\r\n    useHighPrecisionFloats?: boolean;\r\n    /**\r\n     * Make the canvas XR Compatible for XR sessions\r\n     */\r\n    xrCompatible?: boolean;\r\n\r\n    /**\r\n     * Make the matrix computations to be performed in 64 bits instead of 32 bits. False by default\r\n     */\r\n    useHighPrecisionMatrix?: boolean;\r\n\r\n    /**\r\n     * Will prevent the system from falling back to software implementation if a hardware device cannot be created\r\n     */\r\n    failIfMajorPerformanceCaveat?: boolean;\r\n}\r\n\r\n/**\r\n * The base engine class (root of all engines)\r\n */\r\nexport class ThinEngine {\r\n    /** Use this array to turn off some WebGL2 features on known buggy browsers version */\r\n    public static ExceptionList = [\r\n        { key: \"Chrome\\/63\\.0\", capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\", captureConstraint: 108, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox\\/58\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox\\/59\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Chrome\\/72.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome\\/73.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome\\/74.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome\\/71\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome\\/72\", capture: null, captureConstraint: null, targets: [\"vao\"] }\r\n    ];\r\n\r\n    /** @hidden */\r\n    public static _TextureLoaders: IInternalTextureLoader[] = [];\r\n\r\n    /**\r\n     * Returns the current npm package of the sdk\r\n     */\r\n    // Not mixed with Version for tooling purpose.\r\n    public static get NpmPackage(): string {\r\n        return \"babylonjs@4.2.0\";\r\n    }\r\n\r\n    /**\r\n     * Returns the current version of the framework\r\n     */\r\n    public static get Version(): string {\r\n        return \"4.2.0\";\r\n    }\r\n\r\n    /**\r\n     * Returns a string describing the current engine\r\n     */\r\n    public get description(): string {\r\n        let description = \"WebGL\" + this.webGLVersion;\r\n\r\n        if (this._caps.parallelShaderCompile) {\r\n            description += \" - Parallel shader compilation\";\r\n        }\r\n\r\n        return description;\r\n    }\r\n\r\n    // Updatable statics so stick with vars here\r\n\r\n    /**\r\n     * Gets or sets the epsilon value used by collision engine\r\n     */\r\n    public static CollisionsEpsilon = 0.001;\r\n\r\n    /**\r\n     * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\r\n     */\r\n    public static get ShadersRepository(): string {\r\n        return Effect.ShadersRepository;\r\n    }\r\n    public static set ShadersRepository(value: string) {\r\n        Effect.ShadersRepository = value;\r\n    }\r\n\r\n    // Public members\r\n\r\n    /** @hidden */\r\n    public _shaderProcessor: IShaderProcessor;\r\n\r\n    /**\r\n     * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\r\n     */\r\n    public forcePOTTextures = false;\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\r\n     */\r\n    public isFullscreen = false;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if back faces must be culled (true by default)\r\n     */\r\n    public cullBackFaces = true;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foregroun\r\n     */\r\n    public renderEvenInBackground = true;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that cache can be kept between frames\r\n     */\r\n    public preventCacheWipeBetweenFrames = false;\r\n\r\n    /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\r\n    public validateShaderPrograms = false;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\r\n     * This can provide greater z depth for distant objects.\r\n     */\r\n    public useReverseDepthBuffer = false;\r\n    // Uniform buffers list\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\r\n     */\r\n    public disableUniformBuffers = false;\r\n\r\n    /** @hidden */\r\n    public _uniformBuffers = new Array<UniformBuffer>();\r\n\r\n    /**\r\n     * Gets a boolean indicating that the engine supports uniform buffers\r\n     * @see https://doc.babylonjs.com/features/webgl2#uniform-buffer-objets\r\n     */\r\n    public get supportsUniformBuffers(): boolean {\r\n        return this.webGLVersion > 1 && !this.disableUniformBuffers;\r\n    }\r\n\r\n    // Private Members\r\n\r\n    /** @hidden */\r\n    public _gl: WebGLRenderingContext;\r\n    /** @hidden */\r\n    public _webGLVersion = 1.0;\r\n    protected _renderingCanvas: Nullable<HTMLCanvasElement>;\r\n    protected _windowIsBackground = false;\r\n    protected _creationOptions: EngineOptions;\r\n\r\n    protected _highPrecisionShadersAllowed = true;\r\n    /** @hidden */\r\n    public get _shouldUseHighPrecisionShader(): boolean {\r\n        return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating that only power of 2 textures are supported\r\n     * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\r\n     */\r\n    public get needPOTTextures(): boolean {\r\n        return this._webGLVersion < 2 || this.forcePOTTextures;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _badOS = false;\r\n\r\n    /** @hidden */\r\n    public _badDesktopOS = false;\r\n\r\n    private _hardwareScalingLevel: number;\r\n    /** @hidden */\r\n    public _caps: EngineCapabilities;\r\n    private _isStencilEnable: boolean;\r\n\r\n    private _glVersion: string;\r\n    private _glRenderer: string;\r\n    private _glVendor: string;\r\n\r\n    /** @hidden */\r\n    public _videoTextureSupported: boolean;\r\n\r\n    protected _renderingQueueLaunched = false;\r\n    protected _activeRenderLoops = new Array<() => void>();\r\n\r\n    // Lost context\r\n    /**\r\n     * Observable signaled when a context lost event is raised\r\n     */\r\n    public onContextLostObservable = new Observable<ThinEngine>();\r\n    /**\r\n     * Observable signaled when a context restored event is raised\r\n     */\r\n    public onContextRestoredObservable = new Observable<ThinEngine>();\r\n    private _onContextLost: (evt: Event) => void;\r\n    private _onContextRestored: (evt: Event) => void;\r\n    protected _contextWasLost = false;\r\n\r\n    /** @hidden */\r\n    public _doNotHandleContextLost = false;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\r\n     * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#handling-webgl-context-lost\r\n     */\r\n    public get doNotHandleContextLost(): boolean {\r\n        return this._doNotHandleContextLost;\r\n    }\r\n\r\n    public set doNotHandleContextLost(value: boolean) {\r\n        this._doNotHandleContextLost = value;\r\n    }\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\r\n     */\r\n    public disableVertexArrayObjects = false;\r\n\r\n    // States\r\n    /** @hidden */\r\n    protected _colorWrite = true;\r\n    /** @hidden */\r\n    protected _colorWriteChanged = true;\r\n    /** @hidden */\r\n    protected _depthCullingState = new DepthCullingState();\r\n    /** @hidden */\r\n    protected _stencilState = new StencilState();\r\n    /** @hidden */\r\n    public _alphaState = new AlphaState();\r\n    /** @hidden */\r\n    public _alphaMode = 1;\r\n    /** @hidden */\r\n    public _alphaEquation = 0;\r\n\r\n    // Cache\r\n    /** @hidden */\r\n    public _internalTexturesCache = new Array<InternalTexture>();\r\n    /** @hidden */\r\n    protected _activeChannel = 0;\r\n    private _currentTextureChannel = -1;\r\n    /** @hidden */\r\n    protected _boundTexturesCache: { [key: string]: Nullable<InternalTexture> } = {};\r\n    /** @hidden */\r\n    protected _currentEffect: Nullable<Effect>;\r\n    /** @hidden */\r\n    protected _currentProgram: Nullable<WebGLProgram>;\r\n    private _compiledEffects: { [key: string]: Effect } = {};\r\n    private _vertexAttribArraysEnabled: boolean[] = [];\r\n    /** @hidden */\r\n    protected _cachedViewport: Nullable<IViewportLike>;\r\n    private _cachedVertexArrayObject: Nullable<WebGLVertexArrayObject>;\r\n    /** @hidden */\r\n    protected _cachedVertexBuffers: any;\r\n    /** @hidden */\r\n    protected _cachedIndexBuffer: Nullable<DataBuffer>;\r\n    /** @hidden */\r\n    protected _cachedEffectForVertexBuffers: Nullable<Effect>;\r\n    /** @hidden */\r\n    public _currentRenderTarget: Nullable<InternalTexture>;\r\n    private _uintIndicesCurrentlySet = false;\r\n    protected _currentBoundBuffer = new Array<Nullable<WebGLBuffer>>();\r\n    /** @hidden */\r\n    public _currentFramebuffer: Nullable<WebGLFramebuffer> = null;\r\n    /** @hidden */\r\n    public _dummyFramebuffer: Nullable<WebGLFramebuffer> = null;\r\n    private _currentBufferPointers = new Array<BufferPointer>();\r\n    private _currentInstanceLocations = new Array<number>();\r\n    private _currentInstanceBuffers = new Array<DataBuffer>();\r\n    private _textureUnits: Int32Array;\r\n\r\n    /** @hidden */\r\n    public _workingCanvas: Nullable<HTMLCanvasElement | OffscreenCanvas>;\r\n    /** @hidden */\r\n    public _workingContext: Nullable<CanvasRenderingContext2D | OffscreenCanvasRenderingContext2D>;\r\n\r\n    /** @hidden */\r\n    public _boundRenderFunction: any;\r\n\r\n    private _vaoRecordInProgress = false;\r\n    private _mustWipeVertexAttributes = false;\r\n\r\n    private _emptyTexture: Nullable<InternalTexture>;\r\n    private _emptyCubeTexture: Nullable<InternalTexture>;\r\n    private _emptyTexture3D: Nullable<InternalTexture>;\r\n    private _emptyTexture2DArray: Nullable<InternalTexture>;\r\n\r\n    /** @hidden */\r\n    public _frameHandler: number;\r\n\r\n    private _nextFreeTextureSlots = new Array<number>();\r\n    private _maxSimultaneousTextures = 0;\r\n\r\n    private _activeRequests = new Array<IFileRequest>();\r\n\r\n    /** @hidden */\r\n    public _transformTextureUrl: Nullable<(url: string) => string> = null;\r\n\r\n    /**\r\n     * Gets information about the current host\r\n     */\r\n    public hostInformation: HostInformation = {\r\n        isMobile: false\r\n    };\r\n\r\n    protected get _supportsHardwareTextureRescaling() {\r\n        return false;\r\n    }\r\n\r\n    private _framebufferDimensionsObject: Nullable<{framebufferWidth: number, framebufferHeight: number}>;\r\n\r\n    /**\r\n     * sets the object from which width and height will be taken from when getting render width and height\r\n     * Will fallback to the gl object\r\n     * @param dimensions the framebuffer width and height that will be used.\r\n     */\r\n    public set framebufferDimensionsObject(dimensions: Nullable<{framebufferWidth: number, framebufferHeight: number}>) {\r\n      this._framebufferDimensionsObject = dimensions;\r\n    }\r\n\r\n    /**\r\n     * Gets the current viewport\r\n     */\r\n    public get currentViewport(): Nullable<IViewportLike> {\r\n        return this._cachedViewport;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty texture\r\n     */\r\n    public get emptyTexture(): InternalTexture {\r\n        if (!this._emptyTexture) {\r\n            this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, 5, false, false, 1);\r\n        }\r\n\r\n        return this._emptyTexture;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty 3D texture\r\n     */\r\n    public get emptyTexture3D(): InternalTexture {\r\n        if (!this._emptyTexture3D) {\r\n            this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\r\n        }\r\n\r\n        return this._emptyTexture3D;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty 2D array texture\r\n     */\r\n    public get emptyTexture2DArray(): InternalTexture {\r\n        if (!this._emptyTexture2DArray) {\r\n            this._emptyTexture2DArray = this.createRawTexture2DArray(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\r\n        }\r\n\r\n        return this._emptyTexture2DArray;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty cube texture\r\n     */\r\n    public get emptyCubeTexture(): InternalTexture {\r\n        if (!this._emptyCubeTexture) {\r\n            var faceData = new Uint8Array(4);\r\n            var cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\r\n            this._emptyCubeTexture = this.createRawCubeTexture(cubeData, 1, 5, 0, false, false, 1);\r\n        }\r\n\r\n        return this._emptyCubeTexture;\r\n    }\r\n\r\n    /**\r\n     * Defines whether the engine has been created with the premultipliedAlpha option on or not.\r\n     */\r\n    public readonly premultipliedAlpha: boolean = true;\r\n\r\n    /**\r\n     * Observable event triggered before each texture is initialized\r\n     */\r\n    public onBeforeTextureInitObservable = new Observable<Texture>();\r\n\r\n    /**\r\n     * Creates a new engine\r\n     * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which alreay used the WebGL context\r\n     * @param antialias defines enable antialiasing (default: false)\r\n     * @param options defines further options to be sent to the getContext() function\r\n     * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\r\n     */\r\n    constructor(canvasOrContext: Nullable<HTMLCanvasElement | OffscreenCanvas | WebGLRenderingContext | WebGL2RenderingContext>, antialias?: boolean, options?: EngineOptions, adaptToDeviceRatio: boolean = false) {\r\n\r\n        let canvas: Nullable<HTMLCanvasElement> = null;\r\n\r\n        if (!canvasOrContext) {\r\n            return;\r\n        }\r\n\r\n        options = options || {};\r\n\r\n        PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\r\n\r\n        if ((canvasOrContext as any).getContext) {\r\n            canvas = <HTMLCanvasElement>canvasOrContext;\r\n            this._renderingCanvas = canvas;\r\n\r\n            if (antialias != null) {\r\n                options.antialias = antialias;\r\n            }\r\n\r\n            if (options.deterministicLockstep === undefined) {\r\n                options.deterministicLockstep = false;\r\n            }\r\n\r\n            if (options.lockstepMaxSteps === undefined) {\r\n                options.lockstepMaxSteps = 4;\r\n            }\r\n\r\n            if (options.timeStep === undefined) {\r\n                options.timeStep = 1 / 60;\r\n            }\r\n\r\n            if (options.preserveDrawingBuffer === undefined) {\r\n                options.preserveDrawingBuffer = false;\r\n            }\r\n\r\n            if (options.audioEngine === undefined) {\r\n                options.audioEngine = true;\r\n            }\r\n\r\n            if (options.stencil === undefined) {\r\n                options.stencil = true;\r\n            }\r\n\r\n            if (options.premultipliedAlpha === false) {\r\n                this.premultipliedAlpha = false;\r\n            }\r\n\r\n            if (options.xrCompatible === undefined) {\r\n                options.xrCompatible = true;\r\n            }\r\n\r\n            this._doNotHandleContextLost = options.doNotHandleContextLost ? true : false;\r\n\r\n            // Exceptions\r\n            if (navigator && navigator.userAgent) {\r\n                let ua = navigator.userAgent;\r\n\r\n                this.hostInformation.isMobile = ua.indexOf(\"Mobile\") !== -1;\r\n\r\n                for (var exception of ThinEngine.ExceptionList) {\r\n                    let key = exception.key;\r\n                    let targets = exception.targets;\r\n                    let check = new RegExp(key);\r\n\r\n                    if (check.test(ua)) {\r\n                        if (exception.capture && exception.captureConstraint) {\r\n                            let capture = exception.capture;\r\n                            let constraint = exception.captureConstraint;\r\n\r\n                            let regex = new RegExp(capture);\r\n                            let matches = regex.exec(ua);\r\n\r\n                            if (matches && matches.length > 0) {\r\n                                let capturedValue = parseInt(matches[matches.length - 1]);\r\n                                if (capturedValue >= constraint) {\r\n                                    continue;\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        for (var target of targets) {\r\n                            switch (target) {\r\n                                case \"uniformBuffer\":\r\n                                    this.disableUniformBuffers = true;\r\n                                    break;\r\n                                case \"vao\":\r\n                                    this.disableVertexArrayObjects = true;\r\n                                    break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Context lost\r\n            if (!this._doNotHandleContextLost) {\r\n                this._onContextLost = (evt: Event) => {\r\n                    evt.preventDefault();\r\n                    this._contextWasLost = true;\r\n                    Logger.Warn(\"WebGL context lost.\");\r\n\r\n                    this.onContextLostObservable.notifyObservers(this);\r\n                };\r\n\r\n                this._onContextRestored = () => {\r\n                    // Adding a timeout to avoid race condition at browser level\r\n                    setTimeout(() => {\r\n                        // Rebuild gl context\r\n                        this._initGLContext();\r\n                        // Rebuild effects\r\n                        this._rebuildEffects();\r\n                        // Rebuild textures\r\n                        this._rebuildInternalTextures();\r\n                        // Rebuild buffers\r\n                        this._rebuildBuffers();\r\n                        // Cache\r\n                        this.wipeCaches(true);\r\n                        Logger.Warn(\"WebGL context successfully restored.\");\r\n                        this.onContextRestoredObservable.notifyObservers(this);\r\n                        this._contextWasLost = false;\r\n                    }, 0);\r\n                };\r\n\r\n                canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\r\n                canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\r\n\r\n                options.powerPreference = \"high-performance\";\r\n            }\r\n\r\n            // GL\r\n            if (!options.disableWebGL2Support) {\r\n                try {\r\n                    this._gl = <any>(canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options));\r\n                    if (this._gl) {\r\n                        this._webGLVersion = 2.0;\r\n\r\n                        // Prevent weird browsers to lie (yeah that happens!)\r\n                        if (!this._gl.deleteQuery) {\r\n                            this._webGLVersion = 1.0;\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    // Do nothing\r\n                }\r\n            }\r\n\r\n            if (!this._gl) {\r\n                if (!canvas) {\r\n                    throw new Error(\"The provided canvas is null or undefined.\");\r\n                }\r\n                try {\r\n                    this._gl = <WebGLRenderingContext>(canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options));\r\n                } catch (e) {\r\n                    throw new Error(\"WebGL not supported\");\r\n                }\r\n            }\r\n\r\n            if (!this._gl) {\r\n                throw new Error(\"WebGL not supported\");\r\n            }\r\n        } else {\r\n            this._gl = <WebGLRenderingContext>canvasOrContext;\r\n            this._renderingCanvas = this._gl.canvas as HTMLCanvasElement;\r\n\r\n            if (this._gl.renderbufferStorageMultisample) {\r\n                this._webGLVersion = 2.0;\r\n            }\r\n\r\n            const attributes = this._gl.getContextAttributes();\r\n            if (attributes) {\r\n                options.stencil = attributes.stencil;\r\n            }\r\n        }\r\n\r\n        // Ensures a consistent color space unpacking of textures cross browser.\r\n        this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n\r\n        if (options.useHighPrecisionFloats !== undefined) {\r\n            this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\r\n        }\r\n\r\n        // Viewport\r\n        const devicePixelRatio = DomManagement.IsWindowObjectExist() ? (window.devicePixelRatio || 1.0) : 1.0;\r\n\r\n        var limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\r\n        this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\r\n        this.resize();\r\n\r\n        this._isStencilEnable = options.stencil ? true : false;\r\n        this._initGLContext();\r\n\r\n        // Prepare buffer pointers\r\n        for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n            this._currentBufferPointers[i] = new BufferPointer();\r\n        }\r\n\r\n        // Shader processor\r\n        if (this.webGLVersion > 1) {\r\n            this._shaderProcessor = new WebGL2ShaderProcessor();\r\n        } else {\r\n            this._shaderProcessor = new WebGLShaderProcessor();\r\n        }\r\n\r\n        // Detect if we are running on a faulty buggy OS.\r\n        this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent);\r\n\r\n        // Starting with iOS 14, we can trust the browser\r\n        // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\r\n\r\n        // if (matches && matches.length === 2) {\r\n        //     if (parseInt(matches[1]) >= 14) {\r\n        //         this._badOS = false;\r\n        //     }\r\n        // }\r\n\r\n        // Detect if we are running on a faulty buggy desktop OS.\r\n        this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\r\n\r\n        this._creationOptions = options;\r\n        console.log(`Babylon.js v${ThinEngine.Version} - ${this.description}`);\r\n    }\r\n\r\n    private _rebuildInternalTextures(): void {\r\n        let currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\r\n\r\n        for (var internalTexture of currentState) {\r\n            internalTexture._rebuild();\r\n        }\r\n    }\r\n\r\n    private _rebuildEffects(): void {\r\n        for (var key in this._compiledEffects) {\r\n            let effect = <Effect>this._compiledEffects[key];\r\n\r\n            effect._prepareEffect();\r\n        }\r\n\r\n        Effect.ResetCache();\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if all created effects are ready\r\n     * @returns true if all effects are ready\r\n     */\r\n    public areAllEffectsReady(): boolean {\r\n        for (var key in this._compiledEffects) {\r\n            let effect = <Effect>this._compiledEffects[key];\r\n\r\n            if (!effect.isReady()) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    protected _rebuildBuffers(): void {\r\n        // Uniforms\r\n        for (var uniformBuffer of this._uniformBuffers) {\r\n            uniformBuffer._rebuild();\r\n        }\r\n    }\r\n\r\n    protected _initGLContext(): void {\r\n        // Caps\r\n        this._caps = {\r\n            maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\r\n            maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\r\n            maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\r\n            maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\r\n            maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\r\n            maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\r\n            maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\r\n            maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\r\n            maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\r\n            maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\r\n            maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\r\n            parallelShaderCompile: this._gl.getExtension('KHR_parallel_shader_compile'),\r\n            standardDerivatives: this._webGLVersion > 1 || (this._gl.getExtension('OES_standard_derivatives') !== null),\r\n            maxAnisotropy: 1,\r\n            astc: this._gl.getExtension('WEBGL_compressed_texture_astc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_astc'),\r\n            bptc: this._gl.getExtension('EXT_texture_compression_bptc') || this._gl.getExtension('WEBKIT_EXT_texture_compression_bptc'),\r\n            s3tc: this._gl.getExtension('WEBGL_compressed_texture_s3tc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_s3tc'),\r\n            pvrtc: this._gl.getExtension('WEBGL_compressed_texture_pvrtc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_pvrtc'),\r\n            etc1: this._gl.getExtension('WEBGL_compressed_texture_etc1') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc1'),\r\n            etc2: this._gl.getExtension('WEBGL_compressed_texture_etc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc') ||\r\n                this._gl.getExtension('WEBGL_compressed_texture_es3_0'), // also a requirement of OpenGL ES 3\r\n            textureAnisotropicFilterExtension: this._gl.getExtension('EXT_texture_filter_anisotropic') || this._gl.getExtension('WEBKIT_EXT_texture_filter_anisotropic') || this._gl.getExtension('MOZ_EXT_texture_filter_anisotropic'),\r\n            uintIndices: this._webGLVersion > 1 || this._gl.getExtension('OES_element_index_uint') !== null,\r\n            fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension('EXT_frag_depth') !== null,\r\n            highPrecisionShaderSupported: false,\r\n            timerQuery: this._gl.getExtension('EXT_disjoint_timer_query_webgl2') || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\r\n            canUseTimestampForTimerQuery: false,\r\n            drawBuffersExtension: false,\r\n            maxMSAASamples: 1,\r\n            colorBufferFloat: this._webGLVersion > 1 && this._gl.getExtension('EXT_color_buffer_float'),\r\n            textureFloat: (this._webGLVersion > 1 || this._gl.getExtension('OES_texture_float')) ? true : false,\r\n            textureHalfFloat: (this._webGLVersion > 1 || this._gl.getExtension('OES_texture_half_float')) ? true : false,\r\n            textureHalfFloatRender: false,\r\n            textureFloatLinearFiltering: false,\r\n            textureFloatRender: false,\r\n            textureHalfFloatLinearFiltering: false,\r\n            vertexArrayObject: false,\r\n            instancedArrays: false,\r\n            textureLOD: (this._webGLVersion > 1 || this._gl.getExtension('EXT_shader_texture_lod')) ? true : false,\r\n            blendMinMax: false,\r\n            multiview: this._gl.getExtension('OVR_multiview2'),\r\n            oculusMultiview: this._gl.getExtension('OCULUS_multiview'),\r\n            depthTextureExtension: false\r\n        };\r\n\r\n        // Infos\r\n        this._glVersion = this._gl.getParameter(this._gl.VERSION);\r\n\r\n        var rendererInfo: any = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\r\n        if (rendererInfo != null) {\r\n            this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\r\n            this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\r\n        }\r\n\r\n        if (!this._glVendor) {\r\n            this._glVendor = \"Unknown vendor\";\r\n        }\r\n\r\n        if (!this._glRenderer) {\r\n            this._glRenderer = \"Unknown renderer\";\r\n        }\r\n\r\n        // Constants\r\n        if (this._gl.HALF_FLOAT_OES !== 0x8D61) {\r\n            this._gl.HALF_FLOAT_OES = 0x8D61;   // Half floating-point type (16-bit).\r\n        }\r\n        if (this._gl.RGBA16F !== 0x881A) {\r\n            this._gl.RGBA16F = 0x881A;      // RGBA 16-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.RGBA32F !== 0x8814) {\r\n            this._gl.RGBA32F = 0x8814;      // RGBA 32-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.DEPTH24_STENCIL8 !== 35056) {\r\n            this._gl.DEPTH24_STENCIL8 = 35056;\r\n        }\r\n\r\n        // Extensions\r\n        if (this._caps.timerQuery) {\r\n            if (this._webGLVersion === 1) {\r\n                this._gl.getQuery = (<any>this._caps.timerQuery).getQueryEXT.bind(this._caps.timerQuery);\r\n            }\r\n            this._caps.canUseTimestampForTimerQuery = this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT) > 0;\r\n        }\r\n\r\n        this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT) : 0;\r\n        this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension('OES_texture_float_linear') ? true : false;\r\n        this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\r\n        this._caps.textureHalfFloatLinearFiltering = (this._webGLVersion > 1 || (this._caps.textureHalfFloat && this._gl.getExtension('OES_texture_half_float_linear'))) ? true : false;\r\n\r\n        // Checks if some of the format renders first to allow the use of webgl inspector.\r\n        if (this._webGLVersion > 1) {\r\n            if (this._gl.HALF_FLOAT_OES !== 0x140B) {\r\n                this._gl.HALF_FLOAT_OES = 0x140B;\r\n            }\r\n        }\r\n        this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer();\r\n        // Draw buffers\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.drawBuffersExtension = true;\r\n            this._caps.maxMSAASamples = this._gl.getParameter(this._gl.MAX_SAMPLES);\r\n        } else {\r\n            var drawBuffersExtension = this._gl.getExtension('WEBGL_draw_buffers');\r\n\r\n            if (drawBuffersExtension !== null) {\r\n                this._caps.drawBuffersExtension = true;\r\n                this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\r\n                this._gl.DRAW_FRAMEBUFFER = this._gl.FRAMEBUFFER;\r\n\r\n                for (var i = 0; i < 16; i++) {\r\n                    (<any>this._gl)[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = (<any>drawBuffersExtension)[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\r\n                }\r\n            }\r\n        }\r\n\r\n        // Depth Texture\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.depthTextureExtension = true;\r\n        } else {\r\n            var depthTextureExtension = this._gl.getExtension('WEBGL_depth_texture');\r\n\r\n            if (depthTextureExtension != null) {\r\n                this._caps.depthTextureExtension = true;\r\n                this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\r\n            }\r\n        }\r\n\r\n        // Vertex array object\r\n        if (this.disableVertexArrayObjects) {\r\n            this._caps.vertexArrayObject = false;\r\n        } else if (this._webGLVersion > 1) {\r\n            this._caps.vertexArrayObject = true;\r\n        } else {\r\n            var vertexArrayObjectExtension = this._gl.getExtension('OES_vertex_array_object');\r\n\r\n            if (vertexArrayObjectExtension != null) {\r\n                this._caps.vertexArrayObject = true;\r\n                this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\r\n            }\r\n        }\r\n\r\n        // Instances count\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.instancedArrays = true;\r\n        } else {\r\n            var instanceExtension = <ANGLE_instanced_arrays>this._gl.getExtension('ANGLE_instanced_arrays');\r\n\r\n            if (instanceExtension != null) {\r\n                this._caps.instancedArrays = true;\r\n                this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\r\n                this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\r\n                this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\r\n            } else {\r\n                this._caps.instancedArrays = false;\r\n            }\r\n        }\r\n\r\n        if (this._gl.getShaderPrecisionFormat) {\r\n            var vertex_highp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\r\n            var fragment_highp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\r\n\r\n            if (vertex_highp && fragment_highp) {\r\n                this._caps.highPrecisionShaderSupported = vertex_highp.precision !== 0 && fragment_highp.precision !== 0;\r\n            }\r\n        }\r\n\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.blendMinMax = true;\r\n        }\r\n        else {\r\n            const blendMinMaxExtension = this._gl.getExtension('EXT_blend_minmax');\r\n            if (blendMinMaxExtension != null) {\r\n                this._caps.blendMinMax = true;\r\n                this._gl.MAX = blendMinMaxExtension.MAX_EXT;\r\n                this._gl.MIN = blendMinMaxExtension.MIN_EXT;\r\n            }\r\n        }\r\n\r\n        // Depth buffer\r\n        this._depthCullingState.depthTest = true;\r\n        this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n        this._depthCullingState.depthMask = true;\r\n\r\n        // Texture maps\r\n        this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\r\n        for (let slot = 0; slot < this._maxSimultaneousTextures; slot++) {\r\n            this._nextFreeTextureSlots.push(slot);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets version of the current webGL context\r\n     */\r\n    public get webGLVersion(): number {\r\n        return this._webGLVersion;\r\n    }\r\n\r\n    /**\r\n     * Gets a string identifying the name of the class\r\n     * @returns \"Engine\" string\r\n     */\r\n    public getClassName(): string {\r\n        return \"ThinEngine\";\r\n    }\r\n\r\n    /**\r\n     * Returns true if the stencil buffer has been enabled through the creation option of the context.\r\n     */\r\n    public get isStencilEnable(): boolean {\r\n        return this._isStencilEnable;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _prepareWorkingCanvas(): void {\r\n        if (this._workingCanvas) {\r\n            return;\r\n        }\r\n\r\n        this._workingCanvas = CanvasGenerator.CreateCanvas(1, 1);\r\n        let context = this._workingCanvas.getContext(\"2d\");\r\n\r\n        if (context) {\r\n            this._workingContext = context;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reset the texture cache to empty state\r\n     */\r\n    public resetTextureCache() {\r\n        for (var key in this._boundTexturesCache) {\r\n            if (!this._boundTexturesCache.hasOwnProperty(key)) {\r\n                continue;\r\n            }\r\n            this._boundTexturesCache[key] = null;\r\n        }\r\n\r\n        this._currentTextureChannel = -1;\r\n    }\r\n\r\n    /**\r\n     * Gets an object containing information about the current webGL context\r\n     * @returns an object containing the vender, the renderer and the version of the current webGL context\r\n     */\r\n    public getGlInfo() {\r\n        return {\r\n            vendor: this._glVendor,\r\n            renderer: this._glRenderer,\r\n            version: this._glVersion\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Defines the hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @param level defines the level to use\r\n     */\r\n    public setHardwareScalingLevel(level: number): void {\r\n        this._hardwareScalingLevel = level;\r\n        this.resize();\r\n    }\r\n\r\n    /**\r\n     * Gets the current hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @returns a number indicating the current hardware scaling level\r\n     */\r\n    public getHardwareScalingLevel(): number {\r\n        return this._hardwareScalingLevel;\r\n    }\r\n\r\n    /**\r\n     * Gets the list of loaded textures\r\n     * @returns an array containing all loaded textures\r\n     */\r\n    public getLoadedTexturesCache(): InternalTexture[] {\r\n        return this._internalTexturesCache;\r\n    }\r\n\r\n    /**\r\n     * Gets the object containing all engine capabilities\r\n     * @returns the EngineCapabilities object\r\n     */\r\n    public getCaps(): EngineCapabilities {\r\n        return this._caps;\r\n    }\r\n\r\n    /**\r\n     * stop executing a render loop function and remove it from the execution array\r\n     * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\r\n     */\r\n    public stopRenderLoop(renderFunction?: () => void): void {\r\n        if (!renderFunction) {\r\n            this._activeRenderLoops = [];\r\n            return;\r\n        }\r\n\r\n        var index = this._activeRenderLoops.indexOf(renderFunction);\r\n\r\n        if (index >= 0) {\r\n            this._activeRenderLoops.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _renderLoop(): void {\r\n        if (!this._contextWasLost) {\r\n            var shouldRender = true;\r\n            if (!this.renderEvenInBackground && this._windowIsBackground) {\r\n                shouldRender = false;\r\n            }\r\n\r\n            if (shouldRender) {\r\n                // Start new frame\r\n                this.beginFrame();\r\n\r\n                for (var index = 0; index < this._activeRenderLoops.length; index++) {\r\n                    var renderFunction = this._activeRenderLoops[index];\r\n\r\n                    renderFunction();\r\n                }\r\n\r\n                // Present\r\n                this.endFrame();\r\n            }\r\n        }\r\n\r\n        if (this._activeRenderLoops.length > 0) {\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        } else {\r\n            this._renderingQueueLaunched = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the HTML canvas attached with the current webGL context\r\n     * @returns a HTML canvas\r\n     */\r\n    public getRenderingCanvas(): Nullable<HTMLCanvasElement> {\r\n        return this._renderingCanvas;\r\n    }\r\n\r\n    /**\r\n     * Gets host window\r\n     * @returns the host window object\r\n     */\r\n    public getHostWindow(): Nullable<Window> {\r\n        if (!DomManagement.IsWindowObjectExist()) {\r\n            return null;\r\n        }\r\n\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\r\n            return this._renderingCanvas.ownerDocument.defaultView;\r\n        }\r\n\r\n        return window;\r\n    }\r\n\r\n    /**\r\n     * Gets the current render width\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render width\r\n     */\r\n    public getRenderWidth(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.width;\r\n        }\r\n\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\r\n    }\r\n\r\n    /**\r\n     * Gets the current render height\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render height\r\n     */\r\n    public getRenderHeight(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.height;\r\n        }\r\n\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\r\n    }\r\n\r\n    /**\r\n     * Can be used to override the current requestAnimationFrame requester.\r\n     * @hidden\r\n     */\r\n    protected _queueNewFrame(bindedRenderFunction: any, requester?: any): number {\r\n        return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\r\n    }\r\n\r\n    /**\r\n     * Register and execute a render loop. The engine can have more than one render function\r\n     * @param renderFunction defines the function to continuously execute\r\n     */\r\n    public runRenderLoop(renderFunction: () => void): void {\r\n        if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\r\n            return;\r\n        }\r\n\r\n        this._activeRenderLoops.push(renderFunction);\r\n\r\n        if (!this._renderingQueueLaunched) {\r\n            this._renderingQueueLaunched = true;\r\n            this._boundRenderFunction = this._renderLoop.bind(this);\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clear the current render buffer or the current render target (if any is set up)\r\n     * @param color defines the color to use\r\n     * @param backBuffer defines if the back buffer must be cleared\r\n     * @param depth defines if the depth buffer must be cleared\r\n     * @param stencil defines if the stencil buffer must be cleared\r\n     */\r\n    public clear(color: Nullable<IColor4Like>, backBuffer: boolean, depth: boolean, stencil: boolean = false): void {\r\n        this.applyStates();\r\n\r\n        var mode = 0;\r\n        if (backBuffer && color) {\r\n            this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\r\n            mode |= this._gl.COLOR_BUFFER_BIT;\r\n        }\r\n\r\n        if (depth) {\r\n            if (this.useReverseDepthBuffer) {\r\n                this._depthCullingState.depthFunc = this._gl.GREATER;\r\n                this._gl.clearDepth(0.0);\r\n            } else {\r\n                this._gl.clearDepth(1.0);\r\n            }\r\n            mode |= this._gl.DEPTH_BUFFER_BIT;\r\n        }\r\n        if (stencil) {\r\n            this._gl.clearStencil(0);\r\n            mode |= this._gl.STENCIL_BUFFER_BIT;\r\n        }\r\n        this._gl.clear(mode);\r\n    }\r\n\r\n    private _viewportCached = { x: 0, y: 0, z: 0, w: 0 };\r\n\r\n    /** @hidden */\r\n    public _viewport(x: number, y: number, width: number, height: number): void {\r\n        if (x !== this._viewportCached.x ||\r\n            y !== this._viewportCached.y ||\r\n            width !== this._viewportCached.z ||\r\n            height !== this._viewportCached.w) {\r\n            this._viewportCached.x = x;\r\n            this._viewportCached.y = y;\r\n            this._viewportCached.z = width;\r\n            this._viewportCached.w = height;\r\n\r\n            this._gl.viewport(x, y, width, height);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the WebGL's viewport\r\n     * @param viewport defines the viewport element to be used\r\n     * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\r\n     * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\r\n     */\r\n    public setViewport(viewport: IViewportLike, requiredWidth?: number, requiredHeight?: number): void {\r\n        var width = requiredWidth || this.getRenderWidth();\r\n        var height = requiredHeight || this.getRenderHeight();\r\n        var x = viewport.x || 0;\r\n        var y = viewport.y || 0;\r\n\r\n        this._cachedViewport = viewport;\r\n\r\n        this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\r\n    }\r\n\r\n    /**\r\n     * Begin a new frame\r\n     */\r\n    public beginFrame(): void {\r\n    }\r\n\r\n    /**\r\n     * Enf the current frame\r\n     */\r\n    public endFrame(): void {\r\n        // Force a flush in case we are using a bad OS.\r\n        if (this._badOS) {\r\n            this.flushFramebuffer();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Resize the view according to the canvas' size\r\n     */\r\n    public resize(): void {\r\n        let width: number;\r\n        let height: number;\r\n\r\n        if (DomManagement.IsWindowObjectExist()) {\r\n            width = this._renderingCanvas ? (this._renderingCanvas.clientWidth || this._renderingCanvas.width) : window.innerWidth;\r\n            height = this._renderingCanvas ? (this._renderingCanvas.clientHeight || this._renderingCanvas.height) : window.innerHeight;\r\n        } else {\r\n            width = this._renderingCanvas ? this._renderingCanvas.width : 100;\r\n            height = this._renderingCanvas ? this._renderingCanvas.height : 100;\r\n        }\r\n\r\n        this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel);\r\n    }\r\n\r\n    /**\r\n     * Force a specific size of the canvas\r\n     * @param width defines the new canvas' width\r\n     * @param height defines the new canvas' height\r\n     * @returns true if the size was changed\r\n     */\r\n    public setSize(width: number, height: number): boolean {\r\n        if (!this._renderingCanvas) {\r\n            return false;\r\n        }\r\n\r\n        width = width | 0;\r\n        height = height | 0;\r\n\r\n        if (this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\r\n            return false;\r\n        }\r\n\r\n        this._renderingCanvas.width = width;\r\n        this._renderingCanvas.height = height;\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Binds the frame buffer to the specified texture.\r\n     * @param texture The texture to render to or null for the default canvas\r\n     * @param faceIndex The face of the texture to render to in case of cube texture\r\n     * @param requiredWidth The width of the target to render to\r\n     * @param requiredHeight The height of the target to render to\r\n     * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\r\n     * @param lodLevel defines the lod level to bind to the frame buffer\r\n     * @param layer defines the 2d array index to bind to frame buffer to\r\n     */\r\n    public bindFramebuffer(texture: InternalTexture, faceIndex: number = 0, requiredWidth?: number, requiredHeight?: number, forceFullscreenViewport?: boolean, lodLevel = 0, layer = 0): void {\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        }\r\n        this._currentRenderTarget = texture;\r\n        this._bindUnboundFramebuffer(texture._MSAAFramebuffer ? texture._MSAAFramebuffer : texture._framebuffer);\r\n\r\n        const gl = this._gl;\r\n        if (texture.is2DArray) {\r\n            gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture._webGLTexture, lodLevel, layer);\r\n        }\r\n        else if (texture.isCube) {\r\n            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, texture._webGLTexture, lodLevel);\r\n        }\r\n\r\n        const depthStencilTexture = texture._depthStencilTexture;\r\n        if (depthStencilTexture) {\r\n            const attachment = (depthStencilTexture._generateStencilBuffer) ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\r\n            if (texture.is2DArray) {\r\n                gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, depthStencilTexture._webGLTexture, lodLevel, layer);\r\n            }\r\n            else if (texture.isCube) {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, depthStencilTexture._webGLTexture, lodLevel);\r\n            }\r\n            else {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, depthStencilTexture._webGLTexture, lodLevel);\r\n            }\r\n        }\r\n\r\n        if (this._cachedViewport && !forceFullscreenViewport) {\r\n            this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\r\n        } else {\r\n            if (!requiredWidth) {\r\n                requiredWidth = texture.width;\r\n                if (lodLevel) {\r\n                    requiredWidth = requiredWidth / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n            if (!requiredHeight) {\r\n                requiredHeight = texture.height;\r\n                if (lodLevel) {\r\n                    requiredHeight = requiredHeight / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n\r\n            this._viewport(0, 0, requiredWidth, requiredHeight);\r\n        }\r\n\r\n        this.wipeCaches();\r\n    }\r\n\r\n    /** @hidden */\r\n    public _bindUnboundFramebuffer(framebuffer: Nullable<WebGLFramebuffer>) {\r\n        if (this._currentFramebuffer !== framebuffer) {\r\n            this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\r\n            this._currentFramebuffer = framebuffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Unbind the current render target texture from the webGL context\r\n     * @param texture defines the render target texture to unbind\r\n     * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\r\n     * @param onBeforeUnbind defines a function which will be called before the effective unbind\r\n     */\r\n    public unBindFramebuffer(texture: InternalTexture, disableGenerateMipMaps = false, onBeforeUnbind?: () => void): void {\r\n        this._currentRenderTarget = null;\r\n\r\n        // If MSAA, we need to bitblt back to main texture\r\n        var gl = this._gl;\r\n        if (texture._MSAAFramebuffer) {\r\n            if (texture._textureArray) {\r\n                // This texture is part of a MRT texture, we need to treat all attachments\r\n                this.unBindMultiColorAttachmentFramebuffer(texture._textureArray!, disableGenerateMipMaps, onBeforeUnbind);\r\n                return;\r\n            }\r\n            gl.bindFramebuffer(gl.READ_FRAMEBUFFER, texture._MSAAFramebuffer);\r\n            gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, texture._framebuffer);\r\n            gl.blitFramebuffer(0, 0, texture.width, texture.height,\r\n                0, 0, texture.width, texture.height,\r\n                gl.COLOR_BUFFER_BIT, gl.NEAREST);\r\n        }\r\n\r\n        if (texture.generateMipMaps && !disableGenerateMipMaps && !texture.isCube) {\r\n            this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n            gl.generateMipmap(gl.TEXTURE_2D);\r\n            this._bindTextureDirectly(gl.TEXTURE_2D, null);\r\n        }\r\n\r\n        if (onBeforeUnbind) {\r\n            if (texture._MSAAFramebuffer) {\r\n                // Bind the correct framebuffer\r\n                this._bindUnboundFramebuffer(texture._framebuffer);\r\n            }\r\n            onBeforeUnbind();\r\n        }\r\n\r\n        this._bindUnboundFramebuffer(null);\r\n    }\r\n\r\n    /**\r\n     * Force a webGL flush (ie. a flush of all waiting webGL commands)\r\n     */\r\n    public flushFramebuffer(): void {\r\n        this._gl.flush();\r\n    }\r\n\r\n    /**\r\n     * Unbind the current render target and bind the default framebuffer\r\n     */\r\n    public restoreDefaultFramebuffer(): void {\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        } else {\r\n            this._bindUnboundFramebuffer(null);\r\n        }\r\n        if (this._cachedViewport) {\r\n            this.setViewport(this._cachedViewport);\r\n        }\r\n\r\n        this.wipeCaches();\r\n    }\r\n\r\n    // VBOs\r\n\r\n    /** @hidden */\r\n    protected _resetVertexBufferBinding(): void {\r\n        this.bindArrayBuffer(null);\r\n        this._cachedVertexBuffers = null;\r\n    }\r\n\r\n    /**\r\n     * Creates a vertex buffer\r\n     * @param data the data for the vertex buffer\r\n     * @returns the new WebGL static buffer\r\n     */\r\n    public createVertexBuffer(data: DataArray): DataBuffer {\r\n        return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\r\n    }\r\n\r\n    private _createVertexBuffer(data: DataArray, usage: number): DataBuffer {\r\n        var vbo = this._gl.createBuffer();\r\n\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create vertex buffer\");\r\n        }\r\n\r\n        let dataBuffer = new WebGLDataBuffer(vbo);\r\n        this.bindArrayBuffer(dataBuffer);\r\n\r\n        if (data instanceof Array) {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), this._gl.STATIC_DRAW);\r\n        } else {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, <ArrayBuffer>data, this._gl.STATIC_DRAW);\r\n        }\r\n\r\n        this._resetVertexBufferBinding();\r\n\r\n        dataBuffer.references = 1;\r\n        return dataBuffer;\r\n    }\r\n\r\n    /**\r\n     * Creates a dynamic vertex buffer\r\n     * @param data the data for the dynamic vertex buffer\r\n     * @returns the new WebGL dynamic buffer\r\n     */\r\n    public createDynamicVertexBuffer(data: DataArray): DataBuffer {\r\n        return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\r\n    }\r\n\r\n    protected _resetIndexBufferBinding(): void {\r\n        this.bindIndexBuffer(null);\r\n        this._cachedIndexBuffer = null;\r\n    }\r\n\r\n    /**\r\n     * Creates a new index buffer\r\n     * @param indices defines the content of the index buffer\r\n     * @param updatable defines if the index buffer must be updatable\r\n     * @returns a new webGL buffer\r\n     */\r\n    public createIndexBuffer(indices: IndicesArray, updatable?: boolean): DataBuffer {\r\n        var vbo = this._gl.createBuffer();\r\n        let dataBuffer = new WebGLDataBuffer(vbo!);\r\n\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create index buffer\");\r\n        }\r\n\r\n        this.bindIndexBuffer(dataBuffer);\r\n\r\n        const data = this._normalizeIndexData(indices);\r\n        this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\r\n        this._resetIndexBufferBinding();\r\n        dataBuffer.references = 1;\r\n        dataBuffer.is32Bits = (data.BYTES_PER_ELEMENT === 4);\r\n        return dataBuffer;\r\n    }\r\n\r\n    protected _normalizeIndexData(indices: IndicesArray): Uint16Array | Uint32Array {\r\n        if (indices instanceof Uint16Array) {\r\n            return indices;\r\n        }\r\n\r\n        // Check 32 bit support\r\n        if (this._caps.uintIndices) {\r\n            if (indices instanceof Uint32Array) {\r\n                return indices;\r\n            } else {\r\n                // number[] or Int32Array, check if 32 bit is necessary\r\n                for (var index = 0; index < indices.length; index++) {\r\n                    if (indices[index] >= 65535) {\r\n                        return new Uint32Array(indices);\r\n                    }\r\n                }\r\n\r\n                return new Uint16Array(indices);\r\n            }\r\n        }\r\n\r\n        // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\r\n        return new Uint16Array(indices);\r\n    }\r\n\r\n    /**\r\n     * Bind a webGL buffer to the webGL context\r\n     * @param buffer defines the buffer to bind\r\n     */\r\n    public bindArrayBuffer(buffer: Nullable<DataBuffer>): void {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this.bindBuffer(buffer, this._gl.ARRAY_BUFFER);\r\n    }\r\n\r\n    /**\r\n     * Bind a specific block at a given index in a specific shader program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param blockName defines the block name\r\n     * @param index defines the index where to bind the block\r\n     */\r\n    public bindUniformBlock(pipelineContext: IPipelineContext, blockName: string, index: number): void {\r\n        let program = (pipelineContext as WebGLPipelineContext).program!;\r\n\r\n        var uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\r\n\r\n        this._gl.uniformBlockBinding(program, uniformLocation, index);\r\n    }\r\n\r\n    protected bindIndexBuffer(buffer: Nullable<DataBuffer>): void {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this.bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\r\n    }\r\n\r\n    private bindBuffer(buffer: Nullable<DataBuffer>, target: number): void {\r\n        if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\r\n            this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\r\n            this._currentBoundBuffer[target] = buffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * update the bound buffer with the given data\r\n     * @param data defines the data to update\r\n     */\r\n    public updateArrayBuffer(data: Float32Array): void {\r\n        this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n    }\r\n\r\n    private _vertexAttribPointer(buffer: DataBuffer, indx: number, size: number, type: number, normalized: boolean, stride: number, offset: number): void {\r\n        var pointer = this._currentBufferPointers[indx];\r\n        if (!pointer) {\r\n            return;\r\n        }\r\n\r\n        var changed = false;\r\n        if (!pointer.active) {\r\n            changed = true;\r\n            pointer.active = true;\r\n            pointer.index = indx;\r\n            pointer.size = size;\r\n            pointer.type = type;\r\n            pointer.normalized = normalized;\r\n            pointer.stride = stride;\r\n            pointer.offset = offset;\r\n            pointer.buffer = buffer;\r\n        } else {\r\n            if (pointer.buffer !== buffer) { pointer.buffer = buffer; changed = true; }\r\n            if (pointer.size !== size) { pointer.size = size; changed = true; }\r\n            if (pointer.type !== type) { pointer.type = type; changed = true; }\r\n            if (pointer.normalized !== normalized) { pointer.normalized = normalized; changed = true; }\r\n            if (pointer.stride !== stride) { pointer.stride = stride; changed = true; }\r\n            if (pointer.offset !== offset) { pointer.offset = offset; changed = true; }\r\n        }\r\n\r\n        if (changed || this._vaoRecordInProgress) {\r\n            this.bindArrayBuffer(buffer);\r\n            this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _bindIndexBufferWithCache(indexBuffer: Nullable<DataBuffer>): void {\r\n        if (indexBuffer == null) {\r\n            return;\r\n        }\r\n        if (this._cachedIndexBuffer !== indexBuffer) {\r\n            this._cachedIndexBuffer = indexBuffer;\r\n            this.bindIndexBuffer(indexBuffer);\r\n            this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\r\n        }\r\n    }\r\n\r\n    private _bindVertexBuffersAttributes(vertexBuffers: { [key: string]: Nullable<VertexBuffer> }, effect: Effect): void {\r\n        var attributes = effect.getAttributesNames();\r\n\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n\r\n        this.unbindAllAttributes();\r\n\r\n        for (var index = 0; index < attributes.length; index++) {\r\n            var order = effect.getAttributeLocation(index);\r\n\r\n            if (order >= 0) {\r\n                var vertexBuffer = vertexBuffers[attributes[index]];\r\n\r\n                if (!vertexBuffer) {\r\n                    continue;\r\n                }\r\n\r\n                this._gl.enableVertexAttribArray(order);\r\n                if (!this._vaoRecordInProgress) {\r\n                    this._vertexAttribArraysEnabled[order] = true;\r\n                }\r\n\r\n                var buffer = vertexBuffer.getBuffer();\r\n                if (buffer) {\r\n                    this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\r\n\r\n                    if (vertexBuffer.getIsInstanced()) {\r\n                        this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\r\n                        if (!this._vaoRecordInProgress) {\r\n                            this._currentInstanceLocations.push(order);\r\n                            this._currentInstanceBuffers.push(buffer);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Records a vertex array object\r\n     * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n     * @param vertexBuffers defines the list of vertex buffers to store\r\n     * @param indexBuffer defines the index buffer to store\r\n     * @param effect defines the effect to store\r\n     * @returns the new vertex array object\r\n     */\r\n    public recordVertexArrayObject(vertexBuffers: { [key: string]: VertexBuffer; }, indexBuffer: Nullable<DataBuffer>, effect: Effect): WebGLVertexArrayObject {\r\n        var vao = this._gl.createVertexArray();\r\n\r\n        this._vaoRecordInProgress = true;\r\n\r\n        this._gl.bindVertexArray(vao);\r\n\r\n        this._mustWipeVertexAttributes = true;\r\n        this._bindVertexBuffersAttributes(vertexBuffers, effect);\r\n\r\n        this.bindIndexBuffer(indexBuffer);\r\n\r\n        this._vaoRecordInProgress = false;\r\n        this._gl.bindVertexArray(null);\r\n\r\n        return vao;\r\n    }\r\n\r\n    /**\r\n     * Bind a specific vertex array object\r\n     * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n     * @param vertexArrayObject defines the vertex array object to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     */\r\n    public bindVertexArrayObject(vertexArrayObject: WebGLVertexArrayObject, indexBuffer: Nullable<DataBuffer>): void {\r\n        if (this._cachedVertexArrayObject !== vertexArrayObject) {\r\n            this._cachedVertexArrayObject = vertexArrayObject;\r\n\r\n            this._gl.bindVertexArray(vertexArrayObject);\r\n            this._cachedVertexBuffers = null;\r\n            this._cachedIndexBuffer = null;\r\n\r\n            this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\r\n            this._mustWipeVertexAttributes = true;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bind webGl buffers directly to the webGL context\r\n     * @param vertexBuffer defines the vertex buffer to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\r\n     * @param vertexStrideSize defines the vertex stride of the vertex buffer\r\n     * @param effect defines the effect associated with the vertex buffer\r\n     */\r\n    public bindBuffersDirectly(vertexBuffer: DataBuffer, indexBuffer: DataBuffer, vertexDeclaration: number[], vertexStrideSize: number, effect: Effect): void {\r\n        if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffer;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n\r\n            let attributesCount = effect.getAttributesCount();\r\n\r\n            this._unbindVertexArrayObject();\r\n            this.unbindAllAttributes();\r\n\r\n            var offset = 0;\r\n            for (var index = 0; index < attributesCount; index++) {\r\n\r\n                if (index < vertexDeclaration.length) {\r\n\r\n                    var order = effect.getAttributeLocation(index);\r\n\r\n                    if (order >= 0) {\r\n                        this._gl.enableVertexAttribArray(order);\r\n                        this._vertexAttribArraysEnabled[order] = true;\r\n                        this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\r\n                    }\r\n\r\n                    offset += vertexDeclaration[index] * 4;\r\n                }\r\n            }\r\n        }\r\n\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    }\r\n\r\n    private _unbindVertexArrayObject(): void {\r\n        if (!this._cachedVertexArrayObject) {\r\n            return;\r\n        }\r\n\r\n        this._cachedVertexArrayObject = null;\r\n        this._gl.bindVertexArray(null);\r\n    }\r\n\r\n    /**\r\n     * Bind a list of vertex buffers to the webGL context\r\n     * @param vertexBuffers defines the list of vertex buffers to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param effect defines the effect associated with the vertex buffers\r\n     */\r\n    public bindBuffers(vertexBuffers: { [key: string]: Nullable<VertexBuffer> }, indexBuffer: Nullable<DataBuffer>, effect: Effect): void {\r\n        if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffers;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n\r\n            this._bindVertexBuffersAttributes(vertexBuffers, effect);\r\n        }\r\n\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    }\r\n\r\n    /**\r\n     * Unbind all instance attributes\r\n     */\r\n    public unbindInstanceAttributes() {\r\n        var boundBuffer;\r\n        for (var i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\r\n            var instancesBuffer = this._currentInstanceBuffers[i];\r\n            if (boundBuffer != instancesBuffer && instancesBuffer.references) {\r\n                boundBuffer = instancesBuffer;\r\n                this.bindArrayBuffer(instancesBuffer);\r\n            }\r\n            var offsetLocation = this._currentInstanceLocations[i];\r\n            this._gl.vertexAttribDivisor(offsetLocation, 0);\r\n        }\r\n        this._currentInstanceBuffers.length = 0;\r\n        this._currentInstanceLocations.length = 0;\r\n    }\r\n\r\n    /**\r\n     * Release and free the memory of a vertex array object\r\n     * @param vao defines the vertex array object to delete\r\n     */\r\n    public releaseVertexArrayObject(vao: WebGLVertexArrayObject) {\r\n        this._gl.deleteVertexArray(vao);\r\n    }\r\n\r\n    /** @hidden */\r\n    public _releaseBuffer(buffer: DataBuffer): boolean {\r\n        buffer.references--;\r\n\r\n        if (buffer.references === 0) {\r\n            this._deleteBuffer(buffer);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    protected _deleteBuffer(buffer: DataBuffer): void {\r\n        this._gl.deleteBuffer(buffer.underlyingResource);\r\n    }\r\n\r\n    /**\r\n     * Update the content of a webGL buffer used with instanciation and bind it to the webGL context\r\n     * @param instancesBuffer defines the webGL buffer to update and bind\r\n     * @param data defines the data to store in the buffer\r\n     * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     */\r\n    public updateAndBindInstancesBuffer(instancesBuffer: DataBuffer, data: Float32Array, offsetLocations: number[] | InstancingAttributeInfo[]): void {\r\n        this.bindArrayBuffer(instancesBuffer);\r\n        if (data) {\r\n            this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n        }\r\n\r\n        if ((<any>offsetLocations[0]).index !== undefined) {\r\n            this.bindInstancesBuffer(instancesBuffer, offsetLocations as any, true);\r\n        } else {\r\n            for (let index = 0; index < 4; index++) {\r\n                let offsetLocation = <number>offsetLocations[index];\r\n\r\n                if (!this._vertexAttribArraysEnabled[offsetLocation]) {\r\n                    this._gl.enableVertexAttribArray(offsetLocation);\r\n                    this._vertexAttribArraysEnabled[offsetLocation] = true;\r\n                }\r\n\r\n                this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\r\n                this._gl.vertexAttribDivisor(offsetLocation, 1);\r\n                this._currentInstanceLocations.push(offsetLocation);\r\n                this._currentInstanceBuffers.push(instancesBuffer);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bind the content of a webGL buffer used with instantiation\r\n     * @param instancesBuffer defines the webGL buffer to bind\r\n     * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     * @param computeStride defines Whether to compute the strides from the info or use the default 0\r\n     */\r\n    public bindInstancesBuffer(instancesBuffer: DataBuffer, attributesInfo: InstancingAttributeInfo[], computeStride = true): void {\r\n        this.bindArrayBuffer(instancesBuffer);\r\n\r\n        let stride = 0;\r\n        if (computeStride) {\r\n            for (let i = 0; i < attributesInfo.length; i++) {\r\n                let ai = attributesInfo[i];\r\n                stride += ai.attributeSize * 4;\r\n            }\r\n        }\r\n\r\n        for (let i = 0; i < attributesInfo.length; i++) {\r\n            let ai = attributesInfo[i];\r\n            if (ai.index === undefined) {\r\n                ai.index = this._currentEffect!.getAttributeLocationByName(ai.attributeName);\r\n            }\r\n\r\n            if (ai.index < 0) {\r\n                continue;\r\n            }\r\n\r\n            if (!this._vertexAttribArraysEnabled[ai.index]) {\r\n                this._gl.enableVertexAttribArray(ai.index);\r\n                this._vertexAttribArraysEnabled[ai.index] = true;\r\n            }\r\n\r\n            this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\r\n            this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\r\n            this._currentInstanceLocations.push(ai.index);\r\n            this._currentInstanceBuffers.push(instancesBuffer);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable the instance attribute corresponding to the name in parameter\r\n     * @param name defines the name of the attribute to disable\r\n     */\r\n    public disableInstanceAttributeByName(name: string) {\r\n        if (!this._currentEffect) {\r\n            return;\r\n        }\r\n\r\n        const attributeLocation = this._currentEffect.getAttributeLocationByName(name);\r\n        this.disableInstanceAttribute(attributeLocation);\r\n    }\r\n\r\n    /**\r\n     * Disable the instance attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    public disableInstanceAttribute(attributeLocation: number) {\r\n        let shouldClean = false;\r\n        let index: number;\r\n        while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\r\n            this._currentInstanceLocations.splice(index, 1);\r\n            this._currentInstanceBuffers.splice(index, 1);\r\n\r\n            shouldClean = true;\r\n            index = this._currentInstanceLocations.indexOf(attributeLocation);\r\n        }\r\n\r\n        if (shouldClean) {\r\n            this._gl.vertexAttribDivisor(attributeLocation, 0);\r\n            this.disableAttributeByIndex(attributeLocation);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable the attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    public disableAttributeByIndex(attributeLocation: number) {\r\n        this._gl.disableVertexAttribArray(attributeLocation);\r\n        this._vertexAttribArraysEnabled[attributeLocation] = false;\r\n        this._currentBufferPointers[attributeLocation].active = false;\r\n    }\r\n\r\n    /**\r\n     * Send a draw order\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    public draw(useTriangles: boolean, indexStart: number, indexCount: number, instancesCount?: number): void {\r\n        this.drawElementsType(useTriangles ? 0 : 1, indexStart, indexCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of points\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    public drawPointClouds(verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        this.drawArraysType(2, verticesStart, verticesCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    public drawUnIndexed(useTriangles: boolean, verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        this.drawArraysType(useTriangles ? 0 : 1, verticesStart, verticesCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of indexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    public drawElementsType(fillMode: number, indexStart: number, indexCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this.applyStates();\r\n\r\n        this._reportDrawCall();\r\n\r\n        // Render\r\n\r\n        const drawMode = this._drawMode(fillMode);\r\n        var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\r\n        var mult = this._uintIndicesCurrentlySet ? 4 : 2;\r\n        if (instancesCount) {\r\n            this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\r\n        } else {\r\n            this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    public drawArraysType(fillMode: number, verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this.applyStates();\r\n\r\n        this._reportDrawCall();\r\n\r\n        const drawMode = this._drawMode(fillMode);\r\n        if (instancesCount) {\r\n            this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\r\n        } else {\r\n            this._gl.drawArrays(drawMode, verticesStart, verticesCount);\r\n        }\r\n    }\r\n\r\n    private _drawMode(fillMode: number): number {\r\n        switch (fillMode) {\r\n            // Triangle views\r\n            case 0:\r\n                return this._gl.TRIANGLES;\r\n            case 2:\r\n                return this._gl.POINTS;\r\n            case 1:\r\n                return this._gl.LINES;\r\n            // Draw modes\r\n            case 3:\r\n                return this._gl.POINTS;\r\n            case 4:\r\n                return this._gl.LINES;\r\n            case 5:\r\n                return this._gl.LINE_LOOP;\r\n            case 6:\r\n                return this._gl.LINE_STRIP;\r\n            case 7:\r\n                return this._gl.TRIANGLE_STRIP;\r\n            case 8:\r\n                return this._gl.TRIANGLE_FAN;\r\n            default:\r\n                return this._gl.TRIANGLES;\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    protected _reportDrawCall() {\r\n        // Will be implemented by children\r\n    }\r\n\r\n    // Shaders\r\n\r\n    /** @hidden */\r\n    public _releaseEffect(effect: Effect): void {\r\n        if (this._compiledEffects[effect._key]) {\r\n            delete this._compiledEffects[effect._key];\r\n\r\n            this._deletePipelineContext(effect.getPipelineContext() as WebGLPipelineContext);\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _deletePipelineContext(pipelineContext: IPipelineContext): void {\r\n        let webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n        if (webGLPipelineContext && webGLPipelineContext.program) {\r\n            webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\r\n\r\n            this._gl.deleteProgram(webGLPipelineContext.program);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Create a new effect (used to store vertex/fragment shaders)\r\n     * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\r\n     * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\r\n     * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\r\n     * @param samplers defines an array of string used to represent textures\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param fallbacks defines the list of potential fallbacks to use if shader conmpilation fails\r\n     * @param onCompiled defines a function to call when the effect creation is successful\r\n     * @param onError defines a function to call when the effect creation has failed\r\n     * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\r\n     * @returns the new Effect\r\n     */\r\n    public createEffect(baseName: any, attributesNamesOrOptions: string[] | IEffectCreationOptions, uniformsNamesOrEngine: string[] | ThinEngine, samplers?: string[], defines?: string,\r\n        fallbacks?: IEffectFallbacks,\r\n        onCompiled?: Nullable<(effect: Effect) => void>, onError?: Nullable<(effect: Effect, errors: string) => void>, indexParameters?: any): Effect {\r\n        var vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\r\n        var fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\r\n\r\n        var name = vertex + \"+\" + fragment + \"@\" + (defines ? defines : (<IEffectCreationOptions>attributesNamesOrOptions).defines);\r\n        if (this._compiledEffects[name]) {\r\n            var compiledEffect = <Effect>this._compiledEffects[name];\r\n            if (onCompiled && compiledEffect.isReady()) {\r\n                onCompiled(compiledEffect);\r\n            }\r\n\r\n            return compiledEffect;\r\n        }\r\n        var effect = new Effect(baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, this, defines, fallbacks, onCompiled, onError, indexParameters);\r\n        effect._key = name;\r\n        this._compiledEffects[name] = effect;\r\n\r\n        return effect;\r\n    }\r\n\r\n    protected static _ConcatenateShader(source: string, defines: Nullable<string>, shaderVersion: string = \"\"): string {\r\n        return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\r\n    }\r\n\r\n    private _compileShader(source: string, type: string, defines: Nullable<string>, shaderVersion: string): WebGLShader {\r\n        return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\r\n    }\r\n\r\n    private _compileRawShader(source: string, type: string): WebGLShader {\r\n        var gl = this._gl;\r\n        var shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\r\n\r\n        if (!shader) {\r\n            throw new Error(\"Something went wrong while compile the shader.\");\r\n        }\r\n\r\n        gl.shaderSource(shader, source);\r\n        gl.compileShader(shader);\r\n\r\n        return shader;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getShaderSource(shader: WebGLShader): Nullable<string> {\r\n        return this._gl.getShaderSource(shader);\r\n    }\r\n\r\n    /**\r\n     * Directly creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    public createRawShaderProgram(pipelineContext: IPipelineContext, vertexCode: string, fragmentCode: string, context?: WebGLRenderingContext, transformFeedbackVaryings: Nullable<string[]> = null): WebGLProgram {\r\n        context = context || this._gl;\r\n\r\n        var vertexShader = this._compileRawShader(vertexCode, \"vertex\");\r\n        var fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\r\n\r\n        return this._createShaderProgram(pipelineContext as WebGLPipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    }\r\n\r\n    /**\r\n     * Creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode  defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    public createShaderProgram(pipelineContext: IPipelineContext, vertexCode: string, fragmentCode: string, defines: Nullable<string>, context?: WebGLRenderingContext, transformFeedbackVaryings: Nullable<string[]> = null): WebGLProgram {\r\n        context = context || this._gl;\r\n\r\n        var shaderVersion = (this._webGLVersion > 1) ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\r\n        var vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\r\n        var fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\r\n\r\n        return this._createShaderProgram(pipelineContext as WebGLPipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    }\r\n\r\n    /**\r\n     * Creates a new pipeline context\r\n     * @returns the new pipeline\r\n     */\r\n    public createPipelineContext(): IPipelineContext {\r\n        var pipelineContext = new WebGLPipelineContext();\r\n        pipelineContext.engine = this;\r\n\r\n        if (this._caps.parallelShaderCompile) {\r\n            pipelineContext.isParallelCompiled = true;\r\n        }\r\n\r\n        return pipelineContext;\r\n    }\r\n\r\n    protected _createShaderProgram(pipelineContext: WebGLPipelineContext, vertexShader: WebGLShader, fragmentShader: WebGLShader, context: WebGLRenderingContext, transformFeedbackVaryings: Nullable<string[]> = null): WebGLProgram {\r\n        var shaderProgram = context.createProgram();\r\n        pipelineContext.program = shaderProgram;\r\n\r\n        if (!shaderProgram) {\r\n            throw new Error(\"Unable to create program\");\r\n        }\r\n\r\n        context.attachShader(shaderProgram, vertexShader);\r\n        context.attachShader(shaderProgram, fragmentShader);\r\n\r\n        context.linkProgram(shaderProgram);\r\n\r\n        pipelineContext.context = context;\r\n        pipelineContext.vertexShader = vertexShader;\r\n        pipelineContext.fragmentShader = fragmentShader;\r\n\r\n        if (!pipelineContext.isParallelCompiled) {\r\n            this._finalizePipelineContext(pipelineContext);\r\n        }\r\n\r\n        return shaderProgram;\r\n    }\r\n\r\n    protected _finalizePipelineContext(pipelineContext: WebGLPipelineContext) {\r\n        const context = pipelineContext.context!;\r\n        const vertexShader = pipelineContext.vertexShader!;\r\n        const fragmentShader = pipelineContext.fragmentShader!;\r\n        const program = pipelineContext.program!;\r\n\r\n        var linked = context.getProgramParameter(program, context.LINK_STATUS);\r\n        if (!linked) { // Get more info\r\n            // Vertex\r\n            if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\r\n                const log = this._gl.getShaderInfoLog(vertexShader);\r\n                if (log) {\r\n                    pipelineContext.vertexCompilationError = log;\r\n                    throw new Error(\"VERTEX SHADER \" + log);\r\n                }\r\n            }\r\n\r\n            // Fragment\r\n            if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\r\n                const log = this._gl.getShaderInfoLog(fragmentShader);\r\n                if (log) {\r\n                    pipelineContext.fragmentCompilationError = log;\r\n                    throw new Error(\"FRAGMENT SHADER \" + log);\r\n                }\r\n            }\r\n\r\n            var error = context.getProgramInfoLog(program);\r\n            if (error) {\r\n                pipelineContext.programLinkError = error;\r\n                throw new Error(error);\r\n            }\r\n        }\r\n\r\n        if (this.validateShaderPrograms) {\r\n            context.validateProgram(program);\r\n            var validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\r\n\r\n            if (!validated) {\r\n                var error = context.getProgramInfoLog(program);\r\n                if (error) {\r\n                    pipelineContext.programValidationError = error;\r\n                    throw new Error(error);\r\n                }\r\n            }\r\n        }\r\n\r\n        context.deleteShader(vertexShader);\r\n        context.deleteShader(fragmentShader);\r\n\r\n        pipelineContext.vertexShader = undefined;\r\n        pipelineContext.fragmentShader = undefined;\r\n\r\n        if (pipelineContext.onCompiled) {\r\n            pipelineContext.onCompiled();\r\n            pipelineContext.onCompiled = undefined;\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _preparePipelineContext(pipelineContext: IPipelineContext, vertexSourceCode: string, fragmentSourceCode: string, createAsRaw: boolean,\r\n        rebuildRebind: any,\r\n        defines: Nullable<string>,\r\n        transformFeedbackVaryings: Nullable<string[]>) {\r\n        let webGLRenderingState = pipelineContext as WebGLPipelineContext;\r\n\r\n        if (createAsRaw) {\r\n            webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\r\n        }\r\n        else {\r\n            webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\r\n        }\r\n        webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _isRenderingStateCompiled(pipelineContext: IPipelineContext): boolean {\r\n        let webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n        if (this._gl.getProgramParameter(webGLPipelineContext.program!, this._caps.parallelShaderCompile!.COMPLETION_STATUS_KHR)) {\r\n            this._finalizePipelineContext(webGLPipelineContext);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _executeWhenRenderingStateIsCompiled(pipelineContext: IPipelineContext, action: () => void) {\r\n        let webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        if (!webGLPipelineContext.isParallelCompiled) {\r\n            action();\r\n            return;\r\n        }\r\n\r\n        let oldHandler = webGLPipelineContext.onCompiled;\r\n\r\n        if (oldHandler) {\r\n            webGLPipelineContext.onCompiled = () => {\r\n                oldHandler!();\r\n                action();\r\n            };\r\n        } else {\r\n            webGLPipelineContext.onCompiled = action;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param uniformsNames defines the list of uniform names\r\n     * @returns an array of webGL uniform locations\r\n     */\r\n    public getUniforms(pipelineContext: IPipelineContext, uniformsNames: string[]): Nullable<WebGLUniformLocation>[] {\r\n        var results = new Array<Nullable<WebGLUniformLocation>>();\r\n        let webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        for (var index = 0; index < uniformsNames.length; index++) {\r\n            results.push(this._gl.getUniformLocation(webGLPipelineContext.program!, uniformsNames[index]));\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /**\r\n     * Gets the lsit of active attributes for a given webGL program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param attributesNames defines the list of attribute names to get\r\n     * @returns an array of indices indicating the offset of each attribute\r\n     */\r\n    public getAttributes(pipelineContext: IPipelineContext, attributesNames: string[]): number[] {\r\n        var results = [];\r\n        let webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        for (var index = 0; index < attributesNames.length; index++) {\r\n            try {\r\n                results.push(this._gl.getAttribLocation(webGLPipelineContext.program!, attributesNames[index]));\r\n            } catch (e) {\r\n                results.push(-1);\r\n            }\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /**\r\n     * Activates an effect, mkaing it the current one (ie. the one used for rendering)\r\n     * @param effect defines the effect to activate\r\n     */\r\n    public enableEffect(effect: Nullable<Effect>): void {\r\n        if (!effect || effect === this._currentEffect) {\r\n            return;\r\n        }\r\n\r\n        // Use program\r\n        this.bindSamplers(effect);\r\n\r\n        this._currentEffect = effect;\r\n\r\n        if (effect.onBind) {\r\n            effect.onBind(effect);\r\n        }\r\n        if (effect._onBindObservable) {\r\n            effect._onBindObservable.notifyObservers(effect);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a number (int)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the int number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt(uniform: Nullable<WebGLUniformLocation>, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1i(uniform, value);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1iv(uniform, array);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray2(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray3(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray4(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1fv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray2(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray3(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray4(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of float32 (stored as matrices)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrices defines the array of float32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrices(uniform: Nullable<WebGLUniformLocation>, matrices: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix4fv(uniform, false, matrices);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a matrix (3x3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 3x3 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrix3x3(uniform: Nullable<WebGLUniformLocation>, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix3fv(uniform, false, matrix);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a matrix (2x2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 2x2 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrix2x2(uniform: Nullable<WebGLUniformLocation>, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix2fv(uniform, false, matrix);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a number (float)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the float number to store\r\n     * @returns true if the value was transfered\r\n     */\r\n    public setFloat(uniform: Nullable<WebGLUniformLocation>, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1f(uniform, value);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec2\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat2(uniform: Nullable<WebGLUniformLocation>, x: number, y: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2f(uniform, x, y);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec3\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat3(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3f(uniform, x, y, z);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec4\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @param w defines the 4th component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat4(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number, w: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4f(uniform, x, y, z, w);\r\n\r\n        return true;\r\n    }\r\n\r\n    // States\r\n\r\n    /**\r\n     * Apply all cached states (depth, culling, stencil and alpha)\r\n     */\r\n    public applyStates() {\r\n        this._depthCullingState.apply(this._gl);\r\n        this._stencilState.apply(this._gl);\r\n        this._alphaState.apply(this._gl);\r\n\r\n        if (this._colorWriteChanged) {\r\n            this._colorWriteChanged = false;\r\n            const enable = this._colorWrite;\r\n            this._gl.colorMask(enable, enable, enable, enable);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Enable or disable color writing\r\n     * @param enable defines the state to set\r\n     */\r\n    public setColorWrite(enable: boolean): void {\r\n        if (enable !== this._colorWrite) {\r\n            this._colorWriteChanged = true;\r\n            this._colorWrite = enable;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if color writing is enabled\r\n     * @returns the current color writing state\r\n     */\r\n    public getColorWrite(): boolean {\r\n        return this._colorWrite;\r\n    }\r\n\r\n    /**\r\n     * Gets the depth culling state manager\r\n     */\r\n    public get depthCullingState(): DepthCullingState {\r\n        return this._depthCullingState;\r\n    }\r\n\r\n    /**\r\n     * Gets the alpha state manager\r\n     */\r\n    public get alphaState(): AlphaState {\r\n        return this._alphaState;\r\n    }\r\n\r\n    /**\r\n     * Gets the stencil state manager\r\n     */\r\n    public get stencilState(): StencilState {\r\n        return this._stencilState;\r\n    }\r\n\r\n    // Textures\r\n\r\n    /**\r\n     * Clears the list of texture accessible through engine.\r\n     * This can help preventing texture load conflict due to name collision.\r\n     */\r\n    public clearInternalTexturesCache() {\r\n        this._internalTexturesCache = [];\r\n    }\r\n\r\n    /**\r\n     * Force the entire cache to be cleared\r\n     * You should not have to use this function unless your engine needs to share the webGL context with another engine\r\n     * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\r\n     */\r\n    public wipeCaches(bruteForce?: boolean): void {\r\n        if (this.preventCacheWipeBetweenFrames && !bruteForce) {\r\n            return;\r\n        }\r\n        this._currentEffect = null;\r\n        this._viewportCached.x = 0;\r\n        this._viewportCached.y = 0;\r\n        this._viewportCached.z = 0;\r\n        this._viewportCached.w = 0;\r\n\r\n        // Done before in case we clean the attributes\r\n        this._unbindVertexArrayObject();\r\n\r\n        if (bruteForce) {\r\n            this._currentProgram = null;\r\n            this.resetTextureCache();\r\n\r\n            this._stencilState.reset();\r\n\r\n            this._depthCullingState.reset();\r\n            this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n\r\n            this._alphaState.reset();\r\n            this._alphaMode = 1;\r\n            this._alphaEquation = 0;\r\n\r\n            this._colorWrite = true;\r\n            this._colorWriteChanged = true;\r\n\r\n            this._unpackFlipYCached = null;\r\n\r\n            this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n            this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\r\n\r\n            this._mustWipeVertexAttributes = true;\r\n            this.unbindAllAttributes();\r\n        }\r\n\r\n        this._resetVertexBufferBinding();\r\n        this._cachedIndexBuffer = null;\r\n        this._cachedEffectForVertexBuffers = null;\r\n        this.bindIndexBuffer(null);\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getSamplingParameters(samplingMode: number, generateMipMaps: boolean): { min: number; mag: number } {\r\n        var gl = this._gl;\r\n        var magFilter = gl.NEAREST;\r\n        var minFilter = gl.NEAREST;\r\n\r\n        switch (samplingMode) {\r\n            case 11:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 3:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 8:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 4:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 5:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 6:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 7:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case 1:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n            case 9:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 10:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 2:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case 12:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n        }\r\n\r\n        return {\r\n            min: minFilter,\r\n            mag: magFilter\r\n        };\r\n    }\r\n\r\n    /** @hidden */\r\n    public _createTexture(): WebGLTexture {\r\n        let texture = this._gl.createTexture();\r\n\r\n        if (!texture) {\r\n            throw new Error(\"Unable to create texture\");\r\n        }\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * Usually called from Texture.ts.\r\n     * Passed information to create a WebGLTexture\r\n     * @param url defines a value which contains one of the following:\r\n     * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n     * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n     * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n     * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n     * @param scene needed for loading to the correct scene\r\n     * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n     * @param onLoad optional callback to be called upon successful completion\r\n     * @param onError optional callback to be called upon failure\r\n     * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n     * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n     * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param mimeType defines an optional mime type\r\n     * @param loaderOptions options to be passed to the loader\r\n     * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n     */\r\n    public createTexture(url: Nullable<string>, noMipmap: boolean, invertY: boolean, scene: Nullable<ISceneLike>, samplingMode: number = 3,\r\n        onLoad: Nullable<() => void> = null, onError: Nullable<(message: string, exception: any) => void> = null,\r\n        buffer: Nullable<string | ArrayBuffer | ArrayBufferView | HTMLImageElement | Blob | ImageBitmap> = null, fallback: Nullable<InternalTexture> = null, format: Nullable<number> = null,\r\n        forcedExtension: Nullable<string> = null, mimeType?: string, loaderOptions?: any): InternalTexture {\r\n        url = url || \"\";\r\n        const fromData = url.substr(0, 5) === \"data:\";\r\n        const fromBlob = url.substr(0, 5) === \"blob:\";\r\n        const isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\r\n\r\n        let texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\r\n\r\n        const originalUrl = url;\r\n        if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\r\n            url = this._transformTextureUrl(url);\r\n        }\r\n\r\n        if (originalUrl !== url) {\r\n            texture._originalUrl = originalUrl;\r\n        }\r\n\r\n        // establish the file extension, if possible\r\n        const lastDot = url.lastIndexOf('.');\r\n        let extension = forcedExtension ? forcedExtension : (lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\");\r\n        let loader: Nullable<IInternalTextureLoader> = null;\r\n\r\n        // Remove query string\r\n        let queryStringIndex = extension.indexOf(\"?\");\r\n\r\n        if (queryStringIndex > -1) {\r\n            extension = extension.split(\"?\")[0];\r\n        }\r\n\r\n        for (const availableLoader of ThinEngine._TextureLoaders) {\r\n            if (availableLoader.canLoad(extension, mimeType)) {\r\n                loader = availableLoader;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (scene) {\r\n            scene._addPendingData(texture);\r\n        }\r\n        texture.url = url;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture.samplingMode = samplingMode;\r\n        texture.invertY = invertY;\r\n\r\n        if (!this._doNotHandleContextLost) {\r\n            // Keep a link to the buffer only if we plan to handle context lost\r\n            texture._buffer = buffer;\r\n        }\r\n\r\n        let onLoadObserver: Nullable<Observer<InternalTexture>> = null;\r\n        if (onLoad && !fallback) {\r\n            onLoadObserver = texture.onLoadedObservable.add(onLoad);\r\n        }\r\n\r\n        if (!fallback) { this._internalTexturesCache.push(texture); }\r\n\r\n        const onInternalError = (message?: string, exception?: any) => {\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n\r\n            if (url === originalUrl) {\r\n                if (onLoadObserver) {\r\n                    texture.onLoadedObservable.remove(onLoadObserver);\r\n                }\r\n\r\n                if (EngineStore.UseFallbackTexture) {\r\n                    this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\r\n                }\r\n\r\n                if (onError) {\r\n                    onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\r\n                }\r\n            }\r\n            else {\r\n                // fall back to the original url if the transformed url fails to load\r\n                Logger.Warn(`Failed to load ${url}, falling back to ${originalUrl}`);\r\n                this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\r\n            }\r\n        };\r\n\r\n        // processing for non-image formats\r\n        if (loader) {\r\n            const callback = (data: ArrayBufferView) => {\r\n                loader!.loadData(data, texture, (width: number, height: number, loadMipmap: boolean, isCompressed: boolean, done: () => void, loadFailed) => {\r\n                    if (loadFailed) {\r\n                        onInternalError(\"TextureLoader failed to load data\");\r\n                    } else {\r\n                        this._prepareWebGLTexture(texture, scene, width, height, texture.invertY, !loadMipmap, isCompressed, () => {\r\n                            done();\r\n                            return false;\r\n                        }, samplingMode);\r\n                    }\r\n                }, loaderOptions);\r\n            };\r\n\r\n            if (!buffer) {\r\n                this._loadFile(url, (data) => callback(new Uint8Array(data as ArrayBuffer)), undefined, scene ? scene.offlineProvider : undefined, true, (request?: IWebRequest, exception?: any) => {\r\n                    onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\r\n                });\r\n            } else {\r\n                if (buffer instanceof ArrayBuffer) {\r\n                    callback(new Uint8Array(buffer));\r\n                }\r\n                else if (ArrayBuffer.isView(buffer)) {\r\n                    callback(buffer);\r\n                }\r\n                else {\r\n                    if (onError) {\r\n                        onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            const onload = (img: HTMLImageElement | ImageBitmap) => {\r\n                if (fromBlob && !this._doNotHandleContextLost) {\r\n                    // We need to store the image if we need to rebuild the texture\r\n                    // in case of a webgl context lost\r\n                    texture._buffer = img;\r\n                }\r\n\r\n                this._prepareWebGLTexture(texture, scene, img.width, img.height, texture.invertY, noMipmap, false, (potWidth, potHeight, continuationCallback) => {\r\n                    let gl = this._gl;\r\n                    var isPot = (img.width === potWidth && img.height === potHeight);\r\n                    let internalFormat = format ? this._getInternalFormat(format) : ((extension === \".jpg\") ? gl.RGB : gl.RGBA);\r\n\r\n                    if (isPot) {\r\n                        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\r\n                        return false;\r\n                    }\r\n\r\n                    let maxTextureSize = this._caps.maxTextureSize;\r\n\r\n                    if (img.width > maxTextureSize || img.height > maxTextureSize || !this._supportsHardwareTextureRescaling) {\r\n                        this._prepareWorkingCanvas();\r\n                        if (!this._workingCanvas || !this._workingContext) {\r\n                            return false;\r\n                        }\r\n\r\n                        this._workingCanvas.width = potWidth;\r\n                        this._workingCanvas.height = potHeight;\r\n\r\n                        this._workingContext.drawImage(img, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\r\n                        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, this._workingCanvas);\r\n\r\n                        texture.width = potWidth;\r\n                        texture.height = potHeight;\r\n\r\n                        return false;\r\n                    } else {\r\n                        // Using shaders when possible to rescale because canvas.drawImage is lossy\r\n                        let source = new InternalTexture(this, InternalTextureSource.Temp);\r\n                        this._bindTextureDirectly(gl.TEXTURE_2D, source, true);\r\n                        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\r\n\r\n                        this._rescaleTexture(source, texture, scene, internalFormat, () => {\r\n                            this._releaseTexture(source);\r\n                            this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n\r\n                            continuationCallback();\r\n                        });\r\n                    }\r\n\r\n                    return true;\r\n                }, samplingMode);\r\n            };\r\n\r\n            if (!fromData || isBase64) {\r\n                if (buffer && ((<HTMLImageElement>buffer).decoding || (<ImageBitmap>buffer).close)) {\r\n                    onload(<HTMLImageElement>buffer);\r\n                } else {\r\n                    ThinEngine._FileToolsLoadImage(url, onload, onInternalError, scene ? scene.offlineProvider : null, mimeType);\r\n                }\r\n            }\r\n            else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\r\n                ThinEngine._FileToolsLoadImage(buffer, onload, onInternalError, scene ? scene.offlineProvider : null, mimeType);\r\n            }\r\n            else if (buffer) {\r\n                onload(buffer);\r\n            }\r\n        }\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * Loads an image as an HTMLImageElement.\r\n     * @param input url string, ArrayBuffer, or Blob to load\r\n     * @param onLoad callback called when the image successfully loads\r\n     * @param onError callback called when the image fails to load\r\n     * @param offlineProvider offline provider for caching\r\n     * @param mimeType optional mime type\r\n     * @returns the HTMLImageElement of the loaded image\r\n     * @hidden\r\n     */\r\n    public static _FileToolsLoadImage(input: string | ArrayBuffer | ArrayBufferView | Blob, onLoad: (img: HTMLImageElement | ImageBitmap) => void, onError: (message?: string, exception?: any) => void, offlineProvider: Nullable<IOfflineProvider>, mimeType?: string): Nullable<HTMLImageElement> {\r\n        throw _DevTools.WarnImport(\"FileTools\");\r\n    }\r\n\r\n    /**\r\n     * @hidden\r\n     */\r\n    public _rescaleTexture(source: InternalTexture, destination: InternalTexture, scene: Nullable<any>, internalFormat: number, onComplete: () => void): void {\r\n    }\r\n\r\n    /**\r\n     * Creates a raw texture\r\n     * @param data defines the data to store in the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param format defines the format of the data\r\n     * @param generateMipMaps defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\r\n     * @param compression defines the compression used (null by default)\r\n     * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\r\n     * @returns the raw texture inside an InternalTexture\r\n     */\r\n    public createRawTexture(data: Nullable<ArrayBufferView>, width: number, height: number, format: number, generateMipMaps: boolean, invertY: boolean, samplingMode: number, compression: Nullable<string> = null, type: number = 0): InternalTexture {\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw cube texture\r\n     * @param data defines the array of data to use to create each face\r\n     * @param size defines the size of the textures\r\n     * @param format defines the format of the data\r\n     * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\r\n     * @param generateMipMaps  defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compression used (null by default)\r\n     * @returns the cube texture as an InternalTexture\r\n     */\r\n    public createRawCubeTexture(data: Nullable<ArrayBufferView[]>, size: number, format: number, type: number,\r\n        generateMipMaps: boolean, invertY: boolean, samplingMode: number,\r\n        compression: Nullable<string> = null): InternalTexture {\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw 3D texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the depth of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 3D texture (stored in an InternalTexture)\r\n     */\r\n    public createRawTexture3D(data: Nullable<ArrayBufferView>, width: number, height: number, depth: number, format: number, generateMipMaps: boolean, invertY: boolean, samplingMode: number, compression: Nullable<string> = null, textureType = 0): InternalTexture {\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw 2D array texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the number of layers of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 2D array texture (stored in an InternalTexture)\r\n     */\r\n    public createRawTexture2DArray(data: Nullable<ArrayBufferView>, width: number, height: number, depth: number, format: number, generateMipMaps: boolean, invertY: boolean, samplingMode: number, compression: Nullable<string> = null, textureType = 0): InternalTexture {\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    private _unpackFlipYCached: Nullable<boolean> = null;\r\n\r\n    /**\r\n     * In case you are sharing the context with other applications, it might\r\n     * be interested to not cache the unpack flip y state to ensure a consistent\r\n     * value would be set.\r\n     */\r\n    public enableUnpackFlipYCached = true;\r\n\r\n    /** @hidden */\r\n    public _unpackFlipY(value: boolean): void {\r\n        if (this._unpackFlipYCached !== value) {\r\n            this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\r\n\r\n            if (this.enableUnpackFlipYCached) {\r\n                this._unpackFlipYCached = value;\r\n            }\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getUnpackAlignement(): number {\r\n        return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\r\n    }\r\n\r\n    private _getTextureTarget(texture: InternalTexture): number {\r\n        if (texture.isCube) {\r\n            return this._gl.TEXTURE_CUBE_MAP;\r\n        } else if (texture.is3D) {\r\n            return this._gl.TEXTURE_3D;\r\n        } else if (texture.is2DArray || texture.isMultiview) {\r\n            return this._gl.TEXTURE_2D_ARRAY;\r\n        }\r\n        return this._gl.TEXTURE_2D;\r\n    }\r\n\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param samplingMode defines the required sampling mode\r\n     * @param texture defines the texture to update\r\n     * @param generateMipMaps defines whether to generate mipmaps for the texture\r\n     */\r\n    public updateTextureSamplingMode(samplingMode: number, texture: InternalTexture, generateMipMaps: boolean = false): void {\r\n        const target = this._getTextureTarget(texture);\r\n        var filters = this._getSamplingParameters(samplingMode, texture.generateMipMaps || generateMipMaps);\r\n\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\r\n\r\n        if (generateMipMaps) {\r\n            texture.generateMipMaps = true;\r\n            this._gl.generateMipmap(target);\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n\r\n        texture.samplingMode = samplingMode;\r\n    }\r\n\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param texture defines the texture to update\r\n     * @param wrapU defines the texture wrap mode of the u coordinates\r\n     * @param wrapV defines the texture wrap mode of the v coordinates\r\n     * @param wrapR defines the texture wrap mode of the r coordinates\r\n     */\r\n    public updateTextureWrappingMode(texture: InternalTexture, wrapU: Nullable<number>, wrapV: Nullable<number> = null, wrapR: Nullable<number> = null): void {\r\n        const target = this._getTextureTarget(texture);\r\n\r\n        if (wrapU !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\r\n            texture._cachedWrapU = wrapU;\r\n        }\r\n        if (wrapV !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\r\n            texture._cachedWrapV = wrapV;\r\n        }\r\n        if ((texture.is2DArray || texture.is3D) && (wrapR !== null)) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\r\n            texture._cachedWrapR = wrapR;\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n    }\r\n\r\n    /** @hidden */\r\n    public _setupDepthStencilTexture(internalTexture: InternalTexture, size: number | { width: number, height: number, layers?: number }, generateStencil: boolean, bilinearFiltering: boolean, comparisonFunction: number): void {\r\n        const width = (<{ width: number, height: number, layers?: number }>size).width || <number>size;\r\n        const height = (<{ width: number, height: number, layers?: number }>size).height || <number>size;\r\n        const layers = (<{ width: number, height: number, layers?: number }>size).layers || 0;\r\n\r\n        internalTexture.baseWidth = width;\r\n        internalTexture.baseHeight = height;\r\n        internalTexture.width = width;\r\n        internalTexture.height = height;\r\n        internalTexture.is2DArray = layers > 0;\r\n        internalTexture.depth = layers;\r\n        internalTexture.isReady = true;\r\n        internalTexture.samples = 1;\r\n        internalTexture.generateMipMaps = false;\r\n        internalTexture._generateDepthBuffer = true;\r\n        internalTexture._generateStencilBuffer = generateStencil;\r\n        internalTexture.samplingMode = bilinearFiltering ? 2 : 1;\r\n        internalTexture.type = 0;\r\n        internalTexture._comparisonFunction = comparisonFunction;\r\n\r\n        const gl = this._gl;\r\n        const target = this._getTextureTarget(internalTexture);\r\n        const samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\r\n        gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\r\n        gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n        if (comparisonFunction === 0) {\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, 515);\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\r\n        }\r\n        else {\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _uploadCompressedDataToTextureDirectly(texture: InternalTexture, internalFormat: number, width: number, height: number, data: ArrayBufferView, faceIndex: number = 0, lod: number = 0) {\r\n        var gl = this._gl;\r\n\r\n        var target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, <DataView>data);\r\n    }\r\n\r\n    /** @hidden */\r\n    public _uploadDataToTextureDirectly(texture: InternalTexture, imageData: ArrayBufferView, faceIndex: number = 0, lod: number = 0, babylonInternalFormat?: number, useTextureWidthAndHeight = false): void {\r\n        var gl = this._gl;\r\n\r\n        var textureType = this._getWebGLTextureType(texture.type);\r\n        var format = this._getInternalFormat(texture.format);\r\n        var internalFormat = babylonInternalFormat === undefined ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format) : this._getInternalFormat(babylonInternalFormat);\r\n\r\n        this._unpackFlipY(texture.invertY);\r\n\r\n        var target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        const lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\r\n        const lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\r\n        const width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\r\n        const height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\r\n\r\n        gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\r\n    }\r\n\r\n    /**\r\n     * Update a portion of an internal texture\r\n     * @param texture defines the texture to update\r\n     * @param imageData defines the data to store into the texture\r\n     * @param xOffset defines the x coordinates of the update rectangle\r\n     * @param yOffset defines the y coordinates of the update rectangle\r\n     * @param width defines the width of the update rectangle\r\n     * @param height defines the height of the update rectangle\r\n     * @param faceIndex defines the face index if texture is a cube (0 by default)\r\n     * @param lod defines the lod level to update (0 by default)\r\n     */\r\n    public updateTextureData(texture: InternalTexture, imageData: ArrayBufferView, xOffset: number, yOffset: number, width: number, height: number, faceIndex: number = 0, lod: number = 0): void {\r\n        var gl = this._gl;\r\n\r\n        var textureType = this._getWebGLTextureType(texture.type);\r\n        var format = this._getInternalFormat(texture.format);\r\n\r\n        this._unpackFlipY(texture.invertY);\r\n\r\n        var target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\r\n    }\r\n\r\n    /** @hidden */\r\n    public _uploadArrayBufferViewToTexture(texture: InternalTexture, imageData: ArrayBufferView, faceIndex: number = 0, lod: number = 0): void {\r\n        var gl = this._gl;\r\n        var bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\r\n\r\n        this._bindTextureDirectly(bindTarget, texture, true);\r\n\r\n        this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\r\n\r\n        this._bindTextureDirectly(bindTarget, null, true);\r\n    }\r\n\r\n    protected _prepareWebGLTextureContinuation(texture: InternalTexture, scene: Nullable<ISceneLike>, noMipmap: boolean, isCompressed: boolean, samplingMode: number): void {\r\n        var gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n\r\n        var filters = this._getSamplingParameters(samplingMode, !noMipmap);\r\n\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\r\n\r\n        if (!noMipmap && !isCompressed) {\r\n            gl.generateMipmap(gl.TEXTURE_2D);\r\n        }\r\n\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, null);\r\n\r\n        // this.resetTextureCache();\r\n        if (scene) {\r\n            scene._removePendingData(texture);\r\n        }\r\n\r\n        texture.onLoadedObservable.notifyObservers(texture);\r\n        texture.onLoadedObservable.clear();\r\n    }\r\n\r\n    private _prepareWebGLTexture(texture: InternalTexture, scene: Nullable<ISceneLike>, width: number, height: number, invertY: boolean, noMipmap: boolean, isCompressed: boolean,\r\n        processFunction: (width: number, height: number, continuationCallback: () => void) => boolean, samplingMode: number = 3): void {\r\n        var maxTextureSize = this.getCaps().maxTextureSize;\r\n        var potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(width, maxTextureSize) : width);\r\n        var potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(height, maxTextureSize) : height);\r\n\r\n        var gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n\r\n        if (!texture._webGLTexture) {\r\n            //  this.resetTextureCache();\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n        this._unpackFlipY(invertY === undefined ? true : (invertY ? true : false));\r\n\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.width = potWidth;\r\n        texture.height = potHeight;\r\n        texture.isReady = true;\r\n\r\n        if (processFunction(potWidth, potHeight, () => {\r\n            this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n        })) {\r\n            // Returning as texture needs extra async steps\r\n            return;\r\n        }\r\n\r\n        this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n    }\r\n\r\n    /** @hidden */\r\n    public _setupFramebufferDepthAttachments(generateStencilBuffer: boolean, generateDepthBuffer: boolean, width: number, height: number, samples = 1): Nullable<WebGLRenderbuffer> {\r\n        var gl = this._gl;\r\n\r\n        // Create the depth/stencil buffer\r\n        if (generateStencilBuffer && generateDepthBuffer) {\r\n            return this._getDepthStencilBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\r\n        }\r\n        if (generateDepthBuffer) {\r\n            let depthFormat = gl.DEPTH_COMPONENT16;\r\n            if (this._webGLVersion > 1) {\r\n                depthFormat = gl.DEPTH_COMPONENT32F;\r\n            }\r\n\r\n            return this._getDepthStencilBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\r\n        }\r\n        if (generateStencilBuffer) {\r\n            return this._getDepthStencilBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    private _getDepthStencilBuffer = (width: number, height: number, samples: number, internalFormat: number, msInternalFormat: number, attachment: number) => {\r\n        var gl = this._gl;\r\n        const depthStencilBuffer = gl.createRenderbuffer();\r\n\r\n        gl.bindRenderbuffer(gl.RENDERBUFFER, depthStencilBuffer);\r\n\r\n        if (samples > 1 && gl.renderbufferStorageMultisample) {\r\n            gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\r\n        } else {\r\n            gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\r\n        }\r\n\r\n        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, depthStencilBuffer);\r\n\r\n        gl.bindRenderbuffer(gl.RENDERBUFFER, null);\r\n\r\n        return depthStencilBuffer;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _releaseFramebufferObjects(texture: InternalTexture): void {\r\n        var gl = this._gl;\r\n\r\n        if (texture._framebuffer) {\r\n            gl.deleteFramebuffer(texture._framebuffer);\r\n            texture._framebuffer = null;\r\n        }\r\n\r\n        if (texture._depthStencilBuffer) {\r\n            gl.deleteRenderbuffer(texture._depthStencilBuffer);\r\n            texture._depthStencilBuffer = null;\r\n        }\r\n\r\n        if (texture._MSAAFramebuffer) {\r\n            gl.deleteFramebuffer(texture._MSAAFramebuffer);\r\n            texture._MSAAFramebuffer = null;\r\n        }\r\n\r\n        if (texture._MSAARenderBuffer) {\r\n            gl.deleteRenderbuffer(texture._MSAARenderBuffer);\r\n            texture._MSAARenderBuffer = null;\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _releaseTexture(texture: InternalTexture): void {\r\n        this._releaseFramebufferObjects(texture);\r\n\r\n        this._deleteTexture(texture._webGLTexture);\r\n\r\n        // Unbind channels\r\n        this.unbindAllTextures();\r\n\r\n        var index = this._internalTexturesCache.indexOf(texture);\r\n        if (index !== -1) {\r\n            this._internalTexturesCache.splice(index, 1);\r\n        }\r\n\r\n        // Integrated fixed lod samplers.\r\n        if (texture._lodTextureHigh) {\r\n            texture._lodTextureHigh.dispose();\r\n        }\r\n        if (texture._lodTextureMid) {\r\n            texture._lodTextureMid.dispose();\r\n        }\r\n        if (texture._lodTextureLow) {\r\n            texture._lodTextureLow.dispose();\r\n        }\r\n\r\n        // Integrated irradiance map.\r\n        if (texture._irradianceTexture) {\r\n            texture._irradianceTexture.dispose();\r\n        }\r\n    }\r\n\r\n    protected _deleteTexture(texture: Nullable<WebGLTexture>): void {\r\n        this._gl.deleteTexture(texture);\r\n    }\r\n\r\n    protected _setProgram(program: WebGLProgram): void {\r\n        if (this._currentProgram !== program) {\r\n            this._gl.useProgram(program);\r\n            this._currentProgram = program;\r\n        }\r\n    }\r\n\r\n    protected _boundUniforms: { [key: number]: WebGLUniformLocation } = {};\r\n\r\n    /**\r\n     * Binds an effect to the webGL context\r\n     * @param effect defines the effect to bind\r\n     */\r\n    public bindSamplers(effect: Effect): void {\r\n        let webGLPipelineContext = effect.getPipelineContext() as WebGLPipelineContext;\r\n        this._setProgram(webGLPipelineContext.program!);\r\n        var samplers = effect.getSamplers();\r\n        for (var index = 0; index < samplers.length; index++) {\r\n            var uniform = effect.getUniform(samplers[index]);\r\n\r\n            if (uniform) {\r\n                this._boundUniforms[index] = uniform;\r\n            }\r\n        }\r\n        this._currentEffect = null;\r\n    }\r\n\r\n    private _activateCurrentTexture() {\r\n        if (this._currentTextureChannel !== this._activeChannel) {\r\n            this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\r\n            this._currentTextureChannel = this._activeChannel;\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _bindTextureDirectly(target: number, texture: Nullable<InternalTexture>, forTextureDataUpdate = false, force = false): boolean {\r\n        var wasPreviouslyBound = false;\r\n        let isTextureForRendering = texture && texture._associatedChannel > -1;\r\n        if (forTextureDataUpdate && isTextureForRendering) {\r\n            this._activeChannel = texture!._associatedChannel;\r\n        }\r\n\r\n        let currentTextureBound = this._boundTexturesCache[this._activeChannel];\r\n\r\n        if (currentTextureBound !== texture || force) {\r\n            this._activateCurrentTexture();\r\n\r\n            if (texture && texture.isMultiview) {\r\n                this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\r\n            } else {\r\n                this._gl.bindTexture(target, texture ? texture._webGLTexture : null);\r\n            }\r\n\r\n            this._boundTexturesCache[this._activeChannel] = texture;\r\n\r\n            if (texture) {\r\n                texture._associatedChannel = this._activeChannel;\r\n            }\r\n        } else if (forTextureDataUpdate) {\r\n            wasPreviouslyBound = true;\r\n            this._activateCurrentTexture();\r\n        }\r\n\r\n        if (isTextureForRendering && !forTextureDataUpdate) {\r\n            this._bindSamplerUniformToChannel(texture!._associatedChannel, this._activeChannel);\r\n        }\r\n\r\n        return wasPreviouslyBound;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _bindTexture(channel: number, texture: Nullable<InternalTexture>): void {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n\r\n        if (texture) {\r\n            texture._associatedChannel = channel;\r\n        }\r\n\r\n        this._activeChannel = channel;\r\n        const target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\r\n        this._bindTextureDirectly(target, texture);\r\n    }\r\n\r\n    /**\r\n     * Unbind all textures from the webGL context\r\n     */\r\n    public unbindAllTextures(): void {\r\n        for (var channel = 0; channel < this._maxSimultaneousTextures; channel++) {\r\n            this._activeChannel = channel;\r\n            this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n            this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n            if (this.webGLVersion > 1) {\r\n                this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a texture to the according uniform.\r\n     * @param channel The texture channel\r\n     * @param uniform The uniform to set\r\n     * @param texture The texture to apply\r\n     */\r\n    public setTexture(channel: number, uniform: Nullable<WebGLUniformLocation>, texture: Nullable<ThinTexture>): void {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n\r\n        if (uniform) {\r\n            this._boundUniforms[channel] = uniform;\r\n        }\r\n\r\n        this._setTexture(channel, texture);\r\n    }\r\n\r\n    private _bindSamplerUniformToChannel(sourceSlot: number, destination: number) {\r\n        let uniform = this._boundUniforms[sourceSlot];\r\n        if (!uniform || uniform._currentState === destination) {\r\n            return;\r\n        }\r\n        this._gl.uniform1i(uniform, destination);\r\n        uniform._currentState = destination;\r\n    }\r\n\r\n    private _getTextureWrapMode(mode: number): number {\r\n        switch (mode) {\r\n            case 1:\r\n                return this._gl.REPEAT;\r\n            case 0:\r\n                return this._gl.CLAMP_TO_EDGE;\r\n            case 2:\r\n                return this._gl.MIRRORED_REPEAT;\r\n        }\r\n        return this._gl.REPEAT;\r\n    }\r\n\r\n    protected _setTexture(channel: number, texture: Nullable<ThinTexture>, isPartOfTextureArray = false, depthStencilTexture = false): boolean {\r\n        // Not ready?\r\n        if (!texture) {\r\n            if (this._boundTexturesCache[channel] != null) {\r\n                this._activeChannel = channel;\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n                if (this.webGLVersion > 1) {\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n                }\r\n            }\r\n            return false;\r\n        }\r\n\r\n        // Video\r\n        if ((<VideoTexture>texture).video) {\r\n            this._activeChannel = channel;\r\n            (<VideoTexture>texture).update();\r\n        } else if (texture.delayLoadState === 4) { // Delay loading\r\n            texture.delayLoad();\r\n            return false;\r\n        }\r\n\r\n        let internalTexture: InternalTexture;\r\n        if (depthStencilTexture) {\r\n            internalTexture = (<RenderTargetTexture>texture).depthStencilTexture!;\r\n        }\r\n        else if (texture.isReady()) {\r\n            internalTexture = <InternalTexture>texture.getInternalTexture();\r\n        }\r\n        else if (texture.isCube) {\r\n            internalTexture = this.emptyCubeTexture;\r\n        }\r\n        else if (texture.is3D) {\r\n            internalTexture = this.emptyTexture3D;\r\n        }\r\n        else if (texture.is2DArray) {\r\n            internalTexture = this.emptyTexture2DArray;\r\n        }\r\n        else {\r\n            internalTexture = this.emptyTexture;\r\n        }\r\n\r\n        if (!isPartOfTextureArray && internalTexture) {\r\n            internalTexture._associatedChannel = channel;\r\n        }\r\n\r\n        let needToBind = true;\r\n        if (this._boundTexturesCache[channel] === internalTexture) {\r\n            if (!isPartOfTextureArray) {\r\n                this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\r\n            }\r\n\r\n            needToBind = false;\r\n        }\r\n\r\n        this._activeChannel = channel;\r\n        const target = this._getTextureTarget(internalTexture);\r\n        if (needToBind) {\r\n            this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\r\n        }\r\n\r\n        if (internalTexture && !internalTexture.isMultiview) {\r\n            // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\r\n            if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\r\n                internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\r\n\r\n                var textureWrapMode = (texture.coordinatesMode !== 3 && texture.coordinatesMode !== 5) ? 1 : 0;\r\n                texture.wrapU = textureWrapMode;\r\n                texture.wrapV = textureWrapMode;\r\n            }\r\n\r\n            if (internalTexture._cachedWrapU !== texture.wrapU) {\r\n                internalTexture._cachedWrapU = texture.wrapU;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\r\n            }\r\n\r\n            if (internalTexture._cachedWrapV !== texture.wrapV) {\r\n                internalTexture._cachedWrapV = texture.wrapV;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\r\n            }\r\n\r\n            if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\r\n                internalTexture._cachedWrapR = texture.wrapR;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\r\n            }\r\n\r\n            this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Sets an array of texture to the webGL context\r\n     * @param channel defines the channel where the texture array must be set\r\n     * @param uniform defines the associated uniform location\r\n     * @param textures defines the array of textures to bind\r\n     */\r\n    public setTextureArray(channel: number, uniform: Nullable<WebGLUniformLocation>, textures: ThinTexture[]): void {\r\n        if (channel === undefined || !uniform) {\r\n            return;\r\n        }\r\n\r\n        if (!this._textureUnits || this._textureUnits.length !== textures.length) {\r\n            this._textureUnits = new Int32Array(textures.length);\r\n        }\r\n        for (let i = 0; i < textures.length; i++) {\r\n            let texture = textures[i].getInternalTexture();\r\n\r\n            if (texture) {\r\n                this._textureUnits[i] = channel + i;\r\n                texture._associatedChannel = channel + i;\r\n            } else {\r\n                this._textureUnits[i] = -1;\r\n            }\r\n        }\r\n        this._gl.uniform1iv(uniform, this._textureUnits);\r\n\r\n        for (var index = 0; index < textures.length; index++) {\r\n            this._setTexture(this._textureUnits[index], textures[index], true);\r\n        }\r\n    }\r\n\r\n    /** @hidden */\r\n    public _setAnisotropicLevel(target: number, internalTexture: InternalTexture, anisotropicFilteringLevel: number) {\r\n        var anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\r\n        if (internalTexture.samplingMode !== 11\r\n            && internalTexture.samplingMode !== 3\r\n            && internalTexture.samplingMode !== 2) {\r\n            anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\r\n        }\r\n\r\n        if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\r\n            this._setTextureParameterFloat(target, anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT, Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy), internalTexture);\r\n            internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\r\n        }\r\n    }\r\n\r\n    private _setTextureParameterFloat(target: number, parameter: number, value: number, texture: InternalTexture): void {\r\n        this._bindTextureDirectly(target, texture, true, true);\r\n        this._gl.texParameterf(target, parameter, value);\r\n    }\r\n\r\n    private _setTextureParameterInteger(target: number, parameter: number, value: number, texture?: InternalTexture) {\r\n        if (texture) {\r\n            this._bindTextureDirectly(target, texture, true, true);\r\n        }\r\n        this._gl.texParameteri(target, parameter, value);\r\n    }\r\n\r\n    /**\r\n     * Unbind all vertex attributes from the webGL context\r\n     */\r\n    public unbindAllAttributes() {\r\n        if (this._mustWipeVertexAttributes) {\r\n            this._mustWipeVertexAttributes = false;\r\n\r\n            for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n                this.disableAttributeByIndex(i);\r\n            }\r\n            return;\r\n        }\r\n\r\n        for (var i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\r\n            if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\r\n                continue;\r\n            }\r\n\r\n            this.disableAttributeByIndex(i);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\r\n     */\r\n    public releaseEffects() {\r\n        for (var name in this._compiledEffects) {\r\n            let webGLPipelineContext = this._compiledEffects[name].getPipelineContext() as WebGLPipelineContext;\r\n            this._deletePipelineContext(webGLPipelineContext);\r\n        }\r\n\r\n        this._compiledEffects = {};\r\n    }\r\n\r\n    /**\r\n     * Dispose and release all associated resources\r\n     */\r\n    public dispose(): void {\r\n        this.stopRenderLoop();\r\n\r\n        // Clear observables\r\n        if (this.onBeforeTextureInitObservable) {\r\n            this.onBeforeTextureInitObservable.clear();\r\n        }\r\n\r\n        // Empty texture\r\n        if (this._emptyTexture) {\r\n            this._releaseTexture(this._emptyTexture);\r\n            this._emptyTexture = null;\r\n        }\r\n        if (this._emptyCubeTexture) {\r\n            this._releaseTexture(this._emptyCubeTexture);\r\n            this._emptyCubeTexture = null;\r\n        }\r\n\r\n        if (this._dummyFramebuffer) {\r\n            this._gl.deleteFramebuffer(this._dummyFramebuffer);\r\n        }\r\n\r\n        // Release effects\r\n        this.releaseEffects();\r\n\r\n        // Unbind\r\n        this.unbindAllAttributes();\r\n        this._boundUniforms = [];\r\n\r\n        // Events\r\n        if (DomManagement.IsWindowObjectExist()) {\r\n            if (this._renderingCanvas) {\r\n                if (!this._doNotHandleContextLost) {\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\r\n                }\r\n            }\r\n        }\r\n\r\n        this._workingCanvas = null;\r\n        this._workingContext = null;\r\n        this._currentBufferPointers = [];\r\n        this._renderingCanvas = null;\r\n        this._currentProgram = null;\r\n        this._boundRenderFunction = null;\r\n\r\n        Effect.ResetCache();\r\n\r\n        // Abort active requests\r\n        for (let request of this._activeRequests) {\r\n            request.abort();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attach a new callback raised when context lost event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    public attachContextLostEvent(callback: ((event: WebGLContextEvent) => void)): void {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextlost\", <any>callback, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attach a new callback raised when context restored event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    public attachContextRestoredEvent(callback: ((event: WebGLContextEvent) => void)): void {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextrestored\", <any>callback, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the current error code of the webGL context\r\n     * @returns the error code\r\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\r\n     */\r\n    public getError(): number {\r\n        return this._gl.getError();\r\n    }\r\n\r\n    private _canRenderToFloatFramebuffer(): boolean {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(1);\r\n    }\r\n\r\n    private _canRenderToHalfFloatFramebuffer(): boolean {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(2);\r\n    }\r\n\r\n    // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\r\n    private _canRenderToFramebuffer(type: number): boolean {\r\n        let gl = this._gl;\r\n\r\n        //clear existing errors\r\n        while (gl.getError() !== gl.NO_ERROR) { }\r\n\r\n        let successful = true;\r\n\r\n        let texture = gl.createTexture();\r\n        gl.bindTexture(gl.TEXTURE_2D, texture);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n\r\n        let fb = gl.createFramebuffer();\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\r\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\r\n        let status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\r\n\r\n        successful = successful && (status === gl.FRAMEBUFFER_COMPLETE);\r\n        successful = successful && (gl.getError() === gl.NO_ERROR);\r\n\r\n        //try render by clearing frame buffer's color buffer\r\n        if (successful) {\r\n            gl.clear(gl.COLOR_BUFFER_BIT);\r\n            successful = successful && (gl.getError() === gl.NO_ERROR);\r\n        }\r\n\r\n        //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\r\n        if (successful) {\r\n            //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            let readFormat = gl.RGBA;\r\n            let readType = gl.UNSIGNED_BYTE;\r\n            let buffer = new Uint8Array(4);\r\n            gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\r\n            successful = successful && (gl.getError() === gl.NO_ERROR);\r\n        }\r\n\r\n        //clean up\r\n        gl.deleteTexture(texture);\r\n        gl.deleteFramebuffer(fb);\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n\r\n        //clear accumulated errors\r\n        while (!successful && (gl.getError() !== gl.NO_ERROR)) { }\r\n\r\n        return successful;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getWebGLTextureType(type: number): number {\r\n        if (this._webGLVersion === 1) {\r\n            switch (type) {\r\n                case 1:\r\n                    return this._gl.FLOAT;\r\n                case 2:\r\n                    return this._gl.HALF_FLOAT_OES;\r\n                case 0:\r\n                    return this._gl.UNSIGNED_BYTE;\r\n                case 8:\r\n                    return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n                case 9:\r\n                    return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n                case 10:\r\n                    return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            }\r\n            return this._gl.UNSIGNED_BYTE;\r\n        }\r\n\r\n        switch (type) {\r\n            case 3:\r\n                return this._gl.BYTE;\r\n            case 0:\r\n                return this._gl.UNSIGNED_BYTE;\r\n            case 4:\r\n                return this._gl.SHORT;\r\n            case 5:\r\n                return this._gl.UNSIGNED_SHORT;\r\n            case 6:\r\n                return this._gl.INT;\r\n            case 7: // Refers to UNSIGNED_INT\r\n                return this._gl.UNSIGNED_INT;\r\n            case 1:\r\n                return this._gl.FLOAT;\r\n            case 2:\r\n                return this._gl.HALF_FLOAT;\r\n            case 8:\r\n                return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n            case 9:\r\n                return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n            case 10:\r\n                return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            case 11:\r\n                return this._gl.UNSIGNED_INT_2_10_10_10_REV;\r\n            case 12:\r\n                return this._gl.UNSIGNED_INT_24_8;\r\n            case 13:\r\n                return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\r\n            case 14:\r\n                return this._gl.UNSIGNED_INT_5_9_9_9_REV;\r\n            case 15:\r\n                return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\r\n        }\r\n\r\n        return this._gl.UNSIGNED_BYTE;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getInternalFormat(format: number): number {\r\n        var internalFormat = this._gl.RGBA;\r\n\r\n        switch (format) {\r\n            case 0:\r\n                internalFormat = this._gl.ALPHA;\r\n                break;\r\n            case 1:\r\n                internalFormat = this._gl.LUMINANCE;\r\n                break;\r\n            case 2:\r\n                internalFormat = this._gl.LUMINANCE_ALPHA;\r\n                break;\r\n            case 6:\r\n                internalFormat = this._gl.RED;\r\n                break;\r\n            case 7:\r\n                internalFormat = this._gl.RG;\r\n                break;\r\n            case 4:\r\n                internalFormat = this._gl.RGB;\r\n                break;\r\n            case 5:\r\n                internalFormat = this._gl.RGBA;\r\n                break;\r\n        }\r\n\r\n        if (this._webGLVersion > 1) {\r\n            switch (format) {\r\n                case 8:\r\n                    internalFormat = this._gl.RED_INTEGER;\r\n                    break;\r\n                case 9:\r\n                    internalFormat = this._gl.RG_INTEGER;\r\n                    break;\r\n                case 10:\r\n                    internalFormat = this._gl.RGB_INTEGER;\r\n                    break;\r\n                case 11:\r\n                    internalFormat = this._gl.RGBA_INTEGER;\r\n                    break;\r\n            }\r\n        }\r\n\r\n        return internalFormat;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getRGBABufferInternalSizedFormat(type: number, format?: number): number {\r\n        if (this._webGLVersion === 1) {\r\n            if (format !== undefined) {\r\n                switch (format) {\r\n                    case 0:\r\n                        return this._gl.ALPHA;\r\n                    case 1:\r\n                        return this._gl.LUMINANCE;\r\n                    case 2:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    case 4:\r\n                        return this._gl.RGB;\r\n                }\r\n            }\r\n            return this._gl.RGBA;\r\n        }\r\n\r\n        switch (type) {\r\n            case 3:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R8_SNORM;\r\n                    case 7:\r\n                        return this._gl.RG8_SNORM;\r\n                    case 4:\r\n                        return this._gl.RGB8_SNORM;\r\n                    case 8:\r\n                        return this._gl.R8I;\r\n                    case 9:\r\n                        return this._gl.RG8I;\r\n                    case 10:\r\n                        return this._gl.RGB8I;\r\n                    case 11:\r\n                        return this._gl.RGBA8I;\r\n                    default:\r\n                        return this._gl.RGBA8_SNORM;\r\n                }\r\n            case 0:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R8;\r\n                    case 7:\r\n                        return this._gl.RG8;\r\n                    case 4:\r\n                        return this._gl.RGB8; // By default. Other possibilities are RGB565, SRGB8.\r\n                    case 5:\r\n                        return this._gl.RGBA8; // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\r\n                    case 8:\r\n                        return this._gl.R8UI;\r\n                    case 9:\r\n                        return this._gl.RG8UI;\r\n                    case 10:\r\n                        return this._gl.RGB8UI;\r\n                    case 11:\r\n                        return this._gl.RGBA8UI;\r\n                    case 0:\r\n                        return this._gl.ALPHA;\r\n                    case 1:\r\n                        return this._gl.LUMINANCE;\r\n                    case 2:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    default:\r\n                        return this._gl.RGBA8;\r\n                }\r\n            case 4:\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R16I;\r\n                    case 9:\r\n                        return this._gl.RG16I;\r\n                    case 10:\r\n                        return this._gl.RGB16I;\r\n                    case 11:\r\n                        return this._gl.RGBA16I;\r\n                    default:\r\n                        return this._gl.RGBA16I;\r\n                }\r\n            case 5:\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R16UI;\r\n                    case 9:\r\n                        return this._gl.RG16UI;\r\n                    case 10:\r\n                        return this._gl.RGB16UI;\r\n                    case 11:\r\n                        return this._gl.RGBA16UI;\r\n                    default:\r\n                        return this._gl.RGBA16UI;\r\n                }\r\n            case 6:\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R32I;\r\n                    case 9:\r\n                        return this._gl.RG32I;\r\n                    case 10:\r\n                        return this._gl.RGB32I;\r\n                    case 11:\r\n                        return this._gl.RGBA32I;\r\n                    default:\r\n                        return this._gl.RGBA32I;\r\n                }\r\n            case 7: // Refers to UNSIGNED_INT\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R32UI;\r\n                    case 9:\r\n                        return this._gl.RG32UI;\r\n                    case 10:\r\n                        return this._gl.RGB32UI;\r\n                    case 11:\r\n                        return this._gl.RGBA32UI;\r\n                    default:\r\n                        return this._gl.RGBA32UI;\r\n                }\r\n            case 1:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R32F; // By default. Other possibility is R16F.\r\n                    case 7:\r\n                        return this._gl.RG32F; // By default. Other possibility is RG16F.\r\n                    case 4:\r\n                        return this._gl.RGB32F; // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\r\n                    case 5:\r\n                        return this._gl.RGBA32F; // By default. Other possibility is RGBA16F.\r\n                    default:\r\n                        return this._gl.RGBA32F;\r\n                }\r\n            case 2:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R16F;\r\n                    case 7:\r\n                        return this._gl.RG16F;\r\n                    case 4:\r\n                        return this._gl.RGB16F; // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\r\n                    case 5:\r\n                        return this._gl.RGBA16F;\r\n                    default:\r\n                        return this._gl.RGBA16F;\r\n                }\r\n            case 10:\r\n                return this._gl.RGB565;\r\n            case 13:\r\n                return this._gl.R11F_G11F_B10F;\r\n            case 14:\r\n                return this._gl.RGB9_E5;\r\n            case 8:\r\n                return this._gl.RGBA4;\r\n            case 9:\r\n                return this._gl.RGB5_A1;\r\n            case 11:\r\n                switch (format) {\r\n                    case 5:\r\n                        return this._gl.RGB10_A2; // By default. Other possibility is RGB5_A1.\r\n                    case 11:\r\n                        return this._gl.RGB10_A2UI;\r\n                    default:\r\n                        return this._gl.RGB10_A2;\r\n                }\r\n        }\r\n\r\n        return this._gl.RGBA8;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _getRGBAMultiSampleBufferFormat(type: number): number {\r\n        if (type === 1) {\r\n            return this._gl.RGBA32F;\r\n        }\r\n        else if (type === 2) {\r\n            return this._gl.RGBA16F;\r\n        }\r\n\r\n        return this._gl.RGBA8;\r\n    }\r\n\r\n    /** @hidden */\r\n    public _loadFile(url: string, onSuccess: (data: string | ArrayBuffer, responseURL?: string) => void, onProgress?: (data: any) => void,\r\n        offlineProvider?: IOfflineProvider, useArrayBuffer?: boolean, onError?: (request?: IWebRequest, exception?: any) => void): IFileRequest {\r\n        let request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\r\n        this._activeRequests.push(request);\r\n        request.onCompleteObservable.add((request) => {\r\n            this._activeRequests.splice(this._activeRequests.indexOf(request), 1);\r\n        });\r\n        return request;\r\n    }\r\n\r\n    /**\r\n     * Loads a file from a url\r\n     * @param url url to load\r\n     * @param onSuccess callback called when the file successfully loads\r\n     * @param onProgress callback called while file is loading (if the server supports this mode)\r\n     * @param offlineProvider defines the offline provider for caching\r\n     * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\r\n     * @param onError callback called when the file fails to load\r\n     * @returns a file request object\r\n     * @hidden\r\n     */\r\n    public static _FileToolsLoadFile(url: string, onSuccess: (data: string | ArrayBuffer, responseURL?: string) => void, onProgress?: (ev: ProgressEvent) => void, offlineProvider?: IOfflineProvider, useArrayBuffer?: boolean, onError?: (request?: WebRequest, exception?: LoadFileError) => void): IFileRequest {\r\n        throw  _DevTools.WarnImport(\"FileTools\");\r\n    }\r\n\r\n    /**\r\n     * Reads pixels from the current frame buffer. Please note that this function can be slow\r\n     * @param x defines the x coordinate of the rectangle where pixels must be read\r\n     * @param y defines the y coordinate of the rectangle where pixels must be read\r\n     * @param width defines the width of the rectangle where pixels must be read\r\n     * @param height defines the height of the rectangle where pixels must be read\r\n     * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\r\n     * @returns a Uint8Array containing RGBA colors\r\n     */\r\n    public readPixels(x: number, y: number, width: number, height: number, hasAlpha = true): Uint8Array {\r\n        const numChannels = hasAlpha ? 4 : 3;\r\n        const format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\r\n        const data = new Uint8Array(height * width * numChannels);\r\n        this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\r\n        return data;\r\n    }\r\n\r\n    // Statics\r\n\r\n    private static _IsSupported: Nullable<boolean> = null;\r\n    private static _HasMajorPerformanceCaveat : Nullable<boolean> = null;\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n     */\r\n    public static get IsSupported(): boolean {\r\n        return this.isSupported(); // Backward compat\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n     * @returns true if the engine can be created\r\n     * @ignorenaming\r\n     */\r\n    public static isSupported(): boolean {\r\n        if (this._HasMajorPerformanceCaveat !== null) {\r\n            return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\r\n        }\r\n\r\n        if (this._IsSupported === null) {\r\n            try {\r\n                var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\r\n                var gl = tempcanvas.getContext(\"webgl\") || (tempcanvas as any).getContext(\"experimental-webgl\");\r\n\r\n                this._IsSupported = gl != null && !!window.WebGLRenderingContext;\r\n            } catch (e) {\r\n                this._IsSupported = false;\r\n            }\r\n        }\r\n\r\n        return this._IsSupported;\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\r\n     */\r\n    public static get HasMajorPerformanceCaveat(): boolean {\r\n        if (this._HasMajorPerformanceCaveat === null) {\r\n            try {\r\n                var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\r\n                var gl = tempcanvas.getContext(\"webgl\", { failIfMajorPerformanceCaveat: true }) || (tempcanvas as any).getContext(\"experimental-webgl\", { failIfMajorPerformanceCaveat: true });\r\n\r\n                this._HasMajorPerformanceCaveat = !gl;\r\n            } catch (e) {\r\n                this._HasMajorPerformanceCaveat = false;\r\n            }\r\n        }\r\n\r\n        return this._HasMajorPerformanceCaveat;\r\n    }\r\n\r\n    /**\r\n     * Find the next highest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next highest power of two.\r\n     */\r\n    public static CeilingPOT(x: number): number {\r\n        x--;\r\n        x |= x >> 1;\r\n        x |= x >> 2;\r\n        x |= x >> 4;\r\n        x |= x >> 8;\r\n        x |= x >> 16;\r\n        x++;\r\n        return x;\r\n    }\r\n\r\n    /**\r\n     * Find the next lowest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next lowest power of two.\r\n     */\r\n    public static FloorPOT(x: number): number {\r\n        x = x | (x >> 1);\r\n        x = x | (x >> 2);\r\n        x = x | (x >> 4);\r\n        x = x | (x >> 8);\r\n        x = x | (x >> 16);\r\n        return x - (x >> 1);\r\n    }\r\n\r\n    /**\r\n     * Find the nearest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next nearest power of two.\r\n     */\r\n    public static NearestPOT(x: number): number {\r\n        var c = ThinEngine.CeilingPOT(x);\r\n        var f = ThinEngine.FloorPOT(x);\r\n        return (c - x) > (x - f) ? f : c;\r\n    }\r\n\r\n    /**\r\n     * Get the closest exponent of two\r\n     * @param value defines the value to approximate\r\n     * @param max defines the maximum value to return\r\n     * @param mode defines how to define the closest value\r\n     * @returns closest exponent of two of the given value\r\n     */\r\n    public static GetExponentOfTwo(value: number, max: number, mode = 2): number {\r\n        let pot;\r\n\r\n        switch (mode) {\r\n            case 1:\r\n                pot = ThinEngine.FloorPOT(value);\r\n                break;\r\n            case 2:\r\n                pot = ThinEngine.NearestPOT(value);\r\n                break;\r\n            case 3:\r\n            default:\r\n                pot = ThinEngine.CeilingPOT(value);\r\n                break;\r\n        }\r\n\r\n        return Math.min(pot, max);\r\n    }\r\n\r\n    /**\r\n     * Queue a new function into the requested animation frame pool (ie. this function will be executed byt the browser for the next frame)\r\n     * @param func - the function to be called\r\n     * @param requester - the object that will request the next frame. Falls back to window.\r\n     * @returns frame number\r\n     */\r\n    public static QueueNewFrame(func: () => void, requester?: any): number {\r\n        if (!DomManagement.IsWindowObjectExist()) {\r\n            if (typeof requestAnimationFrame !== \"undefined\") {\r\n                return requestAnimationFrame(func);\r\n            }\r\n\r\n            return setTimeout(func, 16);\r\n        }\r\n\r\n        if (!requester) {\r\n            requester = window;\r\n        }\r\n\r\n        if (requester.requestPostAnimationFrame) {\r\n            return requester.requestPostAnimationFrame(func);\r\n        }\r\n        else if (requester.requestAnimationFrame) {\r\n            return requester.requestAnimationFrame(func);\r\n        }\r\n        else if (requester.msRequestAnimationFrame) {\r\n            return requester.msRequestAnimationFrame(func);\r\n        }\r\n        else if (requester.webkitRequestAnimationFrame) {\r\n            return requester.webkitRequestAnimationFrame(func);\r\n        }\r\n        else if (requester.mozRequestAnimationFrame) {\r\n            return requester.mozRequestAnimationFrame(func);\r\n        }\r\n        else if (requester.oRequestAnimationFrame) {\r\n            return requester.oRequestAnimationFrame(func);\r\n        }\r\n        else {\r\n            return window.setTimeout(func, 16);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets host document\r\n     * @returns the host document object\r\n     */\r\n    public getHostDocument(): Nullable<Document> {\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\r\n            return this._renderingCanvas.ownerDocument;\r\n        }\r\n\r\n        return document;\r\n    }\r\n}\r\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}